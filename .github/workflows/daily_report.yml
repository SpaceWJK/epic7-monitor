name: Epic Seven Daily Report (Optimized)

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST (UTC 0ì‹œ)
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      force_report:
        description: 'Force generate report even if no posts'
        required: false
        default: 'false'
        type: boolean

jobs:
  daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    env:
      TZ: Asia/Seoul
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: ğŸŒ Install Chrome (Simplified)
        run: |
          echo "=== Chrome ì„¤ì¹˜ ì‹œì‘ ==="
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          echo "Chrome ë²„ì „: $(google-chrome --version)"
          echo "Chrome ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ“¦ Install Python dependencies
        run: |
          echo "=== Python ì˜ì¡´ì„± ì„¤ì¹˜ ==="
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ” Generate daily report
        run: |
          echo "=== ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘ ==="
          echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ê°•ì œ ì‹¤í–‰ ëª¨ë“œ: ${{ github.event.inputs.force_report }}"
          
          if [ "${{ github.event.inputs.force_report }}" = "true" ]; then
            echo "ğŸ”„ ê°•ì œ ë¦¬í¬íŠ¸ ìƒì„± ëª¨ë“œ"
            python generate_report.py --force
          else
            python generate_report.py
          fi
          
          echo "ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: $(date '+%Y-%m-%d %H:%M:%S KST')"
        env:
          DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}

      - name: ğŸ“Š Upload report artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_number }}
          path: |
            *_debug_*.html
            *.json
            *.log
          retention-days: 7

      - name: ğŸ—‚ï¸ Archive and cleanup
        run: |
          echo "=== íŒŒì¼ ì •ë¦¬ ë° ë³´ê´€ ==="
          
          # ì €ì¥ëœ ë§í¬ ìˆ˜ í™•ì¸
          if [[ -f crawled_links.json ]]; then
            LINK_COUNT=$(jq length crawled_links.json 2>/dev/null || echo "0")
            echo "ğŸ“Š í˜„ì¬ ì €ì¥ëœ ë§í¬ ìˆ˜: $LINK_COUNT"
            
            # 1000ê°œ ì´ìƒì´ë©´ ìµœì‹  800ê°œë§Œ ìœ ì§€
            if [[ $LINK_COUNT -gt 1000 ]]; then
              echo "ğŸ”„ ë§í¬ ê°œìˆ˜ ìµœì í™”: $LINK_COUNT â†’ 800ê°œ"
              jq '.links |= .[-800:]' crawled_links.json > temp.json && mv temp.json crawled_links.json
              echo "ë§í¬ ì •ë¦¬ ì™„ë£Œ"
            fi
          fi
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
          echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
          free -h

      - name: ğŸ“ˆ Daily report summary
        run: |
          echo "=== ì¼ì¼ ë¦¬í¬íŠ¸ ì‹¤í–‰ ìš”ì•½ ==="
          echo "ğŸ“… ìƒì„± ë‚ ì§œ: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ”„ ì›Œí¬í”Œë¡œìš° ID: ${{ github.run_number }}"
          echo "ğŸ“¬ Discord ì›¹í›…: ${{ secrets.DISCORD_WEBHOOK_REPORT && 'ì„¤ì •ë¨' || 'ë¯¸ì„¤ì •' }}"
          
          # ë””ë²„ê·¸ íŒŒì¼ í™•ì¸
          DEBUG_FILES=$(find . -name "*_debug_*.html" -type f | wc -l)
          echo "ğŸ” ìƒì„±ëœ ë””ë²„ê·¸ íŒŒì¼: ${DEBUG_FILES}ê°œ"
          
          # ê²°ê³¼ íŒŒì¼ í™•ì¸
          if [[ -f crawled_links.json ]]; then
            FINAL_LINK_COUNT=$(jq length crawled_links.json 2>/dev/null || echo "0")
            echo "ğŸ“Š ìµœì¢… ì €ì¥ëœ ë§í¬ ìˆ˜: $FINAL_LINK_COUNT"
          fi

      - name: ğŸ’¾ Commit changes
        run: |
          echo "=== Git ë³€ê²½ì‚¬í•­ ì²˜ë¦¬ ==="
          
          git config --local user.email "epic7-report@github.com"
          git config --local user.name "Epic7 Report Bot"
          
          # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
          git add -A
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
          else
            echo "ë³€ê²½ ì‚¬í•­ ë°œê²¬, ì»¤ë°‹ ì§„í–‰"
            git status --porcelain
            
            # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
            COMMIT_MSG="ğŸ“Š ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± - $(date '+%Y-%m-%d %H:%M KST')"
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "Git ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ"
          fi

      - name: ğŸ”” Report completion status
        if: always()
        run: |
          echo "=== ìµœì¢… ì‹¤í–‰ ìƒíƒœ ==="
          echo "ì‘ì—… ìƒíƒœ: ${{ job.status }}"
          echo "ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì„±ê³µ"
          else
            echo "âŒ ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨"
            echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”."
          fi