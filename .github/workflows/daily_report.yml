name: ðŸ“Š Epic7 Daily Report (Optimized v3.2)

on:
  schedule:
    - cron: "0 9 * * *"  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ðŸ” Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      report_period:
        description: 'ðŸ“… Report period in hours'
        required: false
        default: '24'
        type: choice
        options:
          - '12'
          - '24'
          - '48'
      force_regenerate:
        description: 'ðŸ”„ Force regenerate all data'
        required: false
        default: 'false'
        type: boolean

env:
  TZ: Asia/Seoul
  PYTHONUNBUFFERED: 1
  DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
  DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
  REPORT_PERIOD: ${{ github.event.inputs.report_period || '24' }}
  FORCE_REGENERATE: ${{ github.event.inputs.force_regenerate || 'false' }}

jobs:
  daily-report-optimized:
    name: ðŸ“ˆ Generate Daily Report (Optimized v3.2)
    runs-on: ubuntu-latest
    timeout-minutes: 15  # ê¸°ì¡´ 30ë¶„ â†’ 15ë¶„ìœ¼ë¡œ ë‹¨ì¶•
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python Environment (Optimized)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸŒ Install Chrome and ChromeDriver (Chrome 138 í˜¸í™˜)
        run: |
          echo "=== Chrome ë° ChromeDriver ì„¤ì¹˜ (Chrome 138 í˜¸í™˜) ==="
          
          # Chrome ì„¤ì¹˜
          sudo apt-get update -y
          sudo apt-get install -y google-chrome-stable
          
          # Chrome ë²„ì „ í™•ì¸
          CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
          CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
          echo "âœ… Chrome ë²„ì „: $CHROME_VERSION (Major: $CHROME_MAJOR_VERSION)"
          
          # ChromeDriver ì„¤ì¹˜ (3ë‹¨ê³„ í´ë°± ë°©ì‹)
          echo "=== ChromeDriver ì„¤ì¹˜ ì‹œìž‘ ==="
          INSTALL_SUCCESS=false
          
          # ë°©ë²• 1: Chrome for Testing API ì‚¬ìš© (ê¶Œìž¥)
          echo "ðŸ”„ ë°©ë²• 1: Chrome for Testing API ì‚¬ìš©"
          if curl -s "https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json" | grep -q "chromedriver"; then
            # ìµœì‹  stable ë²„ì „ URL íšë“
            CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json" | \
              python3 -c "import sys, json; data=json.load(sys.stdin); print(data['channels']['Stable']['downloads']['chromedriver'][0]['url'])" 2>/dev/null || echo "")
            
            if [ -n "$CHROMEDRIVER_URL" ] && [ "$CHROMEDRIVER_URL" != "null" ]; then
              echo "ðŸ”— ChromeDriver URL: $CHROMEDRIVER_URL"
              wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL"
              
              if [ -f "/tmp/chromedriver.zip" ] && [ -s "/tmp/chromedriver.zip" ]; then
                sudo unzip -o /tmp/chromedriver.zip -d /tmp/
                sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver 2>/dev/null || \
                sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
                sudo chmod +x /usr/local/bin/chromedriver
                
                if chromedriver --version >/dev/null 2>&1; then
                  echo "âœ… ë°©ë²• 1 ì„±ê³µ: ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"
                  INSTALL_SUCCESS=true
                fi
              fi
            fi
          fi
          
          # ë°©ë²• 2: ì§ì ‘ ë‹¤ìš´ë¡œë“œ (GitHub Release)
          if [ "$INSTALL_SUCCESS" != "true" ]; then
            echo "ðŸ”„ ë°©ë²• 2: GitHub Release ì§ì ‘ ë‹¤ìš´ë¡œë“œ"
            
            # Chrome ë²„ì „ì— ë§žëŠ” ChromeDriver ë²„ì „ ì°¾ê¸°
            case $CHROME_MAJOR_VERSION in
              "138"|"139"|"140")
                CHROMEDRIVER_VERSION="138.0.6993.88"
                ;;
              "137")
                CHROMEDRIVER_VERSION="137.0.6916.107"
                ;;
              "136")
                CHROMEDRIVER_VERSION="136.0.6877.63"
                ;;
              *)
                CHROMEDRIVER_VERSION="138.0.6993.88"  # ê¸°ë³¸ê°’
                ;;
            esac
            
            echo "ðŸŽ¯ ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
            
            # ì—¬ëŸ¬ ë‹¤ìš´ë¡œë“œ URL ì‹œë„
            DOWNLOAD_URLS=(
              "https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
              "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
              "https://github.com/GoogleChromeLabs/chrome-for-testing/releases/download/$CHROMEDRIVER_VERSION/chromedriver-linux64.zip"
            )
            
            for url in "${DOWNLOAD_URLS[@]}"; do
              echo "ðŸ”— ì‹œë„: $url"
              if wget -q -O /tmp/chromedriver.zip "$url"; then
                if [ -f "/tmp/chromedriver.zip" ] && [ -s "/tmp/chromedriver.zip" ]; then
                  sudo unzip -o /tmp/chromedriver.zip -d /tmp/
                  sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver 2>/dev/null || \
                  sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
                  sudo chmod +x /usr/local/bin/chromedriver
                  
                  if chromedriver --version >/dev/null 2>&1; then
                    echo "âœ… ë°©ë²• 2 ì„±ê³µ: ChromeDriver ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
                    INSTALL_SUCCESS=true
                    break
                  fi
                fi
              fi
            done
          fi
          
          # ë°©ë²• 3: íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš© (ìµœí›„ ìˆ˜ë‹¨)
          if [ "$INSTALL_SUCCESS" != "true" ]; then
            echo "ðŸ”„ ë°©ë²• 3: íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš©"
            
            # apt íŒ¨í‚¤ì§€ ì‹œë„
            sudo apt-get update -y
            sudo apt-get install -y chromium-chromedriver 2>/dev/null || true
            
            if [ -f "/usr/bin/chromedriver" ]; then
              sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
              sudo chmod +x /usr/local/bin/chromedriver
              
              if chromedriver --version >/dev/null 2>&1; then
                echo "âœ… ë°©ë²• 3 ì„±ê³µ: APT ChromeDriver ì„¤ì¹˜"
                INSTALL_SUCCESS=true
              fi
            fi
          fi
          
          # ì„¤ì¹˜ ê²°ê³¼ í™•ì¸
          if [ "$INSTALL_SUCCESS" = "true" ]; then
            echo "ðŸŽ‰ ChromeDriver ì„¤ì¹˜ ì™„ë£Œ!"
            echo "ðŸ“‹ Chrome ë²„ì „: $(google-chrome --version)"
            echo "ðŸ“‹ ChromeDriver ë²„ì „: $(chromedriver --version)"
            echo "ðŸ“‹ ChromeDriver ê²½ë¡œ: $(which chromedriver)"
          else
            echo "âŒ ChromeDriver ì„¤ì¹˜ ì‹¤íŒ¨"
            echo "ðŸ” ì‹œìŠ¤í…œ ì •ë³´:"
            echo "   - Chrome: $(google-chrome --version)"
            echo "   - ì‹œìŠ¤í…œ: $(uname -a)"
            echo "   - ì•„í‚¤í…ì²˜: $(dpkg --print-architecture)"
            exit 1
          fi
          
          # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/chromedriver.zip
          rm -rf /tmp/chromedriver-linux64/
          
          echo "âœ… Chrome ë° ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"

      - name: ðŸ“¦ Install Python Dependencies
        run: |
          echo "=== Python ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œìž‘ ==="
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found, installing basic dependencies"
            pip install requests beautifulsoup4 selenium lxml deep-translator python-dateutil
          fi
          echo "âœ… Python dependencies installed"

      - name: ðŸ“Š Generate Daily Report via Integrated System
        run: |
          echo "=== í†µí•© ì‹œìŠ¤í…œì„ í†µí•œ ì¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ==="
          echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ì‹¤í–‰ ëª…ë ¹ì–´: python monitor_bugs.py --schedule 24h"
          
          # âœ¨ í•µì‹¬ ë³€ê²½: í†µí•© ì‹œìŠ¤í…œ í™œìš©
          echo "ì‹œìž‘" && python monitor_bugs.py --schedule 24h
          echo "ì™„ë£Œ"
          
          echo "âœ… í†µí•© ì‹œìŠ¤í…œì„ í†µí•œ ì¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"

      - name: ðŸ“¤ Upload Report Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_id }}
          path: |
            daily_report.md
            *.json
            *.html
            *.log
          retention-days: 7
          compression-level: 6

      - name: ðŸ“¬ Send Discord Report Notification
        if: always()
        run: |
          if [[ -n "$DISCORD_WEBHOOK_REPORT" ]]; then
            echo "ðŸ“¬ Sending Discord notification..."
            
            # ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ ê²°ì •
            STATUS_COLOR=$([ "${{ job.status }}" = "success" ] && echo "3066993" || echo "15158332")
            STATUS_EMOJI=$([ "${{ job.status }}" = "success" ] && echo "âœ…" || echo "âŒ")
            
            # ë¦¬í¬íŠ¸ íŒŒì¼ í¬ê¸° í™•ì¸
            REPORT_SIZE=$([ -f "daily_report.md" ] && du -h daily_report.md | cut -f1 || echo "N/A")
            
            # Discord ë©”ì‹œì§€ ìƒì„±
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"embeds\": [{
                     \"title\": \"$STATUS_EMOJI Epic7 Daily Report v3.2\",
                     \"description\": \"í†µí•© ì‹œìŠ¤í…œì„ í†µí•œ ì¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± $([ "${{ job.status }}" = "success" ] && echo "ì™„ë£Œ" || echo "ì‹¤íŒ¨")\",
                     \"color\": $STATUS_COLOR,
                     \"fields\": [
                       {
                         \"name\": \"ðŸ“… ë¦¬í¬íŠ¸ ê¸°ê°„\",
                         \"value\": \"$REPORT_PERIOD ì‹œê°„\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ðŸ”§ ë””ë²„ê·¸ ëª¨ë“œ\",
                         \"value\": \"$DEBUG_MODE\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ðŸ“„ ë¦¬í¬íŠ¸ í¬ê¸°\",
                         \"value\": \"$REPORT_SIZE\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ðŸ–¥ï¸ ì‹œìŠ¤í…œ ì •ë³´\",
                         \"value\": \"ë©”ëª¨ë¦¬: $(free -h | grep Mem | awk '{print $3}') / ë””ìŠ¤í¬: $(df -h . | tail -1 | awk '{print $5}')\",
                         \"inline\": false
                       },
                       {
                         \"name\": \"â° ì‹¤í–‰ ì‹œê°„\",
                         \"value\": \"$(date '+%Y-%m-%d %H:%M:%S %Z')\",
                         \"inline\": false
                       },
                       {
                         \"name\": \"ðŸŽ¯ ì‹¤í–‰ ë°©ì‹\",
                         \"value\": \"í†µí•© ì‹œìŠ¤í…œ (monitor_bugs.py --schedule 24h)\",
                         \"inline\": false
                       }
                     ],
                     \"footer\": {
                       \"text\": \"Epic7 Daily Report v3.2 (Integrated System)\"
                     }
                   }]
                 }" \
                 "$DISCORD_WEBHOOK_REPORT"
            
            echo "âœ… Discord notification sent successfully"
          else
            echo "âš ï¸ Discord webhook not configured"
          fi

      - name: ðŸ“„ Commit Report Changes
        if: success()
        run: |
          echo "ðŸ“„ Committing report changes..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Daily Report v3.2"
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if [[ -n $(git status --porcelain) ]]; then
            echo "ðŸ“ Changes detected, committing..."
            git add daily_report.md *.json *.html *.log 2>/dev/null || true
            git commit -m "ðŸ“Š Daily Report v3.2: $(date '+%Y-%m-%d %H:%M:%S') [í†µí•© ì‹œìŠ¤í…œ]" || true
            git push || echo "âš ï¸ Push failed - continuing..."
            echo "âœ… Report committed successfully"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary files..."
          
          # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/daily_report_* 2>/dev/null || true
          rm -f /tmp/report_data_* 2>/dev/null || true
          rm -f /tmp/chromedriver.zip 2>/dev/null || true
          rm -rf /tmp/chromedriver-linux64/ 2>/dev/null || true
          
          echo "âœ… Cleanup completed"