name: Epic7 Daily Report

on:
  schedule:
    - cron: "0 9 * * *"  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      report_period:
        description: 'Report period in hours'
        required: false
        default: '24'
        type: choice
        options:
          - '12'
          - '24'
          - '48'

jobs:
  daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
      REPORT_PERIOD: ${{ github.event.inputs.report_period || '24' }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸŒ Install Chrome and ChromeDriver (Chrome 138 í˜¸í™˜)
        run: |
          echo "=== Chrome ë° ChromeDriver ì„¤ì¹˜ (Chrome 138 í˜¸í™˜) ==="
          
          # Chrome ì„¤ì¹˜
          sudo apt-get update -y
          sudo apt-get install -y google-chrome-stable
          
          # Chrome ë²„ì „ í™•ì¸
          CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
          CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
          echo "âœ… Chrome ë²„ì „: $CHROME_VERSION (Major: $CHROME_MAJOR_VERSION)"
          
          # ChromeDriver ì„¤ì¹˜ (3ë‹¨ê³„ í´ë°± ë°©ì‹)
          echo "=== ChromeDriver ì„¤ì¹˜ ì‹œì‘ ==="
          INSTALL_SUCCESS=false
          
          # ë°©ë²• 1: Chrome for Testing API ì‚¬ìš© (ê¶Œì¥)
          echo "ğŸ”„ ë°©ë²• 1: Chrome for Testing API ì‚¬ìš©"
          if curl -s "https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json" | grep -q "chromedriver"; then
            # ìµœì‹  stable ë²„ì „ URL íšë“
            CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json" | \
              python3 -c "import sys, json; data=json.load(sys.stdin); print(data['channels']['Stable']['downloads']['chromedriver'][0]['url'])" 2>/dev/null || echo "")
            
            if [ -n "$CHROMEDRIVER_URL" ] && [ "$CHROMEDRIVER_URL" != "null" ]; then
              echo "ğŸ”— ChromeDriver URL: $CHROMEDRIVER_URL"
              wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL"
              
              if [ -f "/tmp/chromedriver.zip" ] && [ -s "/tmp/chromedriver.zip" ]; then
                sudo unzip -o /tmp/chromedriver.zip -d /tmp/
                sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver 2>/dev/null || \
                sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
                sudo chmod +x /usr/local/bin/chromedriver
                
                if chromedriver --version >/dev/null 2>&1; then
                  echo "âœ… ë°©ë²• 1 ì„±ê³µ: ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"
                  INSTALL_SUCCESS=true
                fi
              fi
            fi
          fi
          
          # ë°©ë²• 2: ì§ì ‘ ë‹¤ìš´ë¡œë“œ (GitHub Release)
          if [ "$INSTALL_SUCCESS" != "true" ]; then
            echo "ğŸ”„ ë°©ë²• 2: GitHub Release ì§ì ‘ ë‹¤ìš´ë¡œë“œ"
            
            # Chrome ë²„ì „ì— ë§ëŠ” ChromeDriver ë²„ì „ ì°¾ê¸°
            case $CHROME_MAJOR_VERSION in
              "138"|"139"|"140")
                CHROMEDRIVER_VERSION="138.0.6993.88"
                ;;
              "137")
                CHROMEDRIVER_VERSION="137.0.6916.107"
                ;;
              "136")
                CHROMEDRIVER_VERSION="136.0.6877.63"
                ;;
              *)
                CHROMEDRIVER_VERSION="138.0.6993.88"  # ê¸°ë³¸ê°’
                ;;
            esac
            
            echo "ğŸ¯ ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
            
            # ì—¬ëŸ¬ ë‹¤ìš´ë¡œë“œ URL ì‹œë„
            DOWNLOAD_URLS=(
              "https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
              "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
              "https://github.com/GoogleChromeLabs/chrome-for-testing/releases/download/$CHROMEDRIVER_VERSION/chromedriver-linux64.zip"
            )
            
            for url in "${DOWNLOAD_URLS[@]}"; do
              echo "ğŸ”— ì‹œë„: $url"
              if wget -q -O /tmp/chromedriver.zip "$url"; then
                if [ -f "/tmp/chromedriver.zip" ] && [ -s "/tmp/chromedriver.zip" ]; then
                  sudo unzip -o /tmp/chromedriver.zip -d /tmp/
                  sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver 2>/dev/null || \
                  sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
                  sudo chmod +x /usr/local/bin/chromedriver
                  
                  if chromedriver --version >/dev/null 2>&1; then
                    echo "âœ… ë°©ë²• 2 ì„±ê³µ: ChromeDriver ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
                    INSTALL_SUCCESS=true
                    break
                  fi
                fi
              fi
            done
          fi
          
          # ë°©ë²• 3: íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš© (ìµœí›„ ìˆ˜ë‹¨)
          if [ "$INSTALL_SUCCESS" != "true" ]; then
            echo "ğŸ”„ ë°©ë²• 3: íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš©"
            
            # apt íŒ¨í‚¤ì§€ ì‹œë„
            sudo apt-get update -y
            sudo apt-get install -y chromium-chromedriver 2>/dev/null || true
            
            if [ -f "/usr/bin/chromedriver" ]; then
              sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
              sudo chmod +x /usr/local/bin/chromedriver
              
              if chromedriver --version >/dev/null 2>&1; then
                echo "âœ… ë°©ë²• 3 ì„±ê³µ: APT ChromeDriver ì„¤ì¹˜"
                INSTALL_SUCCESS=true
              fi
            fi
          fi
          
          # ì„¤ì¹˜ ê²°ê³¼ í™•ì¸
          if [ "$INSTALL_SUCCESS" = "true" ]; then
            echo "ğŸ‰ ChromeDriver ì„¤ì¹˜ ì™„ë£Œ!"
            echo "ğŸ“‹ Chrome ë²„ì „: $(google-chrome --version)"
            echo "ğŸ“‹ ChromeDriver ë²„ì „: $(chromedriver --version)"
            echo "ğŸ“‹ ChromeDriver ê²½ë¡œ: $(which chromedriver)"
          else
            echo "âŒ ChromeDriver ì„¤ì¹˜ ì‹¤íŒ¨"
            echo "ğŸ” ì‹œìŠ¤í…œ ì •ë³´:"
            echo "   - Chrome: $(google-chrome --version)"
            echo "   - ì‹œìŠ¤í…œ: $(uname -a)"
            echo "   - ì•„í‚¤í…ì²˜: $(dpkg --print-architecture)"
            exit 1
          fi
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/chromedriver.zip
          rm -rf /tmp/chromedriver-linux64/
          
          echo "âœ… Chrome ë° ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "=== Python ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘ ==="
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found, installing basic dependencies"
            pip install requests beautifulsoup4 selenium lxml deep-translator python-dateutil
          fi
          echo "âœ… Python dependencies installed"

      - name: ğŸ“Š Generate daily report
        run: |
          echo "=== ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘ ==="
          echo "ë¦¬í¬íŠ¸ ê¸°ê°„: $REPORT_PERIOD ì‹œê°„"
          echo "ìƒì„± ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ë¦¬í¬íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if [ -f "generate_report.py" ]; then
            python generate_report.py --period $REPORT_PERIOD --debug $DEBUG_MODE
          else
            echo "âš ï¸ generate_report.py íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
            
            # ê¸°ë³¸ ë¦¬í¬íŠ¸ ìƒì„±
            cat > daily_report.md << EOF
            # Epic7 ì¼ì¼ ë¦¬í¬íŠ¸
            
            **ìƒì„± ì‹œê°„:** $(date '+%Y-%m-%d %H:%M:%S')
            **ë¦¬í¬íŠ¸ ê¸°ê°„:** $REPORT_PERIOD ì‹œê°„
            
            ## ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ
            - ì‹œìŠ¤í…œ ìƒíƒœ: ì •ìƒ ì‘ë™
            - ë§ˆì§€ë§‰ í¬ë¡¤ë§: $(date '+%Y-%m-%d %H:%M:%S')
            
            ## ğŸ“ ë°ì´í„° íŒŒì¼ ìƒíƒœ
            EOF
            
            # JSON íŒŒì¼ ì •ë³´ ì¶”ê°€
            for file in crawled_links*.json; do
              if [ -f "$file" ]; then
                echo "- $file: âœ… ì¡´ì¬ (í¬ê¸°: $(stat -c%s "$file") bytes)" >> daily_report.md
              fi
            done
            
            echo "" >> daily_report.md
            echo "## ğŸ¯ ìš”ì•½" >> daily_report.md
            echo "ì¼ì¼ ë¦¬í¬íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." >> daily_report.md
          fi
          
          echo "âœ… ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"

      - name: ğŸ“¤ Upload daily report
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_number }}
          path: |
            daily_report.md
            *.json
            *.log
          retention-days: 7

      - name: ğŸ“¢ Send Discord daily report
        if: always()
        run: |
          echo "ğŸ“¡ Discord ì¼ì¼ ë¦¬í¬íŠ¸ ì „ì†¡"
          
          # ì‹¤í–‰ ìƒíƒœ í™•ì¸
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="ğŸ“Š"
            STATUS_TEXT="ì„±ê³µ"
            STATUS_COLOR="3066993"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="ì‹¤íŒ¨"
            STATUS_COLOR="15158332"
          fi
          
          # JSON íŒŒì¼ ê°œìˆ˜ í™•ì¸
          JSON_COUNT=$(find . -name "crawled_links*.json" | wc -l)
          
          # Discord ë©”ì‹œì§€ ìƒì„±
          DISCORD_MESSAGE=$(cat << EOF
          {
            "embeds": [
              {
                "title": "${STATUS_EMOJI} Epic7 ì¼ì¼ ë¦¬í¬íŠ¸",
                "description": "${REPORT_PERIOD}ì‹œê°„ ë™ì•ˆì˜ ëª¨ë‹ˆí„°ë§ ê²°ê³¼ì…ë‹ˆë‹¤.",
                "color": ${STATUS_COLOR},
                "fields": [
                  {
                    "name": "ğŸ“… ë¦¬í¬íŠ¸ ê¸°ê°„",
                    "value": "${REPORT_PERIOD}ì‹œê°„",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“Š ìƒì„± ì‹œê°„",
                    "value": "$(date '+%Y-%m-%d %H:%M:%S')",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“ ë°ì´í„° íŒŒì¼",
                    "value": "${JSON_COUNT}ê°œì˜ JSON íŒŒì¼",
                    "inline": true
                  },
                  {
                    "name": "ğŸ–¥ï¸ ì‹œìŠ¤í…œ ìƒíƒœ",
                    "value": "ì •ìƒ ì‘ë™",
                    "inline": true
                  },
                  {
                    "name": "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰",
                    "value": "$(free -h | grep Mem | awk '{print $3 "/" $2}')",
                    "inline": true
                  },
                  {
                    "name": "ğŸ”§ Chrome ë²„ì „",
                    "value": "$(google-chrome --version 2>/dev/null | cut -d' ' -f3 || echo 'N/A')",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "Epic7 ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - ì¼ì¼ ë¦¬í¬íŠ¸"
                },
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
              }
            ]
          }
          EOF
          )
          
          # Discord Webhook ì „ì†¡
          if [ ! -z "$DISCORD_WEBHOOK_REPORT" ]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "$DISCORD_MESSAGE" \
                 "$DISCORD_WEBHOOK_REPORT" || echo "Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
          else
            echo "DISCORD_WEBHOOK_REPORT í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
          fi

      - name: ğŸ”„ Cleanup
        if: always()
        run: |
          echo "=== ì •ë¦¬ ì‘ì—… ì‹œì‘ ==="
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/chromedriver.zip
          rm -rf /tmp/chromedriver-linux64/
          
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"
          echo "=========================================="
          echo "   Epic7 ì¼ì¼ ë¦¬í¬íŠ¸ ì™„ë£Œ"
          echo "=========================================="
          echo "ğŸ“Š ë¦¬í¬íŠ¸ ê¸°ê°„: $REPORT_PERIOD ì‹œê°„"
          echo "â° ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "âœ… ì¼ì¼ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "=========================================="