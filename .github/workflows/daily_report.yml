name: Epic Seven Daily Report

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST (UTC 0ì‹œ)
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      force_report:
        description: 'Force generate report'
        required: false
        default: 'false'
        type: boolean
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      crawl_mode:
        description: 'Crawling mode (korean/global/all)'
        required: false
        default: 'all'
        type: choice
        options:
          - korean
          - global
          - all

jobs:
  daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
      DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
      DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
      CRAWL_MODE: ${{ github.event.inputs.crawl_mode || 'all' }}
      FORCE_REPORT: ${{ github.event.inputs.force_report || 'false' }}
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸŒ Install Chrome and ChromeDriver (Chrome for Testing ê¸°ë°˜)
      run: |
        echo "=== Chromeê³¼ ChromeDriver ì„¤ì¹˜ ì‹œì‘ ==="
        
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          fonts-liberation \
          libasound2 \
          libatk-bridge2.0-0 \
          libatspi2.0-0 \
          libcups2 \
          libdrm-dev \
          libgbm-dev \
          libglib2.0-0 \
          libnspr4 \
          libnss3 \
          libxcomposite1 \
          libxdamage1 \
          libxext6 \
          libxfixes3 \
          libxkbcommon0 \
          libxrandr2 \
          libxshmfence6 \
          libxtst6 \
          xdg-utils \
          wget

        INSTALL_SUCCESS=false

        echo "ğŸ“‹ ë°©ë²• 1: Chrome for Testing API ì‚¬ìš© (ê¶Œì¥)"
        if chrome_version_output=$(google-chrome --version 2>&1); then
          CURRENT_CHROME_MAJOR_VERSION=$(echo "$chrome_version_output" | sed -E 's/Google Chrome ([0-9]+)\..*/\1/')
          echo "í˜„ì¬ ì„¤ì¹˜ëœ Chrome Major Version: $CURRENT_CHROME_MAJOR_VERSION"
        else
          CURRENT_CHROME_MAJOR_VERSION=""
          echo "Chromeì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ ë²„ì „ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìµœì‹  ë²„ì „ì„ ì‹œë„í•©ë‹ˆë‹¤."
        fi

        if [ -n "$CURRENT_CHROME_MAJOR_VERSION" ]; then
          LATEST_DRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
            python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['version'])" | \
            awk -F'.' '{print $1}')
          
          if [ -n "$LATEST_DRIVER_VERSION" ]; then
            CHROME_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
              python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['downloads']['chrome-linux'][0]['url'])")
            
            CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
              python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['downloads']['chromedriver-linux64'][0]['url'])")
            
            if [ -n "$CHROME_URL" ] && [ -n "$CHROMEDRIVER_URL" ]; then
              echo "Chrome ë‹¤ìš´ë¡œë“œ: $CHROME_URL"
              echo "ChromeDriver ë‹¤ìš´ë¡œë“œ: $CHROMEDRIVER_URL"

              wget -q "$CHROME_URL" -O /tmp/chrome-linux.zip
              sudo unzip -qq /tmp/chrome-linux.zip -d /opt/
              sudo ln -sf /opt/chrome-linux/chrome /usr/local/bin/google-chrome
              sudo chmod +x /usr/local/bin/google-chrome
              
              wget -q "$CHROMEDRIVER_URL" -O /tmp/chromedriver.zip
              sudo unzip -qq /tmp/chromedriver.zip -d /usr/local/bin/
              sudo mv /usr/local/bin/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
              sudo chmod +x /usr/local/bin/chromedriver

              if google-chrome --version >/dev/null 2>&1 && chromedriver --version >/dev/null 2>&1; then
                echo "âœ… ë°©ë²• 1 ì„±ê³µ: Chrome for Testing APIë¥¼ í†µí•œ ì„¤ì¹˜"
                INSTALL_SUCCESS=true
              else
                echo "âŒ ë°©ë²• 1 ì‹¤íŒ¨: ì„¤ì¹˜ëŠ” ë˜ì—ˆìœ¼ë‚˜ ë²„ì „ í™•ì¸ ì‹¤íŒ¨"
              fi
            else
              echo "âŒ ë°©ë²• 1 ì‹¤íŒ¨: Chrome ë˜ëŠ” ChromeDriver URLì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            fi
          else
            echo "âŒ ë°©ë²• 1 ì‹¤íŒ¨: ìµœì‹  Chrome Major Versionì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          fi
        else
          echo "í˜„ì¬ Chrome ë²„ì „ í™•ì¸ ë¶ˆê°€. ê°•ì œ ì„¤ì¹˜ ì‹œë„."
          CHROME_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
              python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['downloads']['chrome-linux'][0]['url'])")
          
          CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
            python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['downloads']['chromedriver-linux64'][0]['url'])")

          if [ -n "$CHROME_URL" ] && [ -n "$CHROMEDRIVER_URL" ]; then
            echo "Chrome ë‹¤ìš´ë¡œë“œ: $CHROME_URL"
            echo "ChromeDriver ë‹¤ìš´ë¡œë“œ: $CHROMEDRIVER_URL"

            wget -q "$CHROME_URL" -O /tmp/chrome-linux.zip
            sudo unzip -qq /tmp/chrome-linux.zip -d /opt/
            sudo ln -sf /opt/chrome-linux/chrome /usr/local/bin/google-chrome
            sudo chmod +x /usr/local/bin/google-chrome
            
            wget -q "$CHROMEDRIVER_URL" -O /tmp/chromedriver.zip
            sudo unzip -qq /tmp/chromedriver.zip -d /usr/local/bin/
            sudo mv /usr/local/bin/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
            sudo chmod +x /usr/local/bin/chromedriver

            if google-chrome --version >/dev/null 2>&1 && chromedriver --version >/dev/null 2>&1; then
              echo "âœ… ë°©ë²• 1 ì„±ê³µ: Chrome for Testing APIë¥¼ í†µí•œ ì„¤ì¹˜"
              INSTALL_SUCCESS=true
            else
              echo "âŒ ë°©ë²• 1 ì‹¤íŒ¨: ì„¤ì¹˜ëŠ” ë˜ì—ˆìœ¼ë‚˜ ë²„ì „ í™•ì¸ ì‹¤íŒ¨"
            fi
          fi
        fi

        if [ "$INSTALL_SUCCESS" != "true" ]; then
          echo "âŒ ChromeDriver ì„¤ì¹˜ ìµœì¢… ì‹¤íŒ¨"
          exit 1
        fi

        echo "ğŸ‰ ChromeDriver ì„¤ì¹˜ ì™„ë£Œ!"
        google-chrome --version
        chromedriver --version
        echo "ê²½ë¡œ: $(which chromedriver)"


    - name: ğŸ“¦ Install Python dependencies
      run: |
        echo "=== Python ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘ ==="
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Python ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

    - name: âš™ï¸ Check environment
      run: |
        echo "=== í™˜ê²½ ì ê²€ === "
        echo "Python ë²„ì „: $(python --version)"
        echo "Chrome ë²„ì „: $(google-chrome --version)"
        echo "ChromeDriver ë²„ì „: $(chromedriver --version)"
        echo "í˜„ì¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "í¬ë¡¤ë§ ëª¨ë“œ: $CRAWL_MODE"
        echo "ê°•ì œ ë¦¬í¬íŠ¸: $FORCE_REPORT"
        echo "ë””ë²„ê·¸ ëª¨ë“œ: $DEBUG_MODE"
        if [ -z "$DISCORD_WEBHOOK_REPORT" ]; then echo "âš ï¸ DISCORD_WEBHOOK_REPORT í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì •"; fi
        if [ -z "$DISCORD_WEBHOOK_SENTIMENT" ]; then echo "âš ï¸ DISCORD_WEBHOOK_SENTIMENT í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì •"; fi
        if [ -z "$DISCORD_WEBHOOK_BUG" ]; then echo "âš ï¸ DISCORD_WEBHOOK_BUG í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì •"; fi
        echo "âœ… í™˜ê²½ ì ê²€ ì™„ë£Œ"

    - name: ğŸ“Š Pre-report Data Collection
      run: |
        echo "=== ì‚¬ì „ ë¦¬í¬íŠ¸ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘ === "
        if [ "$DEBUG_MODE" == "true" ]; then
          echo "âœ… ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”"
        fi
        
        # ê¸°ì¡´ sentiment_data.json ë°±ì—… (ì•ˆì •ì„±ì„ ìœ„í•´)
        if [ -f "sentiment_data.json" ]; then
          cp sentiment_data.json sentiment_data_backup.json
          echo "ğŸ“‚ sentiment_data.json ë°±ì—… ì™„ë£Œ"
        fi

        # ì¼ì¼ ë¦¬í¬íŠ¸ìš© ë°ì´í„° ìˆ˜ì§‘ ë° ê°ì„± ë¶„ë¥˜
        python generate_report.py --mode "$CRAWL_MODE" --force_crawl "$FORCE_REPORT" --debug_mode "$DEBUG_MODE"
        
        if [ $? -eq 0 ]; then
          echo "âœ… ì‚¬ì „ ë¦¬í¬íŠ¸ ë°ì´í„° ìˆ˜ì§‘ ë° ê°ì„± ë¶„ë¥˜ ì™„ë£Œ"
        else
          echo "âŒ ì‚¬ì „ ë¦¬í¬íŠ¸ ë°ì´í„° ìˆ˜ì§‘ ë° ê°ì„± ë¶„ë¥˜ ì‹¤íŒ¨"
          exit 1
        fi

    - name: ğŸ“ Generate Report and Send to Discord
      run: |
        echo "=== ë¦¬í¬íŠ¸ ìƒì„± ë° ì „ì†¡ === "
        python generate_report.py
        if [ $? -eq 0 ]; then
          echo "âœ… ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ë° ì „ì†¡ ì™„ë£Œ"
        else
          echo "âŒ ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ë° ì „ì†¡ ì‹¤íŒ¨"
          exit 1
        fi

    - name: ğŸ’¾ Commit and Push Report Data
      if: success()
      run: |
        echo "=== ë¦¬í¬íŠ¸ ë°ì´í„° ì»¤ë°‹ ë° í‘¸ì‹œ === "
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        if git diff --quiet --exit-code; then
          echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ. ìŠ¤í‚µí•©ë‹ˆë‹¤."
        else
          git add sentiment_data.json crawled_links_korean.json crawled_links_global.json daily_report_data.json content_cache_korean.json content_cache_global.json
          git commit -m "ğŸ“Š Daily Report Update: $(date '+%Y-%m-%d %H:%M')" || echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          
          # 3ë²ˆ ì¬ì‹œë„
          for i in 1 2 3; do
            if git push origin main; then
              echo "âœ… Git í‘¸ì‹œ ì„±ê³µ"
              break
            else
              echo "âŒ Git í‘¸ì‹œ ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘..."
              git pull --rebase origin main
              sleep 5
            fi
          done
        fi
        
        echo "âœ… ë¦¬í¬íŠ¸ ë°ì´í„° ì»¤ë°‹ ì™„ë£Œ"

    - name: ğŸ”„ Cleanup and Restore
      if: always()
      run: |
        echo "=== ì •ë¦¬ ë° ë³µì› === "
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f /tmp/chromedriver.zip
        rm -rf /usr/local/bin/chromedriver-linux64/ # ë³€ê²½ëœ ê²½ë¡œ ì²˜ë¦¬
        rm -f /tmp/chrome-linux.zip
        rm -rf /opt/chrome-linux/
        rm -f daily_report_data.json
        
        # ë°±ì—… íŒŒì¼ ë³µì›
        if [ -f "sentiment_data_backup.json" ]; then
          if [ ! -f "sentiment_data.json" ]; then
            mv sentiment_data_backup.json sentiment_data.json
            echo "ğŸ“‚ sentiment_data.json ë³µì›"
          else
            rm -f sentiment_data_backup.json
          fi
        fi
        
        echo "âœ… ì •ë¦¬ ë° ë³µì› ì™„ë£Œ"

    - name: ğŸ“ˆ Final Report Summary
      if: always()
      run: |
        echo "=== ìµœì¢… ë¦¬í¬íŠ¸ ìš”ì•½ === "
        echo "ğŸ“… ì‹¤í–‰ ë‚ ì§œ: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ğŸ¯ í¬ë¡¤ë§ ëª¨ë“œ: $CRAWL_MODE"
        echo "ğŸ“Š ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!"
        echo "==========================================="