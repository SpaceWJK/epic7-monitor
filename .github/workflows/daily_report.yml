name: Epic Seven Daily Report

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST (UTC 0ì‹œ)
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      force_report:
        description: 'Force generate report'
        required: false
        default: 'false'
        type: boolean
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      crawl_mode:
        description: 'Crawling mode (korean/global/all)'
        required: false
        default: 'all'
        type: choice
        options:
          - korean
          - global
          - all

jobs:
  daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
      DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
      DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
      CRAWL_MODE: ${{ github.event.inputs.crawl_mode || 'all' }}
      FORCE_REPORT: ${{ github.event.inputs.force_report || 'false' }}
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”„ Sync with remote
      run: |
        git config user.name "epic7-daily-report"
        git config user.email "epic7-daily@github.com"
        git pull --rebase origin main || echo "No conflicts"

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸŒ Install Chrome and ChromeDriver (Enhanced)
      run: |
        echo "=== Chrome ë° ChromeDriver ì„¤ì¹˜ ì‹œì‘ ==="
        
        # Chrome ì„¤ì¹˜
        sudo apt-get update -y
        sudo apt-get install -y google-chrome-stable
        
        # Chrome ë²„ì „ í™•ì¸
        CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
        echo "âœ… Chrome ë²„ì „: $CHROME_VERSION (Major: $CHROME_MAJOR_VERSION)"
        
        # ChromeDriver ì„¤ì¹˜ (3ë‹¨ê³„ í´ë°± ë©”ì»¤ë‹ˆì¦˜)
        install_chromedriver() {
          echo "ğŸ”§ ChromeDriver ì„¤ì¹˜ ì‹œë„ ì¤‘..."
          
          # ë°©ë²• 1: Chrome for Testing API ì‚¬ìš© (ìµœì‹  ë°©ì‹)
          if [ "$CHROME_MAJOR_VERSION" -ge "115" ]; then
            echo "ğŸ“¡ Chrome for Testing API ì‚¬ìš© (Chrome 115+)"
            CHROMEDRIVER_URL="https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
            
            # Chrome for Testingì—ì„œ ChromeDriver ë‹¤ìš´ë¡œë“œ
            curl -s "$CHROMEDRIVER_URL" | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform=="linux64") | .url' | head -1 > /tmp/chromedriver_url.txt
            
            if [ -s /tmp/chromedriver_url.txt ]; then
              DOWNLOAD_URL=$(cat /tmp/chromedriver_url.txt)
              echo "ğŸ“¥ ë‹¤ìš´ë¡œë“œ URL: $DOWNLOAD_URL"
              
              wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
              if [ $? -eq 0 ]; then
                sudo unzip -o /tmp/chromedriver.zip -d /tmp/
                sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
                sudo chmod +x /usr/local/bin/chromedriver
                echo "âœ… Chrome for Testing API ì„¤ì¹˜ ì„±ê³µ"
                return 0
              fi
            fi
          fi
          
          # ë°©ë²• 2: GitHub ChromeDriver ë¦´ë¦¬ì¦ˆ ì‚¬ìš©
          echo "ğŸ“¡ GitHub ChromeDriver ë¦´ë¦¬ì¦ˆ ì‚¬ìš©"
          GITHUB_URL="https://api.github.com/repos/GoogleChrome/chrome-launcher/releases/latest"
          
          # ChromeDriver ë²„ì „ ë§¤í•‘
          case "$CHROME_MAJOR_VERSION" in
            "138"|"139"|"140"|"141"|"142") CHROMEDRIVER_VERSION="138.0.6200.0" ;;
            "137") CHROMEDRIVER_VERSION="137.0.6545.0" ;;
            "136") CHROMEDRIVER_VERSION="136.0.6475.0" ;;
            "135") CHROMEDRIVER_VERSION="135.0.6457.0" ;;
            *) CHROMEDRIVER_VERSION="138.0.6200.0" ;;
          esac
          
          DOWNLOAD_URL="https://github.com/GoogleChrome/chrome-launcher/releases/download/v${CHROMEDRIVER_VERSION}/chromedriver-linux64.zip"
          
          wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
          if [ $? -eq 0 ]; then
            sudo unzip -o /tmp/chromedriver.zip -d /tmp/
            sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/ 2>/dev/null || sudo mv /tmp/chromedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/chromedriver
            echo "âœ… GitHub ë¦´ë¦¬ì¦ˆ ì„¤ì¹˜ ì„±ê³µ"
            return 0
          fi
          
          # ë°©ë²• 3: webdriver-manager ì‚¬ìš© (ìµœí›„ ìˆ˜ë‹¨)
          echo "ğŸ“¡ webdriver-manager ì‚¬ìš© (ìµœí›„ ìˆ˜ë‹¨)"
          pip install webdriver-manager
          cat <<EOF | python3
from webdriver_manager.chrome import ChromeDriverManager
import shutil
import os

try:
    chromedriver_path = ChromeDriverManager().install()
    shutil.copy(chromedriver_path, '/usr/local/bin/chromedriver')
    os.chmod('/usr/local/bin/chromedriver', 0o755)
    print('âœ… webdriver-manager ì„¤ì¹˜ ì„±ê³µ')
except Exception as e:
    print(f'âŒ webdriver-manager ì„¤ì¹˜ ì‹¤íŒ¨: {e}')
    exit(1)
EOF
from webdriver_manager.chrome import ChromeDriverManager
import shutil
import os

try:
    chromedriver_path = ChromeDriverManager().install()
    shutil.copy(chromedriver_path, '/usr/local/bin/chromedriver')
    os.chmod('/usr/local/bin/chromedriver', 0o755)
    print('âœ… webdriver-manager ì„¤ì¹˜ ì„±ê³µ')
except Exception as e:
    print(f'âŒ webdriver-manager ì„¤ì¹˜ ì‹¤íŒ¨: {e}')
    exit(1)
"
          if [ $? -eq 0 ]; then
            echo "âœ… webdriver-manager ì„¤ì¹˜ ì„±ê³µ"
            return 0
          fi
          
          echo "âŒ ëª¨ë“  ChromeDriver ì„¤ì¹˜ ë°©ë²• ì‹¤íŒ¨"
          return 1
        }
        
        # ChromeDriver ì„¤ì¹˜ ì‹¤í–‰
        install_chromedriver
        
        # ì„¤ì¹˜ í™•ì¸
        if command -v chromedriver &> /dev/null; then
          CHROMEDRIVER_VERSION=$(chromedriver --version)
          echo "âœ… ChromeDriver ì„¤ì¹˜ ì™„ë£Œ: $CHROMEDRIVER_VERSION"
        else
          echo "âŒ ChromeDriver ì„¤ì¹˜ ì‹¤íŒ¨"
          exit 1
        fi
        
        # ê¶Œí•œ ë° ê²½ë¡œ í™•ì¸
        echo "ğŸ” ChromeDriver ìƒíƒœ í™•ì¸:"
        ls -la /usr/local/bin/chromedriver
        which chromedriver
        chromedriver --version
        
        echo "âœ… Chrome ë° ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"

    - name: ğŸ“¦ Install Python dependencies
      run: |
        echo "=== Python ì˜ì¡´ì„± ì„¤ì¹˜ ==="
        python -m pip install --upgrade pip
        
        if [ -f requirements.txt ]; then
          echo "ğŸ“‹ requirements.txt ì‚¬ìš©"
          pip install -r requirements.txt
        else
          echo "ğŸ“‹ ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜"
          pip install requests beautifulsoup4 selenium webdriver-manager lxml deep-translator python-dateutil
        fi
        
        echo "âœ… Python ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

    - name: ğŸ” Environment Check
      run: |
        echo "=== í™˜ê²½ ì ê²€ ==="
        echo "ğŸ Python: $(python --version)"
        echo "ğŸŒ Chrome: $(google-chrome --version)"
        echo "ğŸ”§ ChromeDriver: $(chromedriver --version)"
        echo "ğŸ“… í˜„ì¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ğŸ¯ í¬ë¡¤ë§ ëª¨ë“œ: $CRAWL_MODE"
        echo "ğŸ”„ ê°•ì œ ë¦¬í¬íŠ¸: $FORCE_REPORT"
        echo "ğŸ› ë””ë²„ê·¸ ëª¨ë“œ: $DEBUG_MODE"
        
        # ë””ìŠ¤ì½”ë“œ ì›¹í›… í™•ì¸
        if [ -n "$DISCORD_WEBHOOK_REPORT" ]; then
          echo "âœ… DISCORD_WEBHOOK_REPORT ì„¤ì •ë¨"
        else
          echo "âš ï¸ DISCORD_WEBHOOK_REPORT ë¯¸ì„¤ì •"
        fi
        
        if [ -n "$DISCORD_WEBHOOK_SENTIMENT" ]; then
          echo "âœ… DISCORD_WEBHOOK_SENTIMENT ì„¤ì •ë¨"
        else
          echo "âš ï¸ DISCORD_WEBHOOK_SENTIMENT ë¯¸ì„¤ì •"
        fi
        
        echo "âœ… í™˜ê²½ ì ê²€ ì™„ë£Œ"

    - name: ğŸ”„ Pre-report Data Collection
      run: |
        echo "=== ì‚¬ì „ ë°ì´í„° ìˆ˜ì§‘ ==="
        
        # ê¸°ì¡´ ë°ì´í„° ë°±ì—…
        if [ -f "sentiment_data.json" ]; then
          cp sentiment_data.json sentiment_data_backup.json
          echo "ğŸ“‚ sentiment_data.json ë°±ì—… ì™„ë£Œ"
        fi
        
        # ë°ì´í„° ìˆ˜ì§‘ì„ ìœ„í•œ ì„ì‹œ í¬ë¡¤ë§
        python -c "
import sys
sys.path.append('.')

try:
    from crawler import crawl_korean_sites, crawl_global_sites
    from classifier import classify_post
    import json
    from datetime import datetime, timedelta
    
    print('ğŸ” ì‚¬ì „ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...')
    
    # ëª¨ë“œë³„ ë°ì´í„° ìˆ˜ì§‘
    all_posts = []
    
    if '$CRAWL_MODE' in ['korean', 'all']:
        print('ğŸ‡°ğŸ‡· í•œêµ­ ì‚¬ì´íŠ¸ ë°ì´í„° ìˆ˜ì§‘...')
        korean_posts = crawl_korean_sites('korean')
        all_posts.extend(korean_posts)
        print(f'âœ… í•œêµ­ ì‚¬ì´íŠ¸: {len(korean_posts)}ê°œ ê²Œì‹œê¸€')
    
    if '$CRAWL_MODE' in ['global', 'all']:
        print('ğŸŒ ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ë°ì´í„° ìˆ˜ì§‘...')
        global_posts = crawl_global_sites('global')
        all_posts.extend(global_posts)
        print(f'âœ… ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸: {len(global_posts)}ê°œ ê²Œì‹œê¸€')
    
    print(f'ğŸ“Š ì´ ìˆ˜ì§‘ ê²Œì‹œê¸€: {len(all_posts)}ê°œ')
    
    # ê°ì„± ë°ì´í„° ë¶„ë¥˜
    sentiment_data = {'positive': [], 'negative': [], 'bug': [], 'neutral': []}
    
    for post in all_posts:
        try:
            classification = classify_post(post.get('title', ''))
            sentiment_data[classification].append(post)
        except Exception as e:
            print(f'âš ï¸ ê²Œì‹œê¸€ ë¶„ë¥˜ ì‹¤íŒ¨: {e}')
            sentiment_data['neutral'].append(post)
    
    # ê²°ê³¼ ì €ì¥
    with open('daily_report_data.json', 'w', encoding='utf-8') as f:
        json.dump(sentiment_data, f, ensure_ascii=False, indent=2)
    
    print(f'âœ… ê°ì„± ë¶„ì„ ì™„ë£Œ:')
    print(f'   ê¸ì •: {len(sentiment_data[\"positive\"])}ê°œ')
    print(f'   ë¶€ì •: {len(sentiment_data[\"negative\"])}ê°œ')
    print(f'   ë²„ê·¸: {len(sentiment_data[\"bug\"])}ê°œ')
    print(f'   ì¤‘ë¦½: {len(sentiment_data[\"neutral\"])}ê°œ')
    
except Exception as e:
    print(f'âŒ ì‚¬ì „ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
"
        
        echo "âœ… ì‚¬ì „ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ"

    - name: ğŸ“Š Generate Daily Report
      run: |
        echo "=== ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ==="
        
        # ë¦¬í¬íŠ¸ ìƒì„± ì‹¤í–‰
        python -c "
import sys
sys.path.append('.')

try:
    from generate_report import generate_daily_report
    from datetime import datetime
    
    print('ğŸ“Š ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘...')
    
    # ë¦¬í¬íŠ¸ ìƒì„±
    report_data = generate_daily_report(
        mode='$CRAWL_MODE',
        force_report=('$FORCE_REPORT' == 'true'),
        debug_mode=('$DEBUG_MODE' == 'true')
    )
    
    if report_data:
        print('âœ… ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì„±ê³µ')
        print(f'ğŸ“‹ ë¦¬í¬íŠ¸ ë°ì´í„°: {len(report_data)}ê°œ í•­ëª©')
    else:
        print('âš ï¸ ë¦¬í¬íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.')
    
except Exception as e:
    print(f'âŒ ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: {e}')
    import traceback
    traceback.print_exc()
    
    # í´ë°±: ê¸°ë³¸ ë¦¬í¬íŠ¸ ìƒì„±
    print('ğŸ”„ ê¸°ë³¸ ë¦¬í¬íŠ¸ ìƒì„± ì‹œë„...')
    try:
        import json
        from datetime import datetime
        
        with open('daily_report_data.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # ê¸°ë³¸ ë¦¬í¬íŠ¸ ìƒì„±
        report = {
            'date': datetime.now().strftime('%Y-%m-%d'),
            'total_posts': sum(len(posts) for posts in data.values()),
            'positive_posts': len(data.get('positive', [])),
            'negative_posts': len(data.get('negative', [])),
            'bug_posts': len(data.get('bug', [])),
            'neutral_posts': len(data.get('neutral', []))
        }
        
        print('âœ… ê¸°ë³¸ ë¦¬í¬íŠ¸ ìƒì„± ì„±ê³µ')
        print(f'ğŸ“Š ë¦¬í¬íŠ¸ ìš”ì•½: {report}')
        
    except Exception as e2:
        print(f'âŒ ê¸°ë³¸ ë¦¬í¬íŠ¸ ìƒì„±ë„ ì‹¤íŒ¨: {e2}')
        exit(1)
"
        
        echo "âœ… ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"

    - name: ğŸ“¤ Send Discord Report
      run: |
        echo "=== Discord ë¦¬í¬íŠ¸ ì „ì†¡ ==="
        
        if [ -z "$DISCORD_WEBHOOK_REPORT" ]; then
          echo "âš ï¸ DISCORD_WEBHOOK_REPORTê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
          exit 0
        fi
        
        # Discord ë¦¬í¬íŠ¸ ì „ì†¡
        python -c "
import sys
sys.path.append('.')

try:
    from notifier import send_daily_report
    import json
    from datetime import datetime
    
    print('ğŸ“¤ Discord ë¦¬í¬íŠ¸ ì „ì†¡ ì‹œì‘...')
    
    # ë¦¬í¬íŠ¸ ë°ì´í„° ë¡œë“œ
    with open('daily_report_data.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    # Discord ì „ì†¡
    result = send_daily_report(data, debug_mode=('$DEBUG_MODE' == 'true'))
    
    if result:
        print('âœ… Discord ë¦¬í¬íŠ¸ ì „ì†¡ ì„±ê³µ')
    else:
        print('âŒ Discord ë¦¬í¬íŠ¸ ì „ì†¡ ì‹¤íŒ¨')
        exit(1)
    
except Exception as e:
    print(f'âŒ Discord ë¦¬í¬íŠ¸ ì „ì†¡ ì‹¤íŒ¨: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
"
        
        echo "âœ… Discord ë¦¬í¬íŠ¸ ì „ì†¡ ì™„ë£Œ"

    - name: ğŸ“‹ Upload Debug Files
      if: github.event.inputs.debug_mode == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: daily-report-debug-${{ github.run_number }}
        path: |
          daily_report_data.json
          sentiment_data.json
          *debug*.html
          *debug*.log
        retention-days: 7

    - name: ğŸ’¾ Commit Report Data
      run: |
        echo "=== ë¦¬í¬íŠ¸ ë°ì´í„° ì»¤ë°‹ ==="
        git config --global user.email "epic7-daily@github.com"
        git config --global user.name "Epic7 Daily Reporter"
        
        # ë³€ê²½ì‚¬í•­ ì¶”ê°€
        git add -A
        
        if git diff --staged --quiet; then
          echo "ğŸ“‚ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          COMMIT_MSG="ğŸ“Š Daily Report - $(date '+%Y-%m-%d %H:%M KST')"
          if [ "$DEBUG_MODE" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG (DEBUG)"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          # í‘¸ì‹œ ì¬ì‹œë„ ë¡œì§
          for i in {1..3}; do
            echo "ğŸ“¤ í‘¸ì‹œ ì‹œë„ $i/3"
            if git push origin main; then
              echo "âœ… Git í‘¸ì‹œ ì„±ê³µ"
              break
            else
              echo "âŒ Git í‘¸ì‹œ ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘..."
              git pull --rebase origin main
              sleep 5
            fi
          done
        fi
        
        echo "âœ… ë¦¬í¬íŠ¸ ë°ì´í„° ì»¤ë°‹ ì™„ë£Œ"

    - name: ğŸ”„ Cleanup and Restore
      if: always()
      run: |
        echo "=== ì •ë¦¬ ë° ë³µì› ==="
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f /tmp/chromedriver.zip
        rm -f /tmp/chromedriver_url.txt
        rm -f daily_report_data.json
        
        # ë°±ì—… íŒŒì¼ ë³µì›
        if [ -f "sentiment_data_backup.json" ]; then
          if [ ! -f "sentiment_data.json" ]; then
            mv sentiment_data_backup.json sentiment_data.json
            echo "ğŸ“‚ sentiment_data.json ë³µì›"
          else
            rm -f sentiment_data_backup.json
          fi
        fi
        
        echo "âœ… ì •ë¦¬ ë° ë³µì› ì™„ë£Œ"

    - name: ğŸ“ˆ Final Report Summary
      if: always()
      run: |
        echo "=== ìµœì¢… ë¦¬í¬íŠ¸ ìš”ì•½ ==="
        echo "ğŸ“… ì‹¤í–‰ ë‚ ì§œ: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ğŸ¯ í¬ë¡¤ë§ ëª¨ë“œ: $CRAWL_MODE"
        echo "ğŸ”„ ê°•ì œ ë¦¬í¬íŠ¸: $FORCE_REPORT"
        echo "ğŸ› ë””ë²„ê·¸ ëª¨ë“œ: $DEBUG_MODE"
        echo "âš¡ ì‘ì—… ìƒíƒœ: ${{ job.status }}"
        echo "ğŸš€ ì›Œí¬í”Œë¡œìš° ë²ˆí˜¸: ${{ github.run_number }}"
        echo "ğŸ”— ì‹¤í–‰ ID: ${{ github.run_id }}"
        
        # ë©”ëª¨ë¦¬ ë° ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
        echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
        free -h
        echo "ğŸ’¿ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
        df -h
        
        echo "âœ… Epic7 ì¼ì¼ ë¦¬í¬íŠ¸ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ"