name: ðŸ“Š Epic7 Daily Report (Optimized v3.1)

on:
  schedule:
    - cron: "0 9 * * *"  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ðŸ” Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      report_period:
        description: 'ðŸ“… Report period in hours'
        required: false
        default: '24'
        type: choice
        options:
          - '12'
          - '24'
          - '48'
      force_regenerate:
        description: 'ðŸ”„ Force regenerate all data'
        required: false
        default: 'false'
        type: boolean

env:
  TZ: Asia/Seoul
  PYTHONUNBUFFERED: 1
  DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
  DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
  REPORT_PERIOD: ${{ github.event.inputs.report_period || '24' }}
  FORCE_REGENERATE: ${{ github.event.inputs.force_regenerate || 'false' }}

jobs:
  daily-report-optimized:
    name: ðŸ“ˆ Generate Daily Report (Optimized)
    runs-on: ubuntu-latest
    timeout-minutes: 15  # ê¸°ì¡´ 30ë¶„ â†’ 15ë¶„ìœ¼ë¡œ ë‹¨ì¶•
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python Environment (Optimized)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install Minimal Dependencies
        run: |
          echo "ðŸ“¦ Installing minimal dependencies for report generation..."
          pip install --upgrade pip --quiet
          # ë¦¬í¬íŠ¸ ìƒì„±ì— í•„ìš”í•œ ìµœì†Œ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜
          pip install requests python-dateutil --quiet
          echo "âœ… Dependencies installed successfully"

      - name: ðŸ” Validate Data Sources
        run: |
          echo "ðŸ” Validating existing data sources..."
          
          # bug_monitor.ymlì—ì„œ ìƒì„±ëœ ë°ì´í„° íŒŒì¼ í™•ì¸
          DATA_FOUND=false
          
          if [ -f "sentiment_data.json" ]; then
            echo "âœ… Found sentiment_data.json"
            DATA_FOUND=true
          fi
          
          if [ -f "crawled_links.json" ]; then
            echo "âœ… Found crawled_links.json"
            DATA_FOUND=true
          fi
          
          if [ -f "monitoring_stats.json" ]; then
            echo "âœ… Found monitoring_stats.json"
            DATA_FOUND=true
          fi
          
          if [ "$DATA_FOUND" = "false" ]; then
            echo "âš ï¸ No data files found. Report will be generated with available system data."
          fi
          
          echo "ðŸ“Š Data validation completed"

      - name: ðŸ“Š Generate Optimized Daily Report
        run: |
          echo "ðŸ“Š Generating optimized daily report..."
          
          # ë¦¬í¬íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ì¡´ìž¬í•˜ëŠ” ê²½ìš°)
          if [ -f "generate_report.py" ]; then
            echo "ðŸš€ Running generate_report.py..."
            python generate_report.py \
              --period $REPORT_PERIOD \
              --debug $DEBUG_MODE \
              --force-regenerate $FORCE_REGENERATE
          else
            echo "ðŸ“ Generating basic report template..."
            
            # ê¸°ë³¸ ë¦¬í¬íŠ¸ í…œí”Œë¦¿ ìƒì„±
            cat > daily_report.md << 'EOF'
          # ðŸ“Š Epic7 Daily Report
          
          **ìƒì„± ì‹œê°„:** $(date '+%Y-%m-%d %H:%M:%S %Z')
          **ë¦¬í¬íŠ¸ ê¸°ê°„:** $REPORT_PERIOD hours
          **ëª¨ë“œ:** $([ "$DEBUG_MODE" = "true" ] && echo "Debug" || echo "Production")
          
          ## ðŸ“ˆ ì‹œìŠ¤í…œ ìƒíƒœ
          
          ### ðŸ“ ë°ì´í„° íŒŒì¼ í˜„í™©
          $(find . -name "*.json" -type f | wc -l) JSON íŒŒì¼ ë°œê²¬
          $(find . -name "*.log" -type f | wc -l) ë¡œê·¸ íŒŒì¼ ë°œê²¬
          
          ### ðŸ–¥ï¸ ì‹œìŠ¤í…œ ì •ë³´
          - **ìš´ì˜ì²´ì œ:** $(uname -a)
          - **Python ë²„ì „:** $(python --version)
          - **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:** $(free -h | grep Mem | awk '{print $3 "/" $2}')
          - **ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:** $(df -h . | tail -1 | awk '{print $3 "/" $2 " (" $5 ")"}')
          
          ## ðŸ“Š ë°ì´í„° ìš”ì•½
          
          ### ê°ì„± ë°ì´í„°
          $(if [ -f "sentiment_data.json" ]; then
            echo "âœ… ê°ì„± ë°ì´í„° íŒŒì¼ ì¡´ìž¬"
            echo "ðŸ“ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $(stat -c %y sentiment_data.json)"
          else
            echo "âš ï¸ ê°ì„± ë°ì´í„° íŒŒì¼ ì—†ìŒ"
          fi)
          
          ### í¬ë¡¤ë§ ë°ì´í„°
          $(if [ -f "crawled_links.json" ]; then
            echo "âœ… í¬ë¡¤ë§ ë°ì´í„° íŒŒì¼ ì¡´ìž¬"
            echo "ðŸ“ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $(stat -c %y crawled_links.json)"
          else
            echo "âš ï¸ í¬ë¡¤ë§ ë°ì´í„° íŒŒì¼ ì—†ìŒ"
          fi)
          
          ### ëª¨ë‹ˆí„°ë§ í†µê³„
          $(if [ -f "monitoring_stats.json" ]; then
            echo "âœ… ëª¨ë‹ˆí„°ë§ í†µê³„ íŒŒì¼ ì¡´ìž¬"
            echo "ðŸ“ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $(stat -c %y monitoring_stats.json)"
          else
            echo "âš ï¸ ëª¨ë‹ˆí„°ë§ í†µê³„ íŒŒì¼ ì—†ìŒ"
          fi)
          
          ---
          
          **ìƒì„± ì™„ë£Œ:** $(date '+%Y-%m-%d %H:%M:%S %Z')
          EOF
          
            # í™˜ê²½ ë³€ìˆ˜ ì¹˜í™˜
            envsubst < daily_report.md > daily_report_final.md
            mv daily_report_final.md daily_report.md
          fi
          
          echo "âœ… Daily report generated successfully"

      - name: ðŸ“¤ Upload Report Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_id }}
          path: |
            daily_report.md
            *.json
            *.log
          retention-days: 7
          compression-level: 6

      - name: ðŸ“¬ Send Discord Report Notification
        if: always()
        run: |
          if [[ -n "$DISCORD_WEBHOOK_REPORT" ]]; then
            echo "ðŸ“¬ Sending Discord notification..."
            
            # ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ ê²°ì •
            STATUS_COLOR=$([ "${{ job.status }}" = "success" ] && echo "3066993" || echo "15158332")
            STATUS_EMOJI=$([ "${{ job.status }}" = "success" ] && echo "âœ…" || echo "âŒ")
            
            # ë¦¬í¬íŠ¸ íŒŒì¼ í¬ê¸° í™•ì¸
            REPORT_SIZE=$([ -f "daily_report.md" ] && du -h daily_report.md | cut -f1 || echo "N/A")
            
            # Discord ë©”ì‹œì§€ ìƒì„±
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"embeds\": [{
                     \"title\": \"$STATUS_EMOJI Epic7 Daily Report\",
                     \"description\": \"ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± $([ "${{ job.status }}" = "success" ] && echo "ì™„ë£Œ" || echo "ì‹¤íŒ¨")\",
                     \"color\": $STATUS_COLOR,
                     \"fields\": [
                       {
                         \"name\": \"ðŸ“… ë¦¬í¬íŠ¸ ê¸°ê°„\",
                         \"value\": \"$REPORT_PERIOD ì‹œê°„\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ðŸ” ë””ë²„ê·¸ ëª¨ë“œ\",
                         \"value\": \"$DEBUG_MODE\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ðŸ“ ë¦¬í¬íŠ¸ í¬ê¸°\",
                         \"value\": \"$REPORT_SIZE\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ðŸ–¥ï¸ ì‹œìŠ¤í…œ ì •ë³´\",
                         \"value\": \"ë©”ëª¨ë¦¬: $(free -h | grep Mem | awk '{print $3}') / ë””ìŠ¤í¬: $(df -h . | tail -1 | awk '{print $5}')\",
                         \"inline\": false
                       },
                       {
                         \"name\": \"â±ï¸ ì‹¤í–‰ ì‹œê°„\",
                         \"value\": \"$(date '+%Y-%m-%d %H:%M:%S %Z')\",
                         \"inline\": false
                       }
                     ],
                     \"footer\": {
                       \"text\": \"Epic7 Daily Report v3.1 (Optimized)\"
                     }
                   }]
                 }" \
                 "$DISCORD_WEBHOOK_REPORT"
            
            echo "âœ… Discord notification sent successfully"
          else
            echo "âš ï¸ Discord webhook not configured"
          fi

      - name: ðŸ”„ Commit Report Changes
        if: success()
        run: |
          echo "ðŸ”„ Committing report changes..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if [[ -n $(git status --porcelain) ]]; then
            echo "ðŸ“ Changes detected, committing..."
            git add daily_report.md *.json *.log 2>/dev/null || true
            git commit -m "ðŸ“Š Daily Report: $(date '+%Y-%m-%d %H:%M:%S')" || true
            git push || echo "âš ï¸ Push failed - continuing..."
            echo "âœ… Report committed successfully"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary files..."
          
          # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/daily_report_* 2>/dev/null || true
          rm -f /tmp/report_data_* 2>/dev/null || true
          
          echo "âœ… Cleanup completed"
