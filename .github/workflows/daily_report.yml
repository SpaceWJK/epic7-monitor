name: Epic Seven Daily Report (Enhanced & Stable)

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST (UTC 0ì‹œ)
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      force_report:
        description: 'Force generate report'
        required: false
        default: 'false'
        type: boolean
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    
    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
      DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
      DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 3
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”„ Git ì¶©ëŒ ì™„ì „ í•´ê²° ë° ë™ê¸°í™”
        run: |
          echo "=== Git ì¶©ëŒ ì™„ì „ í•´ê²° ì‹œì‘ ==="
          git config --global user.email "epic7-report@github.com"
          git config --global user.name "Epic7 Daily Reporter"
          
          # í˜„ì¬ ìƒíƒœ ì €ì¥
          echo "í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
          echo "í˜„ì¬ ì»¤ë°‹: $(git rev-parse HEAD)"
          
          # ì›ê²© ì €ì¥ì†Œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          git fetch origin main
          
          # ë¡œì»¬ ë³€ê²½ì‚¬í•­ ì„ì‹œ ì €ì¥
          if [[ -n $(git status --porcelain) ]]; then
            echo "ë¡œì»¬ ë³€ê²½ì‚¬í•­ ì„ì‹œ ì €ì¥ ì¤‘..."
            git stash push -m "Auto-stash before daily report $(date)"
          fi
          
          # ê°•ì œ ë™ê¸°í™” (ì¶©ëŒ ë°©ì§€)
          echo "ì›ê²© ì €ì¥ì†Œì™€ ê°•ì œ ë™ê¸°í™” ì¤‘..."
          git reset --hard origin/main
          git clean -fd
          
          # ì„ì‹œ ì €ì¥ëœ ë³€ê²½ì‚¬í•­ì´ ìˆë‹¤ë©´ ë³µì› ì‹œë„
          if git stash list | grep -q "Auto-stash before daily report"; then
            echo "ì„ì‹œ ì €ì¥ëœ ë³€ê²½ì‚¬í•­ ë³µì› ì‹œë„ ì¤‘..."
            git stash pop || {
              echo "ì¶©ëŒ ë°œìƒ, ìˆ˜ë™ í•´ê²° í•„ìš” ì—†ìŒ - ìµœì‹  ìƒíƒœ ìœ ì§€"
              git stash drop
            }
          fi
          
          echo "Git ë™ê¸°í™” ì™„ë£Œ"

      - name: ğŸ Python í™˜ê²½ ì„¤ì • (ìµœì í™”)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: ğŸŒ Chrome/ChromeDriver ì„¤ì¹˜ (ì•ˆì •ì„± ê°•í™”)
        run: |
          echo "=== Chrome ë° ChromeDriver ì„¤ì¹˜ ì‹œì‘ ==="
          
          # Chrome ì„¤ì¹˜
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Chrome ë²„ì „ í™•ì¸
          CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
          CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
          echo "âœ… Chrome ì„¤ì¹˜ë¨: $CHROME_VERSION (ì£¼ë²„ì „: $CHROME_MAJOR_VERSION)"
          
          # ê¸°ì¡´ ChromeDriver ì œê±°
          sudo rm -f /usr/local/bin/chromedriver /usr/bin/chromedriver
          
          # ChromeDriver ì„¤ì¹˜ (ë‹¤ì¤‘ ë°©ë²•)
          echo "ğŸ” ChromeDriver ì„¤ì¹˜ ì¤‘..."
          
          # ë°©ë²• 1: ì •í™•í•œ ë²„ì „ ë§¤ì¹­
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR_VERSION}" 2>/dev/null || echo "")
          
          # ë°©ë²• 2: ì•ˆì • ë²„ì „ ì‚¬ìš©
          if [ -z "$CHROMEDRIVER_VERSION" ] || [ "$CHROMEDRIVER_VERSION" = "Not Found" ]; then
            CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE" 2>/dev/null || echo "121.0.6167.85")
            echo "âš ï¸ ì•ˆì • ë²„ì „ ì‚¬ìš©: $CHROMEDRIVER_VERSION"
          fi
          
          # ChromeDriver ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
          DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          
          if wget -q --spider "$DOWNLOAD_URL" 2>/dev/null; then
            echo "ğŸ“¥ ChromeDriver ë‹¤ìš´ë¡œë“œ: $CHROMEDRIVER_VERSION"
            wget -q -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
            sudo unzip -q /tmp/chromedriver.zip -d /tmp/
            sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/chromedriver
            echo "âœ… ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì‚¬ìš©"
            sudo apt-get install -y chromium-chromedriver
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
          fi
          
          # ì„¤ì¹˜ í™•ì¸
          echo "ğŸ” ì„¤ì¹˜ í™•ì¸:"
          which chromedriver && chromedriver --version || echo "ChromeDriver í™•ì¸ ì‹¤íŒ¨"
          
          echo "Chrome ë° ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ìµœì í™”)
        run: |
          echo "=== Python ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘ ==="
          python -m pip install --upgrade pip
          
          # requirements.txt ì¡´ì¬ í™•ì¸
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
            echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âŒ requirements.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            exit 1
          fi
          
          # ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
          echo "ğŸ“‹ ì„¤ì¹˜ëœ ì£¼ìš” íŒ¨í‚¤ì§€:"
          pip list | grep -E "(requests|selenium|beautifulsoup4|discord)" || echo "ì¼ë¶€ íŒ¨í‚¤ì§€ ëˆ„ë½"

      - name: ğŸ“Š ì¼ì¼ ê°ì„± ë™í–¥ ë¦¬í¬íŠ¸ ìƒì„±
        env:
          DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
          DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: |
          echo "=== ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘ ==="
          echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ê°•ì œ ì‹¤í–‰: ${{ github.event.inputs.force_report }}"
          echo "ë””ë²„ê·¸ ëª¨ë“œ: ${{ github.event.inputs.debug_mode }}"
          
          # í™˜ê²½ë³€ìˆ˜ í™•ì¸
          if [ -z "$DISCORD_WEBHOOK_REPORT" ]; then
            echo "âŒ DISCORD_WEBHOOK_REPORT í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
            exit 1
          fi
          
          # ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤í–‰
          if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
            echo "ğŸ› ë””ë²„ê·¸ ëª¨ë“œë¡œ ì‹¤í–‰"
            python generate_report.py --debug 2>&1 | tee daily_report_debug.log
          else
            python generate_report.py
          fi
          
          echo "ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: $(date '+%Y-%m-%d %H:%M:%S KST')"

      - name: ğŸ“¤ ë””ë²„ê·¸ íŒŒì¼ ì—…ë¡œë“œ (ì¡°ê±´ë¶€)
        if: github.event.inputs.debug_mode == 'true' || failure()
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-debug-${{ github.run_number }}
          path: |
            *.html
            *.log
            crawled_links.json
          retention-days: 14
          if-no-files-found: warn

      - name: ğŸ“‹ ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬
        if: always()
        run: |
          echo "=== ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬ ==="
          echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
          free -h
          echo "ğŸ’¿ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h / | tail -1
          echo "ğŸ”— ì €ì¥ëœ ë§í¬ íŒŒì¼ ìƒíƒœ:"
          if [ -f "crawled_links.json" ]; then
            echo "âœ… crawled_links.json ì¡´ì¬ ($(stat -c%s crawled_links.json) bytes)"
            echo "ğŸ“Š ì €ì¥ëœ ë§í¬ ìˆ˜: $(cat crawled_links.json | jq -r '.links | length' 2>/dev/null || echo 'N/A')"
          else
            echo "âŒ crawled_links.json ì—†ìŒ"
          fi
          
          echo "ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸:"
          curl -s --max-time 5 https://page.onstove.com > /dev/null && echo "âœ… ìŠ¤í† ë¸Œ ì—°ê²° ê°€ëŠ¥" || echo "âŒ ìŠ¤í† ë¸Œ ì—°ê²° ì‹¤íŒ¨"
          curl -s --max-time 5 https://bbs.ruliweb.com > /dev/null && echo "âœ… ë£¨ë¦¬ì›¹ ì—°ê²° ê°€ëŠ¥" || echo "âŒ ë£¨ë¦¬ì›¹ ì—°ê²° ì‹¤íŒ¨"

      - name: ğŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ (ì¶©ëŒ ë°©ì§€)
        run: |
          echo "=== Git ë³€ê²½ì‚¬í•­ ì²˜ë¦¬ ==="
          
          # ì›ê²© ì €ì¥ì†Œ ìµœì‹  ìƒíƒœ í™•ì¸
          git fetch origin main
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if [[ -n $(git status --porcelain) ]]; then
            echo "ë³€ê²½ ì‚¬í•­ ë°œê²¬, ì»¤ë°‹ ì§„í–‰"
            git status --porcelain
            
            # ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
            git add crawled_links.json *.html *.log 2>/dev/null || true
            
            # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
            COMMIT_MSG="ğŸ“Š ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± - $(date '+%Y-%m-%d %H:%M KST')"
            if [ "${{ github.event.inputs.force_report }}" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG (ê°•ì œì‹¤í–‰)"
            fi
            if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG (ë””ë²„ê·¸)"
            fi
            
            # ì¶©ëŒ ë°©ì§€ í‘¸ì‹œ (ìµœëŒ€ 3íšŒ ì‹œë„)
            for attempt in {1..3}; do
              echo "í‘¸ì‹œ ì‹œë„ $attempt/3"
              
              # ì›ê²© ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
              git fetch origin main
              if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main)" ]; then
                echo "ì›ê²© ì €ì¥ì†Œì— ìƒˆë¡œìš´ ë³€ê²½ì‚¬í•­ ë°œê²¬, ë¦¬ë² ì´ìŠ¤ ì‹œë„"
                
                # ì•ˆì „í•œ ë¦¬ë² ì´ìŠ¤
                git pull --rebase origin main || {
                  echo "ë¦¬ë² ì´ìŠ¤ ì‹¤íŒ¨, ê°•ì œ ë™ê¸°í™” í›„ ì¬ì‹œë„"
                  git rebase --abort 2>/dev/null || true
                  git stash push -m "Temp stash for force sync" 2>/dev/null || true
                  git reset --hard origin/main
                  git stash pop 2>/dev/null || true
                  git add crawled_links.json *.html *.log 2>/dev/null || true
                }
              fi
              
              # ì»¤ë°‹ ë° í‘¸ì‹œ
              git commit -m "$COMMIT_MSG" 2>/dev/null || {
                echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŒ"
                break
              }
              
              if git push origin main; then
                echo "âœ… Git í‘¸ì‹œ ì„±ê³µ"
                break
              else
                echo "âŒ Git í‘¸ì‹œ ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘..."
                if [ $attempt -eq 3 ]; then
                  echo "ğŸ’¥ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ë„ë‹¬, í‘¸ì‹œ ì‹¤íŒ¨"
                  exit 1
                fi
                sleep 5
              fi
            done
          else
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
          fi

      - name: ğŸ“ˆ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "=== ì¼ì¼ ë¦¬í¬íŠ¸ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ ==="
          echo "ğŸ“… ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ“Š ì‘ì—… ìƒíƒœ: ${{ job.status }}"
          echo "ğŸ”— ì‹¤í–‰ ID: ${{ github.run_id }}"
          echo "ğŸ“ ì›Œí¬í”Œë¡œìš° ë²ˆí˜¸: ${{ github.run_number }}"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„± ë° ì „ì†¡ ì™„ë£Œ"
          else
            echo "âŒ ì¼ì¼ ë¦¬í¬íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
            echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”"
          fi