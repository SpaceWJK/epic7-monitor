name: Epic Seven Bug Monitor Dispatcher

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: 'Monitor mode (korean/global/all)'
        required: false
        default: 'korean'
        type: choice
        options:
          - korean
          - global
          - all
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
jobs:
  # í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš°
  korean-monitor:
    if: ${{ inputs.mode == 'korean' || inputs.mode == 'all' || github.event_name == 'schedule' }}
    uses: ./.github/workflows/bug_monitor_korean.yml
    with:
      debug_mode: ${{ inputs.debug_mode == 'true' }}
      test_mode: false
    secrets: inherit

  # ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš°
  global-monitor:
    if: ${{ inputs.mode == 'global' || inputs.mode == 'all' }}
    uses: ./.github/workflows/bug_monitor_global.yml
    with:
      debug_mode: ${{ inputs.debug_mode == 'true' }}
      test_mode: false
    secrets: inherit

  # ê²°ê³¼ í†µí•© ë° ì¢…í•© ë³´ê³ ì„œ
  dispatcher-summary:
    if: ${{ always() }}
    needs: [korean-monitor, global-monitor]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“Š ë””ìŠ¤íŒ¨ì²˜ ê²°ê³¼ ì¢…í•©
      run: |
        echo "=== Epic7 Bug Monitor Dispatcher ê²°ê³¼ ì¢…í•© ==="
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
        echo "ëª¨ë“œ: ${{ inputs.mode || 'korean (scheduled)' }}"
        echo "ë””ë²„ê·¸ ëª¨ë“œ: ${{ inputs.debug_mode || 'false' }}"
        echo ""
        
        # í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ê²°ê³¼
        echo "ğŸ‡°ğŸ‡· í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ê²°ê³¼:"
        if [ "${{ needs.korean-monitor.result }}" == "success" ]; then
          echo "  âœ… ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
        elif [ "${{ needs.korean-monitor.result }}" == "failure" ]; then
          echo "  âŒ ì‹¤íŒ¨"
        elif [ "${{ needs.korean-monitor.result }}" == "skipped" ]; then
          echo "  â­ï¸ ê±´ë„ˆëœ€"
        else
          echo "  âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ: ${{ needs.korean-monitor.result }}"
        fi
        
        # ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ê²°ê³¼
        echo "ğŸŒ ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ê²°ê³¼:"
        if [ "${{ needs.global-monitor.result }}" == "success" ]; then
          echo "  âœ… ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
        elif [ "${{ needs.global-monitor.result }}" == "failure" ]; then
          echo "  âŒ ì‹¤íŒ¨"
        elif [ "${{ needs.global-monitor.result }}" == "skipped" ]; then
          echo "  â­ï¸ ê±´ë„ˆëœ€"
        else
          echo "  âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ: ${{ needs.global-monitor.result }}"
        fi
        
        echo ""
        echo "=== ë””ìŠ¤íŒ¨ì²˜ ì‹¤í–‰ ì™„ë£Œ ==="
    
    - name: ğŸ“¤ Discord ì¢…í•© ë³´ê³ ì„œ ì „ì†¡
      if: env.DISCORD_WEBHOOK_REPORT != ''
      run: |
        KOREAN_STATUS="${{ needs.korean-monitor.result }}"
        GLOBAL_STATUS="${{ needs.global-monitor.result }}"
        
        # ìƒíƒœ ì´ëª¨ì§€ ì„¤ì •
        if [ "$KOREAN_STATUS" == "success" ]; then
          KOREAN_EMOJI="âœ…"
        elif [ "$KOREAN_STATUS" == "failure" ]; then
          KOREAN_EMOJI="âŒ"
        elif [ "$KOREAN_STATUS" == "skipped" ]; then
          KOREAN_EMOJI="â­ï¸"
        else
          KOREAN_EMOJI="âš ï¸"
        fi
        
        if [ "$GLOBAL_STATUS" == "success" ]; then
          GLOBAL_EMOJI="âœ…"
        elif [ "$GLOBAL_STATUS" == "failure" ]; then
          GLOBAL_EMOJI="âŒ"
        elif [ "$GLOBAL_STATUS" == "skipped" ]; then
          GLOBAL_EMOJI="â­ï¸"
        else
          GLOBAL_EMOJI="âš ï¸"
        fi
        
        # Discord ë©”ì‹œì§€ ìƒì„±
        DISCORD_MESSAGE="{
          \"embeds\": [{
            \"title\": \"ğŸ¯ Epic7 Bug Monitor Dispatcher ê²°ê³¼\",
            \"description\": \"**ì‹¤í–‰ ì‹œê°„:** $(date '+%Y-%m-%d %H:%M:%S %Z')\\n**íŠ¸ë¦¬ê±°:** ${{ github.event_name }}\\n**ëª¨ë“œ:** ${{ inputs.mode || 'korean (scheduled)' }}\\n**ë””ë²„ê·¸:** ${{ inputs.debug_mode || 'false' }}\",
            \"color\": 3447003,
            \"fields\": [
              {
                \"name\": \"ğŸ‡°ğŸ‡· í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§\",
                \"value\": \"$KOREAN_EMOJI $KOREAN_STATUS\",
                \"inline\": true
              },
              {
                \"name\": \"ğŸŒ ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§\",
                \"value\": \"$GLOBAL_EMOJI $GLOBAL_STATUS\",
                \"inline\": true
              }
            ],
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\",
            \"footer\": {
              \"text\": \"Epic7 Bug Monitor Dispatcher\"
            }
          }]
        }"
        
        # Discord ì›¹í›… ì „ì†¡
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "$DISCORD_MESSAGE" \
             "$DISCORD_WEBHOOK_REPORT"
    
    - name: ğŸ ë””ìŠ¤íŒ¨ì²˜ ì™„ë£Œ
      run: |
        echo "Epic7 Bug Monitor Dispatcher ì‹¤í–‰ ì™„ë£Œ"
        echo "ì „ì²´ ì‹¤í–‰ ì‹œê°„: ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"