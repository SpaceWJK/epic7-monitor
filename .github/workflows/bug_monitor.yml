name: Epic Seven Bug Monitor Dispatcher

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: 'Monitor mode (korean/global/all)'
        required: false
        default: 'korean'
        type: choice
        options:
          - korean
          - global
          - all
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
jobs:
  # 한국 사이트 모니터링 워크플로우
  korean-monitor:
    if: ${{ inputs.mode == 'korean' || inputs.mode == 'all' || github.event_name == 'schedule' }}
    uses: ./.github/workflows/bug_monitor_korean.yml
    with:
      debug_mode: ${{ inputs.debug_mode == 'true' }}
      test_mode: false
    secrets: inherit

  # 글로벌 사이트 모니터링 워크플로우
  global-monitor:
    if: ${{ inputs.mode == 'global' || inputs.mode == 'all' }}
    uses: ./.github/workflows/bug_monitor_global.yml
    with:
      debug_mode: ${{ inputs.debug_mode == 'true' }}
      test_mode: false
    secrets: inherit

  # 결과 통합 및 종합 보고서
  dispatcher-summary:
    if: ${{ always() }}
    needs: [korean-monitor, global-monitor]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
    
    steps:
    - name: 📥 체크아웃
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 📊 디스패처 결과 종합
      run: |
        echo "=== Epic7 Bug Monitor Dispatcher 결과 종합 ==="
        echo "실행 시간: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "트리거: ${{ github.event_name }}"
        echo "모드: ${{ inputs.mode || 'korean (scheduled)' }}"
        echo "디버그 모드: ${{ inputs.debug_mode || 'false' }}"
        echo ""
        
        # 한국 사이트 모니터링 결과
        echo "🇰🇷 한국 사이트 모니터링 결과:"
        if [ "${{ needs.korean-monitor.result }}" == "success" ]; then
          echo "  ✅ 성공적으로 완료"
        elif [ "${{ needs.korean-monitor.result }}" == "failure" ]; then
          echo "  ❌ 실패"
        elif [ "${{ needs.korean-monitor.result }}" == "skipped" ]; then
          echo "  ⏭️ 건너뜀"
        else
          echo "  ⚠️ 알 수 없는 상태: ${{ needs.korean-monitor.result }}"
        fi
        
        # 글로벌 사이트 모니터링 결과
        echo "🌐 글로벌 사이트 모니터링 결과:"
        if [ "${{ needs.global-monitor.result }}" == "success" ]; then
          echo "  ✅ 성공적으로 완료"
        elif [ "${{ needs.global-monitor.result }}" == "failure" ]; then
          echo "  ❌ 실패"
        elif [ "${{ needs.global-monitor.result }}" == "skipped" ]; then
          echo "  ⏭️ 건너뜀"
        else
          echo "  ⚠️ 알 수 없는 상태: ${{ needs.global-monitor.result }}"
        fi
        
        echo ""
        echo "=== 디스패처 실행 완료 ==="
    
    - name: 📤 Discord 종합 보고서 전송
      if: env.DISCORD_WEBHOOK_REPORT != ''
      run: |
        KOREAN_STATUS="${{ needs.korean-monitor.result }}"
        GLOBAL_STATUS="${{ needs.global-monitor.result }}"
        
        # 상태 이모지 설정
        if [ "$KOREAN_STATUS" == "success" ]; then
          KOREAN_EMOJI="✅"
        elif [ "$KOREAN_STATUS" == "failure" ]; then
          KOREAN_EMOJI="❌"
        elif [ "$KOREAN_STATUS" == "skipped" ]; then
          KOREAN_EMOJI="⏭️"
        else
          KOREAN_EMOJI="⚠️"
        fi
        
        if [ "$GLOBAL_STATUS" == "success" ]; then
          GLOBAL_EMOJI="✅"
        elif [ "$GLOBAL_STATUS" == "failure" ]; then
          GLOBAL_EMOJI="❌"
        elif [ "$GLOBAL_STATUS" == "skipped" ]; then
          GLOBAL_EMOJI="⏭️"
        else
          GLOBAL_EMOJI="⚠️"
        fi
        
        # Discord 메시지 생성
        DISCORD_MESSAGE="{
          \"embeds\": [{
            \"title\": \"🎯 Epic7 Bug Monitor Dispatcher 결과\",
            \"description\": \"**실행 시간:** $(date '+%Y-%m-%d %H:%M:%S %Z')\\n**트리거:** ${{ github.event_name }}\\n**모드:** ${{ inputs.mode || 'korean (scheduled)' }}\\n**디버그:** ${{ inputs.debug_mode || 'false' }}\",
            \"color\": 3447003,
            \"fields\": [
              {
                \"name\": \"🇰🇷 한국 사이트 모니터링\",
                \"value\": \"$KOREAN_EMOJI $KOREAN_STATUS\",
                \"inline\": true
              },
              {
                \"name\": \"🌐 글로벌 사이트 모니터링\",
                \"value\": \"$GLOBAL_EMOJI $GLOBAL_STATUS\",
                \"inline\": true
              }
            ],
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\",
            \"footer\": {
              \"text\": \"Epic7 Bug Monitor Dispatcher\"
            }
          }]
        }"
        
        # Discord 웹훅 전송
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "$DISCORD_MESSAGE" \
             "$DISCORD_WEBHOOK_REPORT"
    
    - name: 🏁 디스패처 완료
      run: |
        echo "Epic7 Bug Monitor Dispatcher 실행 완료"
        echo "전체 실행 시간: ${{ job.status == 'success' && '성공' || '실패' }}"