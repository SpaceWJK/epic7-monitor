name: Epic Seven Bug Monitor Dispatcher

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: 'Monitor mode (korean/global/all)'
        required: false
        default: 'korean'
        type: choice
        options:
          - korean
          - global
          - all
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  # í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš°
  korean-monitor:
    if: ${{ inputs.mode == 'korean' || inputs.mode == 'all' || github.event_name == 'schedule' }}
    uses: ./.github/workflows/bug_monitor_korean.yml
    with:
      debug_mode: ${{ inputs.debug_mode == 'true' }}
      test_mode: false
    secrets: inherit

  # ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš°
  global-monitor:
    if: ${{ inputs.mode == 'global' || inputs.mode == 'all' }}
    uses: ./.github/workflows/bug_monitor_global.yml
    with:
      debug_mode: ${{ inputs.debug_mode == 'true' }}
    secrets: inherit

  # ë””ìŠ¤íŒ¨ì¹˜ ê²°ê³¼ ì¢…í•© ë° ë³´ê³ 
  dispatch-summary:
    needs: [korean-monitor, global-monitor]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    env:
      TZ: Asia/Seoul
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Dispatch Summary Report
        run: |
          echo "============================================="
          echo "   Epic7 ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš° ë””ìŠ¤íŒ¨ì¹˜ ì™„ë£Œ"
          echo "============================================="
          echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ì‹¤í–‰ ëª¨ë“œ: ${{ inputs.mode || 'scheduled' }}"
          echo "ë””ë²„ê·¸ ëª¨ë“œ: ${{ inputs.debug_mode || 'false' }}"
          echo "íŠ¸ë¦¬ê±° ìœ í˜•: ${{ github.event_name }}"
          echo "ì›Œí¬í”Œë¡œìš° ë²ˆí˜¸: ${{ github.run_number }}"
          echo "ì‹¤í–‰ ID: ${{ github.run_id }}"
          echo ""
          
          # ê° ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ í™•ì¸
          KOREAN_RESULT="${{ needs.korean-monitor.result }}"
          GLOBAL_RESULT="${{ needs.global-monitor.result }}"
          
          echo "=== ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ ==="
          
          # í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ê²°ê³¼
          if [[ "${{ inputs.mode }}" == "korean" || "${{ inputs.mode }}" == "all" || "${{ github.event_name }}" == "schedule" ]]; then
            echo "ğŸ‡°ğŸ‡· í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§:"
            echo "   - í¬ë¡¤ë§ ëŒ€ìƒ: STOVE, ì•„ì¹´ë¼ì´ë¸Œ, ë£¨ë¦¬ì›¹"
            echo "   - ì›Œí¬í”Œë¡œìš°: bug_monitor_korean.yml"
            echo "   - ì‹¤í–‰ ê²°ê³¼: $KOREAN_RESULT"
            
            case "$KOREAN_RESULT" in
              "success")
                echo "   - ìƒíƒœ: âœ… ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
                ;;
              "failure")
                echo "   - ìƒíƒœ: âŒ ì‹¤í–‰ ì‹¤íŒ¨"
                ;;
              "cancelled")
                echo "   - ìƒíƒœ: â¹ï¸ ì‹¤í–‰ ì·¨ì†Œ"
                ;;
              "skipped")
                echo "   - ìƒíƒœ: â­ï¸ ê±´ë„ˆëœ€"
                ;;
              *)
                echo "   - ìƒíƒœ: â“ ì•Œ ìˆ˜ ì—†ìŒ ($KOREAN_RESULT)"
                ;;
            esac
            echo ""
          fi
          
          # ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ê²°ê³¼
          if [[ "${{ inputs.mode }}" == "global" || "${{ inputs.mode }}" == "all" ]]; then
            echo "ğŸŒ ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§:"
            echo "   - í¬ë¡¤ë§ ëŒ€ìƒ: Reddit, í•´ì™¸ í¬ëŸ¼"
            echo "   - ì›Œí¬í”Œë¡œìš°: bug_monitor_global.yml"
            echo "   - ì‹¤í–‰ ê²°ê³¼: $GLOBAL_RESULT"
            
            case "$GLOBAL_RESULT" in
              "success")
                echo "   - ìƒíƒœ: âœ… ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
                ;;
              "failure")
                echo "   - ìƒíƒœ: âŒ ì‹¤í–‰ ì‹¤íŒ¨"
                ;;
              "cancelled")
                echo "   - ìƒíƒœ: â¹ï¸ ì‹¤í–‰ ì·¨ì†Œ"
                ;;
              "skipped")
                echo "   - ìƒíƒœ: â­ï¸ ê±´ë„ˆëœ€"
                ;;
              *)
                echo "   - ìƒíƒœ: â“ ì•Œ ìˆ˜ ì—†ìŒ ($GLOBAL_RESULT)"
                ;;
            esac
            echo ""
          fi
          
          # ì „ì²´ ê²°ê³¼ íŒì •
          echo "=== ì „ì²´ ì‹¤í–‰ ê²°ê³¼ ==="
          
          SUCCESS_COUNT=0
          TOTAL_COUNT=0
          
          if [[ "${{ inputs.mode }}" == "korean" || "${{ inputs.mode }}" == "all" || "${{ github.event_name }}" == "schedule" ]]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            if [[ "$KOREAN_RESULT" == "success" ]]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
          fi
          
          if [[ "${{ inputs.mode }}" == "global" || "${{ inputs.mode }}" == "all" ]]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            if [[ "$GLOBAL_RESULT" == "success" ]]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
          fi
          
          echo "ì‹¤í–‰ëœ ì›Œí¬í”Œë¡œìš°: $TOTAL_COUNTê°œ"
          echo "ì„±ê³µí•œ ì›Œí¬í”Œë¡œìš°: $SUCCESS_COUNTê°œ"
          echo "ì„±ê³µë¥ : $(( SUCCESS_COUNT * 100 / TOTAL_COUNT ))%"
          echo ""
          
          if [[ $SUCCESS_COUNT -eq $TOTAL_COUNT ]]; then
            echo "ğŸ‰ ëª¨ë“  ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "   Epic7 ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤."
          elif [[ $SUCCESS_COUNT -gt 0 ]]; then
            echo "âš ï¸ ì¼ë¶€ ì›Œí¬í”Œë¡œìš°ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            echo "   ë¶€ë¶„ì ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ì´ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âŒ ëª¨ë“  ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            echo "   ì‹œìŠ¤í…œ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤."
          fi
          
          echo ""
          echo "============================================="
          echo "   ë””ìŠ¤íŒ¨ì¹˜ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ"
          echo "============================================="

      - name: ğŸ“ˆ System Status Check
        if: always()
        run: |
          echo "=== ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬ ==="
          echo "ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
          free -h
          echo ""
          echo "ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h
          echo ""
          echo "í˜„ì¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ì—…íƒ€ì„: $(uptime)"