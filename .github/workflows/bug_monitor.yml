name: Epic Seven Unified Bug Monitor

on:
  schedule:
    - cron: "*/15 * * * *"  # 15Î∂ÑÎßàÎã§
  workflow_dispatch:
    inputs:
      mode:
        description: 'Monitor mode (arca/global/all)'
        required: true
        default: 'all'
        type: choice
        options:
        - arca
        - global
        - all

jobs:
  monitor:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.mode)) || '["arca", "global"]' }}
    
    env:
      TZ: Asia/Seoul
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Chrome and ChromeDriver (Compatible Version)
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Chrome Î≤ÑÏ†Ñ Ï†ïÌôïÌûà Ï∂îÏ∂ú
          CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
          CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
          echo "üåü Chrome Î≤ÑÏ†Ñ: $CHROME_VERSION (Ï£ºÎ≤ÑÏ†Ñ: $CHROME_MAJOR_VERSION)"
          
          # Í∏∞Ï°¥ ChromeDriver Ï†úÍ±∞ (Î≤ÑÏ†Ñ Ï∂©Îèå Î∞©ÏßÄ)
          sudo rm -f /usr/local/bin/chromedriver
          
          # Ï†ïÌôïÌûà Îß§Ïπ≠ÎêòÎäî ChromeDriver Î≤ÑÏ†Ñ Ï∞æÍ∏∞
          echo "üîç ChromeDriver Î≤ÑÏ†Ñ ÌÉêÏÉâ Ï§ë..."
          
          # Î∞©Î≤ï 1: Ï†ïÌôïÌïú Chrome Î≤ÑÏ†ÑÍ≥º Îß§Ïπ≠ÎêòÎäî ChromeDriver
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR_VERSION}" || echo "")
          
          # Î∞©Î≤ï 2: Ï†ïÌôïÌïú Î≤ÑÏ†ÑÏù¥ ÏóÜÏúºÎ©¥ ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÇ¨Ïö©
          if [ -z "$CHROMEDRIVER_VERSION" ] || [ "$CHROMEDRIVER_VERSION" = "Not Found" ]; then
            echo "‚ö†Ô∏è Ï†ïÌôïÌïú Î≤ÑÏ†ÑÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏñ¥ ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÇ¨Ïö©"
            CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE" || echo "")
          fi
          
          # Î∞©Î≤ï 3: ÏµúÌõÑ ÏàòÎã®ÏúºÎ°ú ÌïòÎìúÏΩîÎî©Îêú ÏïàÏ†ï Î≤ÑÏ†Ñ
          if [ -z "$CHROMEDRIVER_VERSION" ]; then
            CHROMEDRIVER_VERSION="119.0.6045.105"  # ÏïåÎ†§ÏßÑ ÏïàÏ†ï Î≤ÑÏ†Ñ
            echo "‚ö†Ô∏è Î™®Îì† API Ïã§Ìå®, ÌïòÎìúÏΩîÎî©Îêú ÏïàÏ†ï Î≤ÑÏ†Ñ ÏÇ¨Ïö©: $CHROMEDRIVER_VERSION"
          fi
          
          echo "‚úÖ ÏÑ†ÌÉùÎêú ChromeDriver Î≤ÑÏ†Ñ: $CHROMEDRIVER_VERSION"
          
          # ChromeDriver Îã§Ïö¥Î°úÎìú Î∞è ÏÑ§Ïπò
          DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          echo "üì• Îã§Ïö¥Î°úÎìú URL: $DOWNLOAD_URL"
          
          # Îã§Ïö¥Î°úÎìú ÏãúÎèÑ
          if wget -q --spider "$DOWNLOAD_URL"; then
            wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
            sudo unzip /tmp/chromedriver.zip -d /tmp/
            sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/chromedriver
            echo "‚úÖ ChromeDriver ÏÑ§Ïπò ÏôÑÎ£å: $(chromedriver --version 2>/dev/null || echo 'Î≤ÑÏ†Ñ ÌôïÏù∏ Ïã§Ìå®')"
          else
            echo "‚ùå Îã§Ïö¥Î°úÎìú Ïã§Ìå®, Ïö∞Î∂ÑÌà¨ Ìå®ÌÇ§ÏßÄ ÏÇ¨Ïö©"
            sudo apt-get install -y chromium-chromedriver
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
          fi
          
          # ÏÑ§Ïπò ÌôïÏù∏
          echo "üîç ÏÑ§ÏπòÎêú ChromeDriver Í≤ΩÎ°ú:"
          which chromedriver || echo "PATHÏóêÏÑú Ï∞æÏùÑ Ïàò ÏóÜÏùå"
          ls -la /usr/local/bin/chromedriver 2>/dev/null || echo "/usr/local/bin/chromedriver ÏóÜÏùå"
          ls -la /usr/bin/chromedriver 2>/dev/null || echo "/usr/bin/chromedriver ÏóÜÏùå"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run bug monitor - ${{ matrix.mode }}
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: python monitor_bugs.py --mode ${{ matrix.mode }}

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-${{ matrix.mode }}-${{ github.run_number }}
          path: |
            *.html
            crawled_links.json
          retention-days: 7

      - name: Commit changes
        run: |
          git config --local user.email "epic7-monitor@github.com"
          git config --local user.name "Epic7 Monitor Bot"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add crawled_links.json
            git commit -m "üîç Update crawled links - ${{ matrix.mode }} [$(date '+%Y-%m-%d %H:%M:%S KST')]"
            git push
          fi
