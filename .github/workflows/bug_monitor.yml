name: ğŸ® Epic Seven Bug Monitor v5.0

on:
  schedule:
    # ğŸš€ v5.0 ì‹ ê·œ: 30ë¶„ í†µí•© ìŠ¤ì¼€ì¤„ (ë§¤ì‹œ 30ë¶„)
    - cron: "30 * * * *"  # ë§¤ì‹œ 30ë¶„ì— ì‹¤í–‰ (ì‹¤ì‹œê°„ ì²˜ë¦¬ ì‹œìŠ¤í…œ)

  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ğŸ” Enable debug mode for detailed logging'
        required: false
        default: 'false'
        type: boolean
      force_crawl:
        description: 'ğŸ”„ Force crawl (ignore cache)'
        required: false
        default: 'false'
        type: boolean
      execution_timeout:
        description: 'â±ï¸ Execution timeout in minutes'
        required: false
        default: '45'
        type: choice
        options:
          - '30'
          - '45'
          - '60'

env:
  TZ: Asia/Seoul
  PYTHONUNBUFFERED: 1
  EXECUTION_LOCK_FILE: "epic7_monitor_running.lock"

jobs:
  # ğŸš€ v5.0 ì‹ ê·œ: í†µí•© ëª¨ë‹ˆí„°ë§ Job (30ë¶„ ìŠ¤ì¼€ì¤„)
  unified-monitor-v5:
    name: ğŸ® Epic Seven Unified Monitor v5.0
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.execution_timeout || '45') }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”’ Check Execution Status
        id: status_check
        run: |
          echo "ğŸ” ì‹¤í–‰ ìƒíƒœ ì²´í¬ ì‹œì‘..."
          
          # ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
          if [ -f "$EXECUTION_LOCK_FILE" ]; then
            lock_time=$(cat $EXECUTION_LOCK_FILE)
            current_time=$(date +%s)
            time_diff=$((current_time - lock_time))
            
            # 2ì‹œê°„(7200ì´ˆ) ì´ìƒ ì§€ë‚¬ìœ¼ë©´ ì˜¤ë˜ëœ ë½ íŒŒì¼ë¡œ ê°„ì£¼
            if [ $time_diff -gt 7200 ]; then
              echo "âš ï¸ ì˜¤ë˜ëœ ë½ íŒŒì¼ ë°œê²¬ ($time_diffì´ˆ) - ì œê±° í›„ ê³„ì† ì§„í–‰"
              rm -f $EXECUTION_LOCK_FILE
              echo "can_execute=true" >> $GITHUB_OUTPUT
            else
              echo "â¸ï¸ ì´ì „ ì‹¤í–‰ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤ ($time_diffì´ˆ ê²½ê³¼) - ëŒ€ê¸°"
              echo "can_execute=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            echo "âœ… ì‹¤í–‰ ê°€ëŠ¥ ìƒíƒœ"
            echo "can_execute=true" >> $GITHUB_OUTPUT
          fi
          
          # ì‹¤í–‰ ë½ íŒŒì¼ ìƒì„±
          echo $(date +%s) > $EXECUTION_LOCK_FILE
          echo "ğŸ”’ ì‹¤í–‰ ë½ íŒŒì¼ ìƒì„±: $EXECUTION_LOCK_FILE"

      - name: ğŸ Setup Python 3.11
        if: steps.status_check.outputs.can_execute == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ”§ Install Chrome & ChromeDriver
        if: steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸŒ Installing Chrome and ChromeDriver for v5.0..."
          
          # Chrome ì„¤ì¹˜ (ìµœì‹  ì•ˆì • ë²„ì „)
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # ChromeDriver ì„¤ì¹˜ (Chrome ë²„ì „ê³¼ ë§¤ì¹­)
          CHROME_VERSION=$(google-chrome --version | grep -oE "[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+")
          echo "ğŸ” Chrome version: $CHROME_VERSION"
          
          # ChromeDriver ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
          wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROME_VERSION/linux64/chromedriver-linux64.zip" -O chromedriver.zip
          unzip -q chromedriver.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -rf chromedriver.zip chromedriver-linux64
          
          # ì„¤ì¹˜ í™•ì¸
          echo "âœ… Chrome: $(google-chrome --version)"
          echo "âœ… ChromeDriver: $(chromedriver --version)"

      - name: ğŸ“¦ Install Python Dependencies
        if: steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸ“¦ Installing Python dependencies for v5.0..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt --quiet
          
          echo "ğŸ” Key package versions:"
          pip show selenium requests beautifulsoup4 deep-translator | grep -E "Name|Version"

      - name: ğŸš€ Execute Epic Seven Monitor v5.0
        if: steps.status_check.outputs.can_execute == 'true'
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
          DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
          DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
          # Reddit API í™˜ê²½ë³€ìˆ˜
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
          # ì‹¤í–‰ ì˜µì…˜
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          FORCE_CRAWL: ${{ github.event.inputs.force_crawl || 'false' }}
        run: |
          echo "ğŸš€ Starting Epic Seven Monitor v5.0..."
          echo "âš™ï¸ Debug Mode: $DEBUG_MODE"
          echo "ğŸ”„ Force Crawl: $FORCE_CRAWL" 
          echo "â° Execution Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ¯ Mode: 30ë¶„ í†µí•© ìŠ¤ì¼€ì¤„ (ì¦‰ì‹œ ì²˜ë¦¬ ì‹œìŠ¤í…œ)"
          
          # ì‹¤í–‰ í”Œë˜ê·¸ ì„¤ì •
          debug_flag=""
          force_flag=""
          
          if [ "$DEBUG_MODE" = "true" ]; then
            debug_flag="--debug"
            echo "ğŸ” ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”"
          fi
          
          if [ "$FORCE_CRAWL" = "true" ]; then
            force_flag="--force-crawl"
            echo "ğŸ”„ ê°•ì œ í¬ë¡¤ë§ ëª¨ë“œ í™œì„±í™”"
          fi
          
          # ğŸš€ v5.0 ì‹ ê·œ: 30ë¶„ í†µí•© ëª¨ë“œ ì‹¤í–‰
          echo "ğŸ® Running v5.0: ê²Œì‹œê¸€ë³„ ì¦‰ì‹œ ì²˜ë¦¬ (í¬ë¡¤ë§â†’ê°ì„±ë¶„ì„â†’ì•Œë¦¼â†’ì €ì¥)"
          python monitor_bugs.py --schedule 30min $debug_flag $force_flag
          
          echo "âœ… Epic Seven Monitor v5.0 ì‹¤í–‰ ì™„ë£Œ"

      - name: ğŸ“Š Execution Summary v5.0
        if: always() && steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸ“Š Epic Seven Monitor v5.0 Summary:"
          echo "â° Completed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ¯ Mode: 30ë¶„ í†µí•© ìŠ¤ì¼€ì¤„ (ì¦‰ì‹œ ì²˜ë¦¬)"
          echo "ğŸ–¥ï¸ System Resources:"
          echo "   Memory: $(free -h | grep Mem | awk '{print $3/$2}')"
          echo "   Disk: $(df -h . | tail -1 | awk '{print $3/$2 " (" $5 ")"}')"
          echo "   CPU Load: $(uptime | awk -F'load average:' '{ print $2 }')"

      - name: ğŸ”„ Commit Changes v5.0
        if: success() && steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸ”„ Committing changes from v5.0 execution..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Epic Seven v5.0"
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Changes detected, committing..."
            git add *.json *.html *.log 2>/dev/null || true
            
            commit_msg="ğŸ® Epic7 Monitor v5.0: $(date '+%Y-%m-%d %H:%M:%S') [30ë¶„ í†µí•©]"
            git commit -m "$commit_msg" || true
            git push || echo "âš ï¸ Push failed - continuing..."
            echo "âœ… Changes committed successfully"
          else
            echo "âœ… No changes to commit"
          fi

      - name: ğŸ”“ Release Execution Lock
        if: always() && steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸ”“ ì‹¤í–‰ ë½ í•´ì œ..."
          rm -f $EXECUTION_LOCK_FILE
          echo "âœ… ì‹¤í–‰ ë½ íŒŒì¼ ì œê±° ì™„ë£Œ"

      - name: â¸ï¸ Execution Skipped
        if: steps.status_check.outputs.can_execute == 'false'
        run: |
          echo "â¸ï¸ Epic Seven Monitor v5.0 ì‹¤í–‰ ê±´ë„ˆëœ€"
          echo "ğŸ“ ì‚¬ìœ : ì´ì „ ì‹¤í–‰ì´ ì•„ì§ ì§„í–‰ ì¤‘"
          echo "â° ë‹¤ìŒ ìŠ¤ì¼€ì¤„: $(date -d '+30 minutes' '+%Y-%m-%d %H:%M:%S %Z')"

  # ğŸš¨ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (v5.0 ê°œì„ )
  failure-notification-v5:
    name: ğŸš¨ Failure Notification v5.0
    runs-on: ubuntu-latest
    needs: [unified-monitor-v5]
    if: failure()

    steps:
      - name: ğŸ”“ Emergency Lock Release
        run: |
          echo "ğŸš¨ ë¹„ìƒ ë½ íŒŒì¼ ì •ë¦¬..."
          rm -f $EXECUTION_LOCK_FILE || true
          echo "âœ… ë¹„ìƒ ë½ í•´ì œ ì™„ë£Œ"

      - name: ğŸš¨ Send Enhanced Failure Notification
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: |
          if [[ -n "$DISCORD_WEBHOOK_BUG" ]]; then
            echo "ğŸš¨ Sending enhanced failure notification to Discord..."
            
            # ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
            failure_reason="ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"
            if [[ "${{ needs.unified-monitor-v5.result }}" == "cancelled" ]]; then
              failure_reason="ì‹¤í–‰ ì·¨ì†Œë¨"
            elif [[ "${{ needs.unified-monitor-v5.result }}" == "failure" ]]; then
              failure_reason="ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
            fi
            
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"embeds\": [{
                     \"title\": \"ğŸš¨ Epic7 Monitor v5.0 ì‹¤í–‰ ì‹¤íŒ¨\",
                     \"description\": \"Epic7 ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ v5.0 ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\",
                     \"color\": 15548997,
                     \"fields\": [
                       {
                         \"name\": \"â° ì‹¤í–‰ ì‹œê°„\",
                         \"value\": \"$(date '+%Y-%m-%d %H:%M:%S %Z')\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸš¨ ì‹¤íŒ¨ ì›ì¸\",
                         \"value\": \"$failure_reason\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ¯ ë²„ì „\",
                         \"value\": \"v5.0 (30ë¶„ í†µí•©)\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ”§ Debug ëª¨ë“œ\",
                         \"value\": \"${{ github.event.inputs.debug_mode || 'false' }}\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ”„ Force Crawl\",
                         \"value\": \"${{ github.event.inputs.force_crawl || 'false' }}\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"â° ë‹¤ìŒ ì‹¤í–‰\",
                         \"value\": \"$(date -d '+30 minutes' '+%H:%M')\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ”— ì‹¤í–‰ ë¡œê·¸\",
                         \"value\": \"[View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                         \"inline\": false
                       }
                     ],
                     \"footer\": {
                       \"text\": \"Epic7 Monitor v5.0 | 30ë¶„ í†µí•© ìŠ¤ì¼€ì¤„\"
                     },
                     \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                   }]
                 }" \
                 "$DISCORD_WEBHOOK_BUG"
            
            echo "âœ… Enhanced failure notification sent"
          else
            echo "âš ï¸ Discord webhook not configured for failure notifications"
          fi

  # ğŸ“Š ì‹¤í–‰ í†µê³„ ìˆ˜ì§‘ (v5.0 ì‹ ê·œ)
  execution-stats-v5:
    name: ğŸ“Š Execution Statistics v5.0
    runs-on: ubuntu-latest
    needs: [unified-monitor-v5]
    if: always()

    steps:
      - name: ğŸ“Š Collect Execution Statistics
        run: |
          echo "ğŸ“Š Epic Seven Monitor v5.0 ì‹¤í–‰ í†µê³„:"
          echo "â° ì‹¤í–‰ ì¼ì‹œ: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ¯ ìŠ¤ì¼€ì¤„: 30ë¶„ í†µí•© (ë§¤ì‹œ 30ë¶„)"
          echo "ğŸ“ˆ ì‹¤í–‰ ê²°ê³¼: ${{ needs.unified-monitor-v5.result }}"
          echo "â±ï¸ íƒ€ì„ì•„ì›ƒ: ${{ github.event.inputs.execution_timeout || '45' }}ë¶„"
          echo "ğŸ”§ Debug: ${{ github.event.inputs.debug_mode || 'false' }}"
          echo "ğŸ”„ Force Crawl: ${{ github.event.inputs.force_crawl || 'false' }}"
          echo "ğŸš€ ë²„ì „: v5.0 (ê²Œì‹œê¸€ë³„ ì¦‰ì‹œ ì²˜ë¦¬)"
          echo "â­ï¸ ë‹¤ìŒ ì‹¤í–‰: $(date -d '+30 minutes' '+%Y-%m-%d %H:%M:%S %Z')"