name: ğŸ® Epic Seven Bug Monitor (Integrated v3.1)

on:
  schedule:
    # 15ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ê¸°ì¡´ ê¸°ëŠ¥ ë³´ì¡´)
    - cron: "*/15 * * * *"

  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ğŸ” Enable debug mode for detailed logging'
        required: false
        default: 'false'
        type: boolean
      force_crawl:
        description: 'ğŸ”„ Force crawl (ignore cache)'
        required: false
        default: 'false'
        type: boolean

env:
  TZ: Asia/Seoul
  PYTHONUNBUFFERED: 1

jobs:
  integrated-monitor:
    name: ğŸŒ Integrated Epic7 Monitor
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ”§ Install Chrome & ChromeDriver
        run: |
          # Chrome 138+ í˜¸í™˜ì„±ì„ ìœ„í•œ 3ë‹¨ê³„ í´ë°± ì„¤ì¹˜
          echo "ğŸŒ Installing Chrome and ChromeDriver..."

          # Stage 1: Chrome for Testing API
          CHROME_VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json | jq -r '.channels.Stable.version')
          echo "Latest Chrome version: $CHROME_VERSION"

          # Chrome ì„¤ì¹˜
          wget -q https://storage.googleapis.com/chrome-for-testing-public/$CHROME_VERSION/linux64/chrome-linux64.zip
          unzip -q chrome-linux64.zip
          sudo mv chrome-linux64 /opt/chrome
          sudo ln -sf /opt/chrome/chrome /usr/local/bin/chrome

          # ChromeDriver ì„¤ì¹˜
          wget -q https://storage.googleapis.com/chrome-for-testing-public/$CHROME_VERSION/linux64/chromedriver-linux64.zip
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

          # ì„¤ì¹˜ í™•ì¸
          chrome --version
          chromedriver --version

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          echo "ğŸ“¦ Installing Python packages..."
          pip install --upgrade pip
          pip install -r requirements.txt --quiet

          # í•µì‹¬ íŒ¨í‚¤ì§€ ë²„ì „ í™•ì¸
          echo "ğŸ” Package versions:"
          pip show selenium requests beautifulsoup4 deep-translator

      - name: ğŸš€ Run Integrated Epic7 Monitoring
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
          DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          FORCE_CRAWL: ${{ inputs.force_crawl || 'false' }}
        run: |
          echo "ğŸ® Starting Epic7 Integrated Monitoring..."
          echo "âš™ï¸ Debug Mode: $DEBUG_MODE"
          echo "ğŸ”„ Force Crawl: $FORCE_CRAWL"
          echo "â° Execution Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"

          # monitor_bugs.pyë¥¼ ë©”ì¸ ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸ë¡œ ì‹¤í–‰
          # --mode all: í•œêµ­ + ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‘ í¬ë¡¤ë§
          python monitor_bugs.py \
            --mode all \
            --debug $DEBUG_MODE \
            --force-crawl $FORCE_CRAWL

      - name: ğŸ“Š Monitor Execution Summary
        if: always()
        run: |
          echo "ğŸ“Š === Epic7 Monitor Execution Summary ==="
          echo "ğŸ• Completed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ”§ Debug Mode: ${{ inputs.debug_mode || 'false' }}"
          echo "ğŸ”„ Force Crawl: ${{ inputs.force_crawl || 'false' }}"
          echo "ğŸŒ Mode: Integrated (Korean + Global)"

          # ì‹¤í–‰ ê²°ê³¼ íŒŒì¼ í™•ì¸
          echo "ğŸ“ Generated Files:"
          ls -la *.json *.html *.log 2>/dev/null || echo "No output files found"

          # ë©”ëª¨ë¦¬ ë° ì‹œìŠ¤í…œ ìƒíƒœ
          echo "ğŸ’¾ System Status:"
          free -h
          df -h /

      - name: ğŸ”„ Commit and Push Changes
        if: success()
        run: |
          # Git ì„¤ì •
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì»¤ë°‹
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Committing monitoring results..."
            git add *.json *.html *.log 2>/dev/null || true
            git commit -m "ğŸ¤– Epic7 Monitor: $(date '+%Y-%m-%d %H:%M:%S')" || true
            git push || echo "âš ï¸ Push failed - continuing..."
          else
            echo "âœ… No changes to commit"
          fi

      - name: ğŸ“¤ Upload Debug Artifacts
        if: inputs.debug_mode == 'true' || failure()
        uses: actions/upload-artifact@v4
        with:
          name: epic7-monitor-debug-${{ github.run_number }}
          path: |
            *.html
            *.log
            *.json
          retention-days: 7

      - name: ğŸš¨ Failure Notification
        if: failure()
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: |
          if [[ -n "$DISCORD_WEBHOOK_BUG" ]]; then
            curl -H "Content-Type: application/json" \
                 -d '{
                   "embeds": [{
                     "title": "ğŸš¨ Epic7 Monitor Failed",
                     "description": "Integrated monitoring workflow failed",
                     "color": 15158332,
                     "fields": [
                       {"name": "ğŸ• Time", "value": "'$(date '+%Y-%m-%d %H:%M:%S %Z')'", "inline": true},
                       {"name": "ğŸ”§ Debug", "value": "'${{ inputs.debug_mode || 'false' }}'", "inline": true},
                       {"name": "ğŸ”— Run", "value": "[View Details]('${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}')", "inline": false}
                     ],
                     "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                   }]
                 }' \
                 "$DISCORD_WEBHOOK_BUG"
          fi
