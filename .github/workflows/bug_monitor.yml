name: Epic Seven Bug Monitor

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: 'Monitor mode (korean/all)'
        required: false
        default: 'korean'
        type: choice
        options:
          - korean
          - all
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      TZ: Asia/Seoul

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”„ Sync with remote
        run: |
          git config --global user.email "epic7-monitor@github.com"
          git config --global user.name "Epic7 Monitor Bot"

          echo "=== Git ë™ê¸°í™” ì‹œìž‘ ==="
          git fetch origin main

          if ! git diff --quiet HEAD origin/main; then
            echo "ì›ê²©ì— ë³€ê²½ì‚¬í•­ ìžˆìŒ, ë™ê¸°í™” ì§„í–‰"
            git stash push -m "Auto-stash $(date)"
            git reset --hard origin/main
            if git stash list | grep -q "Auto-stash"; then
              git stash pop || {
                echo "ì¶©ëŒ ë°œìƒ, ê°•ì œ ì´ˆê¸°í™”"
                git reset --hard HEAD
                git clean -fd
              }
            fi
          fi

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸŒ Install Chrome & ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          echo "âœ… Chrome: $(google-chrome --version)"

      - name: ðŸ“¦ Install Python packages
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Python packages installed"

      - name: ðŸ” Determine execution mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ github.event.inputs.mode }}"
            DEBUG="${{ github.event.inputs.debug_mode }}"
          else
            MODE="korean"
            DEBUG="false"
          fi
          echo "MODE=$MODE" >> $GITHUB_ENV
          echo "DEBUG=$DEBUG" >> $GITHUB_ENV
          echo "ì‹¤í–‰ ëª¨ë“œ: $MODE, ë””ë²„ê·¸: $DEBUG"

      - name: ðŸš€ Run Epic7 Bug Monitor
        run: |
          ARGS="--mode $MODE"
          if [ "$DEBUG" = "true" ]; then
            ARGS="$ARGS --debug"
            echo "ðŸ› ë””ë²„ê·¸ ëª¨ë“œë¡œ ì‹¤í–‰"
          fi
          python monitor_bugs.py $ARGS
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
          DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
          DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
          PYTHONUNBUFFERED: 1

      - name: ðŸ“Š Upload debug files
        if: env.DEBUG == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: debug-files-${{ github.run_number }}
          path: |
            *_debug_selenium.html
            *_error_debug.html
            crawled_links.json
          retention-days: 7

      - name: ðŸ’¾ Smart Git Commit
        run: |
          git config --global user.email "epic7-monitor@github.com"
          git config --global user.name "Epic7 Monitor Bot"

          git add -A
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
          else
            echo "ë³€ê²½ ì‚¬í•­ ì»¤ë°‹"
            COMMIT_MSG="ðŸ” Epic7 Monitor Update - $MODE - $(date '+%Y-%m-%d %H:%M KST')"
            if [ "$DEBUG" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG (DEBUG)"
            fi
            git commit -m "$COMMIT_MSG"

            for i in {1..3}; do
              if git push; then
                echo "Git push ì„±ê³µ"
                break
              else
                echo "Git push ì‹¤íŒ¨, ìž¬ì‹œë„ ($i/3)"
                git pull --rebase origin main || git reset --hard origin/main
                sleep 5
              fi
            done
          fi

      - name: ðŸ“ˆ Report status
        if: always()
        run: |
          echo "=== ì›Œí¬í”Œë¡œìš° ìƒíƒœ ==="
          echo "ìž‘ì—… ìƒíƒœ: ${{ job.status }}"
          echo "ëª¨ë“œ: $MODE"
          echo "ë””ë²„ê·¸: $DEBUG"
          echo "ì›Œí¬í”Œë¡œìš° ë²ˆí˜¸: ${{ github.run_number }}"
          echo "ì‹¤í–‰ ID: ${{ github.run_id }}"
          if [ -f "crawled_links.json" ]; then
            echo "ì €ìž¥ëœ ë§í¬ ìˆ˜: $(jq '.links | length' crawled_links.json 2>/dev/null || echo 0)"
            echo "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $(jq -r '.last_updated' crawled_links.json 2>/dev/null || echo N/A)"
          fi