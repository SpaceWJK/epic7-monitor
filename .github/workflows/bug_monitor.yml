name: ğŸ® Epic Seven Bug Monitor (Schedule Separated v4.0)

on:
  schedule:
    # 15ë¶„ ì£¼ê¸°: ë²„ê·¸ ê²Œì‹œíŒ ì „ìš© ëª¨ë‹ˆí„°ë§
    - cron: "*/15 * * * *"
    # 30ë¶„ ì£¼ê¸°: ìœ ì € ë™í–¥ ë¶„ì„ (ì¼ë°˜ ê²Œì‹œíŒ)
    - cron: "*/30 * * * *"

  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ğŸ” Enable debug mode for detailed logging'
        required: false
        default: 'false'
        type: boolean
      force_crawl:
        description: 'ğŸ”„ Force crawl (ignore cache)'
        required: false
        default: 'false'
        type: boolean
      monitor_mode:
        description: 'ğŸ¯ Monitor mode selection'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - 'bug_only'
          - 'sentiment_only'

env:
  TZ: Asia/Seoul
  PYTHONUNBUFFERED: 1

jobs:
  # 15ë¶„ ì£¼ê¸°: ë²„ê·¸ ê²Œì‹œíŒ ëª¨ë‹ˆí„°ë§
  bug-monitor:
    name: ğŸ› Bug Monitoring (15min)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.event.schedule == '*/15 * * * *' || github.event.inputs.monitor_mode == 'bug_only' || github.event.inputs.monitor_mode == 'auto'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ”§ Install Chrome & ChromeDriver
        run: |
          # Chrome 138+ í˜¸í™˜ì„±ì„ ìœ„í•œ ì„¤ì¹˜
          echo "ğŸŒ Installing Chrome and ChromeDriver..."
          
          # Chrome ì„¤ì¹˜
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # ChromeDriver ì„¤ì¹˜ (ìˆ˜ì •ëœ ë¶€ë¶„ - ì™„ì „í•œ ë²„ì „ ì¶”ì¶œ)
          CHROME_VERSION=$(google-chrome --version | grep -oE "[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+")
          echo "Chrome version: $CHROME_VERSION"
          
          # ChromeDriver ë‹¤ìš´ë¡œë“œ í™•ì¸ í›„ ì„¤ì¹˜
          wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROME_VERSION/linux64/chromedriver-linux64.zip"
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f chromedriver-linux64.zip
          rm -rf chromedriver-linux64
          
          # ì„¤ì¹˜ í™•ì¸
          echo "âœ… Chrome: $(google-chrome --version)"
          echo "âœ… ChromeDriver: $(chromedriver --version)"

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          echo "ğŸ“¦ Installing Python dependencies..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt --quiet
          
          echo "ğŸ” Package versions:"
          pip show selenium requests beautifulsoup4 deep-translator

      - name: ğŸ› Run Bug Monitoring (15min)
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
          DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          FORCE_CRAWL: ${{ github.event.inputs.force_crawl || 'false' }}
        run: |
          echo "ğŸ› Starting Bug Monitoring (15min cycle)..."
          echo "âš™ï¸ Debug Mode: $DEBUG_MODE"
          echo "ğŸ”„ Force Crawl: $FORCE_CRAWL"
          echo "â° Execution Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          
          # ì¡°ê±´ë³„ ì‹¤í–‰ (15ë¶„ ìŠ¤ì¼€ì¤„)
          if [ "$DEBUG_MODE" = "true" ] && [ "$FORCE_CRAWL" = "true" ]; then
            echo "ğŸ” Running bug monitoring in debug mode with force crawl..."
            python monitor_bugs.py --schedule 15min --debug --force-crawl
          elif [ "$DEBUG_MODE" = "true" ]; then
            echo "ğŸ” Running bug monitoring in debug mode..."
            python monitor_bugs.py --schedule 15min --debug
          elif [ "$FORCE_CRAWL" = "true" ]; then
            echo "ğŸ”„ Running bug monitoring with force crawl..."
            python monitor_bugs.py --schedule 15min --force-crawl
          else
            echo "ğŸ› Running bug monitoring in normal mode..."
            python monitor_bugs.py --schedule 15min
          fi

      - name: ğŸ“Š Bug Monitor Execution Summary
        run: |
          echo "ğŸ› Bug Monitor Summary:"
          echo "â° Completed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ–¥ï¸ System Info:"
          echo "   Memory: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
          echo "   Disk: $(df -h . | tail -1 | awk '{print $3 "/" $2 " (" $5 ")"}')"

      - name: ğŸ”„ Commit Bug Monitor Changes
        if: success()
        run: |
          echo "ğŸ”„ Committing bug monitor changes..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Bug monitor changes detected, committing..."
            git add *.json *.html *.log 2>/dev/null || true
            git commit -m "ğŸ› Bug Monitor: $(date '+%Y-%m-%d %H:%M:%S')" || true
            git push || echo "âš ï¸ Push failed - continuing..."
          else
            echo "âœ… No bug monitor changes to commit"
          fi

  # 30ë¶„ ì£¼ê¸°: ìœ ì € ë™í–¥ ë¶„ì„
  sentiment-monitor:
    name: ğŸ“Š User Sentiment Analysis (30min)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.event.schedule == '*/30 * * * *' || github.event.inputs.monitor_mode == 'sentiment_only' || github.event.inputs.monitor_mode == 'auto'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ”§ Install Chrome & ChromeDriver
        run: |
          # Chrome 138+ í˜¸í™˜ì„±ì„ ìœ„í•œ ì„¤ì¹˜
          echo "ğŸŒ Installing Chrome and ChromeDriver..."
          
          # Chrome ì„¤ì¹˜
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # ChromeDriver ì„¤ì¹˜
          CHROME_VERSION=$(google-chrome --version | grep -oE "[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+")
          echo "Chrome version: $CHROME_VERSION"
          
          wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROME_VERSION/linux64/chromedriver-linux64.zip"
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f chromedriver-linux64.zip
          rm -rf chromedriver-linux64
          
          # ì„¤ì¹˜ í™•ì¸
          echo "âœ… Chrome: $(google-chrome --version)"
          echo "âœ… ChromeDriver: $(chromedriver --version)"

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          echo "ğŸ“¦ Installing Python dependencies..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt --quiet
          
          echo "ğŸ” Package versions:"
          pip show selenium requests beautifulsoup4 deep-translator

      - name: ğŸ“Š Run User Sentiment Analysis (30min)
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
          DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          FORCE_CRAWL: ${{ github.event.inputs.force_crawl || 'false' }}
        run: |
          echo "ğŸ“Š Starting User Sentiment Analysis (30min cycle)..."
          echo "âš™ï¸ Debug Mode: $DEBUG_MODE"
          echo "ğŸ”„ Force Crawl: $FORCE_CRAWL"
          echo "â° Execution Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          
          # ì¡°ê±´ë³„ ì‹¤í–‰ (30ë¶„ ìŠ¤ì¼€ì¤„)
          if [ "$DEBUG_MODE" = "true" ] && [ "$FORCE_CRAWL" = "true" ]; then
            echo "ğŸ” Running sentiment analysis in debug mode with force crawl..."
            python monitor_bugs.py --schedule 30min --debug --force-crawl
          elif [ "$DEBUG_MODE" = "true" ]; then
            echo "ğŸ” Running sentiment analysis in debug mode..."
            python monitor_bugs.py --schedule 30min --debug
          elif [ "$FORCE_CRAWL" = "true" ]; then
            echo "ğŸ”„ Running sentiment analysis with force crawl..."
            python monitor_bugs.py --schedule 30min --force-crawl
          else
            echo "ğŸ“Š Running sentiment analysis in normal mode..."
            python monitor_bugs.py --schedule 30min
          fi

      - name: ğŸ“Š Sentiment Analysis Summary
        run: |
          echo "ğŸ“Š Sentiment Analysis Summary:"
          echo "â° Completed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ–¥ï¸ System Info:"
          echo "   Memory: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
          echo "   Disk: $(df -h . | tail -1 | awk '{print $3 "/" $2 " (" $5 ")"}')"

      - name: ğŸ”„ Commit Sentiment Analysis Changes
        if: success()
        run: |
          echo "ğŸ”„ Committing sentiment analysis changes..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Sentiment analysis changes detected, committing..."
            git add *.json *.html *.log 2>/dev/null || true
            git commit -m "ğŸ“Š Sentiment Analysis: $(date '+%Y-%m-%d %H:%M:%S')" || true
            git push || echo "âš ï¸ Push failed - continuing..."
          else
            echo "âœ… No sentiment analysis changes to commit"
          fi

  # ê³µí†µ ì—ëŸ¬ ì²˜ë¦¬
  failure-notification:
    name: ğŸš¨ Failure Notification
    runs-on: ubuntu-latest
    needs: [bug-monitor, sentiment-monitor]
    if: failure()

    steps:
      - name: ğŸš¨ Send Failure Notification
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: |
          if [[ -n "$DISCORD_WEBHOOK_BUG" ]]; then
            echo "ğŸš¨ Sending failure notification to Discord..."
            
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"embeds\": [{
                     \"title\": \"ğŸš¨ Epic7 Monitor ì‹¤í–‰ ì‹¤íŒ¨\",
                     \"description\": \"Epic7 ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\",
                     \"color\": 15548997,
                     \"fields\": [
                       {
                         \"name\": \"â° ì‹¤í–‰ ì‹œê°„\",
                         \"value\": \"$(date '+%Y-%m-%d %H:%M:%S %Z')\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ”§ Debug ëª¨ë“œ\",
                         \"value\": \"${{ github.event.inputs.debug_mode || 'false' }}\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ”— ì‹¤í–‰ ë¡œê·¸\",
                         \"value\": \"[View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                         \"inline\": false
                       }
                     ],
                     \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                   }]
                 }" \
                 "$DISCORD_WEBHOOK_BUG"
            
            echo "âœ… Failure notification sent"
          else
            echo "âš ï¸ Discord webhook not configured"
          fi