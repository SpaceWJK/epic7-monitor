name: ğŸŒ Epic Seven Global Monitor (STOVE + Reddit)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v3

    - name: âš™ï¸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10
        cache: 'pip'

    - name: ğŸš€ Upgrade pip & Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version || echo "chrome not installed properly"

    - name: ğŸ› Start Global Monitoring
      run: |
        ARGS="--mode global"
        echo "=== Epic7 ê¸€ë¡œë²Œ ëª¨ë‹ˆí„°ë§ ì‹œì‘ ==="
        echo "ì‹¤í–‰ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S')"
        python monitor_bugs.py $ARGS

    - name: ğŸ“ Check JSON debug file
      run: |
        if [ -f "crawled_links.json" ]; then
          echo "==== crawled_links.json ===="
          jq '. | length' crawled_links.json || cat crawled_links.json
        else
          echo "crawled_links.json does not exist!"
        fi

    - name: ğŸ“‚ Upload Selenium HTML Debug
      uses: actions/upload-artifact@v3
      with:
        name: selenium-html-global
        path: |
          *global_debug_selenium.html
          stove_debug_selenium.html
          ruliweb_debug_selenium.html
          *.log

    - name: ğŸ“ˆ Memory Status
      run: |
        echo "==== Memory & Disk Status ===="
        free -h
        df -h

    - name: âœ… Git Smart Commit & Push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add crawled_links.json
        git commit -m "ğŸŒ Update Global Links (STOVE + Reddit) - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        for i in {1..5}; do
          git pull --rebase && git push && break
          echo "Retrying git push ($i)..."
          sleep 5
        done
