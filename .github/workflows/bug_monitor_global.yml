name: ğŸŒ Epic7 Global Sites Monitor

on:
  schedule:
    # 15ë¶„ë§ˆë‹¤ ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ (í‘œì¤€ 15ë¶„ ì£¼ê¸°)
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ğŸ” Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      force_crawl:
        description: 'ğŸ”„ Force crawl (ignore cache)'
        required: false
        default: 'false'
        type: boolean

env:
  TZ: Asia/Seoul
  PYTHONUNBUFFERED: 1
  EXECUTION_LOCK_FILE: "global_monitor_running.lock"

jobs:
  global-sites-monitor:
    name: ğŸŒ ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”’ Check Execution Status
        id: status_check
        run: |
          echo "ğŸ” ê¸€ë¡œë²Œ ëª¨ë‹ˆí„° ì‹¤í–‰ ìƒíƒœ ì²´í¬..."
          
          if [ -f "$EXECUTION_LOCK_FILE" ]; then
            lock_time=$(cat $EXECUTION_LOCK_FILE)
            current_time=$(date +%s)
            time_diff=$((current_time - lock_time))
            
            if [ $time_diff -gt 2100 ]; then
              echo "âš ï¸ ì‹¤í–‰ ë½ì´ 35ë¶„ ì´ìƒ ìœ ì§€ë¨ - ë¹„ì •ìƒ ì¢…ë£Œë¡œ ê°„ì£¼í•˜ì—¬ ë½ í•´ì œ"
              rm -f "$EXECUTION_LOCK_FILE"
              echo "can_execute=true" >> $GITHUB_OUTPUT
            else
              echo "ğŸ”„ ë‹¤ë¥¸ ê¸€ë¡œë²Œ ëª¨ë‹ˆí„° ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ ì¤‘... ($(($time_diff/60))ë¶„ ê²½ê³¼)"
              echo "can_execute=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… ì‹¤í–‰ ê°€ëŠ¥ ìƒíƒœ"
            echo $(date +%s) > "$EXECUTION_LOCK_FILE"
            echo "can_execute=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ Setup Python 3.11
        if: steps.status_check.outputs.can_execute == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸŒ Install Chrome and ChromeDriver
        if: steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸŒ Chromeê³¼ ChromeDriver ì„¤ì¹˜ ì¤‘..."
          
          # Chrome ì„¤ì¹˜
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # ChromeDriver ì„¤ì¹˜
          CHROME_VERSION=$(google-chrome --version | cut -d " " -f3 | cut -d "." -f1)
          CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
          wget -q "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          
          echo "âœ… Chromeê³¼ ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"
          google-chrome --version
          chromedriver --version

      - name: ğŸ“¦ Install Dependencies
        if: steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸŒ Execute Global Sites Monitoring
        if: steps.status_check.outputs.can_execute == 'true'
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
          DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
          # Reddit API í™˜ê²½ë³€ìˆ˜
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          FORCE_CRAWL: ${{ github.event.inputs.force_crawl || 'false' }}
        run: |
          echo "ğŸŒ ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ¯ ëŒ€ìƒ: STOVE Global, Reddit"
          
          # í”Œë˜ê·¸ ì„¤ì •
          debug_flag=""
          force_flag=""
          
          if [ "$DEBUG_MODE" = "true" ]; then
            debug_flag="--debug"
          fi
          
          if [ "$FORCE_CRAWL" = "true" ]; then
            force_flag="--force-crawl"
          fi
          
          # ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
          python monitor_bugs.py --schedule 15min --mode global $debug_flag $force_flag
          
          echo "âœ… ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ"

      - name: ğŸ“Š Execution Summary
        if: steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸ“Š ê¸€ë¡œë²Œ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰ ìš”ì•½"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â° ì‹œì‘ ì‹œê°„: ${{ env.START_TIME }}"
          echo "â° ì¢…ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸŒ ëª¨ë“œ: Global Sites Only"
          echo "ğŸ¯ ëŒ€ìƒ ì‚¬ì´íŠ¸: STOVE Global Bug/General, Reddit"
          echo "ğŸ”„ ìŠ¤ì¼€ì¤„: 15ë¶„ ì£¼ê¸° (0,15,30,45ë¶„)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # ì‹¤í–‰ ê²°ê³¼ íŒŒì¼ì´ ìˆë‹¤ë©´ í‘œì‹œ
          if [ -f "execution_summary.txt" ]; then
            echo "ğŸ“‹ ìƒì„¸ ì‹¤í–‰ ê²°ê³¼:"
            cat execution_summary.txt
          fi

      - name: ğŸ’¾ Commit Changes
        if: steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤‘..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --quiet && git diff --staged --quiet; then
            echo "ğŸ“ ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git add .
            git commit -m "ğŸŒ Global monitoring: $(date '+%Y-%m-%d %H:%M:%S')" || echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            git push || echo "í‘¸ì‹œí•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "âœ… ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ"
          fi

      - name: ğŸ”“ Release Lock
        if: always() && steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸ”“ ì‹¤í–‰ ë½ í•´ì œ ì¤‘..."
          rm -f "$EXECUTION_LOCK_FILE"
          echo "âœ… ì‹¤í–‰ ë½ í•´ì œ ì™„ë£Œ"

  failure-notification:
    name: ğŸ“§ ì‹¤íŒ¨ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: global-sites-monitor
    if: failure()
    
    steps:
      - name: ğŸ“§ Send Failure Notification
        run: |
          echo "ğŸ“§ Discord ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          
          if [ -n "${{ secrets.DISCORD_WEBHOOK_BUG }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_BUG }}" \
              -H "Content-Type: application/json" \
              -d '{
                "username": "Epic7 Global Monitor Alert",
                "avatar_url": "https://cdn.discordapp.com/emojis/ğŸš¨.png",
                "embeds": [{
                  "title": "ğŸš¨ ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹¤íŒ¨",
                  "description": "Epic7 ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
                  "color": 16711680,
                  "fields": [
                    {
                      "name": "â° ì‹¤íŒ¨ ì‹œê°„",
                      "value": "'"$(date '+%Y-%m-%d %H:%M:%S %Z')"'",
                      "inline": true
                    },
                    {
                      "name": "ğŸ”— ì›Œí¬í”Œë¡œìš°",
                      "value": "[ì‹¤í–‰ ë¡œê·¸ í™•ì¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                      "inline": true
                    },
                    {
                      "name": "â° ë‹¤ìŒ ì‹¤í–‰",
                      "value": "'"$(date -d '+15 minutes' '+%H:%M')"'",
                      "inline": true
                    }
                  ]
                }]
              }' \
             "$DISCORD_WEBHOOK_BUG"
          fi