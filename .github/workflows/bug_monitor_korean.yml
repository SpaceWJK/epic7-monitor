name: ğŸŒ Bug Monitor Korean Sites

on:
  workflow_call:
    inputs:
      debug_mode:
        required: false
        type: boolean
        default: false
      test_mode:
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '*/30 * * * *'  # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'Enable test mode'
        required: false
        default: false
        type: boolean

jobs:
  monitor-korean-sites:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
      DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸŒ Install Chrome and ChromeDriver (Chrome 138 í˜¸í™˜)
      run: |
        echo "=== Chrome ë° ChromeDriver ì„¤ì¹˜ (Chrome 138 í˜¸í™˜) ==="
        
        # Chrome ì„¤ì¹˜
        sudo apt-get update -y
        sudo apt-get install -y google-chrome-stable
        
        # Chrome ë²„ì „ í™•ì¸
        CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
        echo "âœ… Chrome ë²„ì „: $CHROME_VERSION (Major: $CHROME_MAJOR_VERSION)"
        
        # ChromeDriver ì„¤ì¹˜ (3ë‹¨ê³„ í´ë°± ë°©ì‹)
        echo "=== ChromeDriver ì„¤ì¹˜ ì‹œì‘ ==="
        INSTALL_SUCCESS=false
        
        # ë°©ë²• 1: Chrome for Testing API ì‚¬ìš© (ê¶Œì¥)
        echo "ğŸ”„ ë°©ë²• 1: Chrome for Testing API ì‚¬ìš©"
        if curl -s "https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json" | grep -q "chromedriver"; then
          # ìµœì‹  stable ë²„ì „ URL íšë“
          CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json" | \
            python3 -c "import sys, json; data=json.load(sys.stdin); print(data['channels']['Stable']['downloads']['chromedriver'][0]['url'])" 2>/dev/null || echo "")
          
          if [ -n "$CHROMEDRIVER_URL" ] && [ "$CHROMEDRIVER_URL" != "null" ]; then
            echo "ğŸ”— ChromeDriver URL: $CHROMEDRIVER_URL"
            wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL"
            
            if [ -f "/tmp/chromedriver.zip" ] && [ -s "/tmp/chromedriver.zip" ]; then
              sudo unzip -o /tmp/chromedriver.zip -d /tmp/
              sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver 2>/dev/null || \
              sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
              sudo chmod +x /usr/local/bin/chromedriver
              
              if chromedriver --version >/dev/null 2>&1; then
                echo "âœ… ë°©ë²• 1 ì„±ê³µ: ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"
                INSTALL_SUCCESS=true
              fi
            fi
          fi
        fi
        
        # ë°©ë²• 2: ì§ì ‘ ë‹¤ìš´ë¡œë“œ (GitHub Release)
        if [ "$INSTALL_SUCCESS" != "true" ]; then
          echo "ğŸ”„ ë°©ë²• 2: GitHub Release ì§ì ‘ ë‹¤ìš´ë¡œë“œ"
          
          # Chrome ë²„ì „ì— ë§ëŠ” ChromeDriver ë²„ì „ ì°¾ê¸°
          case $CHROME_MAJOR_VERSION in
            "138"|"139"|"140")
              CHROMEDRIVER_VERSION="138.0.6993.88"
              ;;
            "137")
              CHROMEDRIVER_VERSION="137.0.6916.107"
              ;;
            "136")
              CHROMEDRIVER_VERSION="136.0.6877.63"
              ;;
            *)
              CHROMEDRIVER_VERSION="138.0.6993.88"  # ê¸°ë³¸ê°’
              ;;
          esac
          
          echo "ğŸ¯ ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
          
          # ì—¬ëŸ¬ ë‹¤ìš´ë¡œë“œ URL ì‹œë„
          DOWNLOAD_URLS=(
            "https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
            "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
            "https://github.com/GoogleChromeLabs/chrome-for-testing/releases/download/$CHROMEDRIVER_VERSION/chromedriver-linux64.zip"
          )
          
          for url in "${DOWNLOAD_URLS[@]}"; do
            echo "ğŸ”— ì‹œë„: $url"
            if wget -q -O /tmp/chromedriver.zip "$url"; then
              if [ -f "/tmp/chromedriver.zip" ] && [ -s "/tmp/chromedriver.zip" ]; then
                sudo unzip -o /tmp/chromedriver.zip -d /tmp/
                sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver 2>/dev/null || \
                sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
                sudo chmod +x /usr/local/bin/chromedriver
                
                if chromedriver --version >/dev/null 2>&1; then
                  echo "âœ… ë°©ë²• 2 ì„±ê³µ: ChromeDriver ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
                  INSTALL_SUCCESS=true
                  break
                fi
              fi
            fi
          done
        fi
        
        # ë°©ë²• 3: íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš© (ìµœí›„ ìˆ˜ë‹¨)
        if [ "$INSTALL_SUCCESS" != "true" ]; then
          echo "ğŸ”„ ë°©ë²• 3: íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš©"
          
          # apt íŒ¨í‚¤ì§€ ì‹œë„
          sudo apt-get update -y
          sudo apt-get install -y chromium-chromedriver 2>/dev/null || true
          
          if [ -f "/usr/bin/chromedriver" ]; then
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
            sudo chmod +x /usr/local/bin/chromedriver
            
            if chromedriver --version >/dev/null 2>&1; then
              echo "âœ… ë°©ë²• 3 ì„±ê³µ: APT ChromeDriver ì„¤ì¹˜"
              INSTALL_SUCCESS=true
            fi
          fi
        fi
        
        # ì„¤ì¹˜ ê²°ê³¼ í™•ì¸
        if [ "$INSTALL_SUCCESS" = "true" ]; then
          echo "ğŸ‰ ChromeDriver ì„¤ì¹˜ ì™„ë£Œ!"
          echo "ğŸ“‹ Chrome ë²„ì „: $(google-chrome --version)"
          echo "ğŸ“‹ ChromeDriver ë²„ì „: $(chromedriver --version)"
          echo "ğŸ“‹ ChromeDriver ê²½ë¡œ: $(which chromedriver)"
        else
          echo "âŒ ChromeDriver ì„¤ì¹˜ ì‹¤íŒ¨"
          echo "ğŸ” ì‹œìŠ¤í…œ ì •ë³´:"
          echo "   - Chrome: $(google-chrome --version)"
          echo "   - ì‹œìŠ¤í…œ: $(uname -a)"
          echo "   - ì•„í‚¤í…ì²˜: $(dpkg --print-architecture)"
          exit 1
        fi
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f /tmp/chromedriver.zip
        rm -rf /tmp/chromedriver-linux64/
        
        echo "âœ… Chrome ë° ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"

    - name: ğŸ“¦ Install dependencies
      run: |
        echo "=== Python ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘ ==="
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "requirements.txt not found, installing basic dependencies"
          pip install requests beautifulsoup4 selenium lxml deep-translator python-dateutil
        fi
        echo "âœ… Python dependencies installed"

    - name: ğŸ§ª Quick system check
      run: |
        echo "=== ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ==="
        echo "ğŸ Python ë²„ì „: $(python --version)"
        echo "ğŸŒ Chrome ë²„ì „: $(google-chrome --version)"
        echo "ğŸ”§ ChromeDriver ë²„ì „: $(chromedriver --version)"
        echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
        echo "â° í˜„ì¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"

    - name: ğŸ‡°ğŸ‡· Run Korean sites monitoring
      run: |
        echo "=== í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘ ==="
        echo "â° ì‹œì‘ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
        if [ -f "monitor_bugs.py" ]; then
          if [ "${{ inputs.debug_mode }}" == "true" ]; then
            echo "ğŸ” ë””ë²„ê·¸ ëª¨ë“œë¡œ ì‹¤í–‰"
            python monitor_bugs.py --mode korean --debug
          elif [ "${{ inputs.test_mode }}" == "true" ]; then
            echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹¤í–‰"
            python monitor_bugs.py --mode korean --test
          else
            echo "ğŸš€ ì¼ë°˜ ëª¨ë“œë¡œ ì‹¤í–‰"
            python monitor_bugs.py --mode korean
          fi
        else
          echo "âŒ monitor_bugs.py íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        echo "âœ… í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ"

    - name: ğŸ“Š Generate monitoring report
      run: |
        echo "=== ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸ ìƒì„± ==="
        
        # ë¦¬í¬íŠ¸ ê¸°ë³¸ ì •ë³´
        EXECUTION_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        CHROME_VERSION=$(google-chrome --version 2>/dev/null || echo "N/A")
        CHROMEDRIVER_VERSION=$(chromedriver --version 2>/dev/null || echo "N/A")
        
        # JSON íŒŒì¼ ìƒíƒœ í™•ì¸
        KOREAN_LINKS_COUNT=0
        if [ -f "crawled_links_korean.json" ]; then
          KOREAN_LINKS_COUNT=$(python3 -c "import json; data=json.load(open('crawled_links_korean.json')); print(len(data.get('links', [])))" 2>/dev/null || echo "0")
        fi
        
        # ë¦¬í¬íŠ¸ ìƒì„±
        cat > korean_monitoring_report.md << EOF
        # Epic7 í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸
        
        **ì‹¤í–‰ ì‹œê°„:** $EXECUTION_TIME
        **ëª¨ë“œ:** Korean Sites Only
        **ë””ë²„ê·¸ ëª¨ë“œ:** ${{ inputs.debug_mode }}
        **í…ŒìŠ¤íŠ¸ ëª¨ë“œ:** ${{ inputs.test_mode }}
        
        ## ğŸ–¥ï¸ ì‹œìŠ¤í…œ ì •ë³´
        - Chrome ë²„ì „: $CHROME_VERSION
        - ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION
        - Python ë²„ì „: $(python --version)
        - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: $(free -h | grep Mem | awk '{print $3 "/" $2}')
        
        ## ğŸ“Š ëª¨ë‹ˆí„°ë§ ê²°ê³¼
        - í•œêµ­ ì‚¬ì´íŠ¸ í¬ë¡¤ë§ëœ ë§í¬: $KOREAN_LINKS_COUNT ê°œ
        - ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ ì‚¬ì´íŠ¸:
          - STOVE ì—í”½ì„¸ë¸ ë²„ê·¸ ê²Œì‹œíŒ
          - STOVE ì—í”½ì„¸ë¸ ììœ  ê²Œì‹œíŒ
          - ë£¨ë¦¬ì›¹ ì—í”½ì„¸ë¸ ê²Œì‹œíŒ
          - ì•„ì¹´ë¼ì´ë¸Œ ì—í”½ì„¸ë¸ ê²Œì‹œíŒ
        
        ## ğŸ“ ë°ì´í„° íŒŒì¼ ìƒíƒœ
        EOF
        
        # ë°ì´í„° íŒŒì¼ ì •ë³´ ì¶”ê°€
        for file in crawled_links_korean.json content_cache_korean.json; do
          if [ -f "$file" ]; then
            echo "- $file: âœ… ì¡´ì¬ (í¬ê¸°: $(stat -c%s "$file") bytes)" >> korean_monitoring_report.md
          else
            echo "- $file: âŒ ì—†ìŒ" >> korean_monitoring_report.md
          fi
        done
        
        echo "" >> korean_monitoring_report.md
        echo "## ğŸ¯ ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ìš”ì•½" >> korean_monitoring_report.md
        echo "í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> korean_monitoring_report.md
        
        echo "ğŸ“„ í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"

    - name: ğŸ“¤ Upload monitoring artifacts
      uses: actions/upload-artifact@v4
      with:
        name: korean-monitoring-${{ github.run_number }}
        path: |
          korean_monitoring_report.md
          crawled_links_korean.json
          content_cache_korean.json
          *debug*.html
          *.log
        retention-days: 3

    - name: ğŸ”„ Commit and push changes
      run: |
        echo "=== Git ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ ==="
        
        # Git ì„¤ì •
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # ë³€ê²½ì‚¬í•­ ì¶”ê°€
        git add -A
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
        COMMIT_MESSAGE="ğŸ‡°ğŸ‡· Korean sites monitoring - $(date '+%Y-%m-%d %H:%M:%S')"
        if [ "${{ inputs.debug_mode }}" == "true" ]; then
          COMMIT_MESSAGE="$COMMIT_MESSAGE (Debug Mode)"
        fi
        if [ "${{ inputs.test_mode }}" == "true" ]; then
          COMMIT_MESSAGE="$COMMIT_MESSAGE (Test Mode)"
        fi
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if git diff --staged --quiet; then
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        else
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤‘..."
          git commit -m "$COMMIT_MESSAGE"
          git push origin main
          echo "âœ… ë³€ê²½ì‚¬í•­ í‘¸ì‹œ ì™„ë£Œ"
        fi

    - name: ğŸ”„ Cleanup
      if: always()
      run: |
        echo "=== ì •ë¦¬ ì‘ì—… ì‹œì‘ ==="
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f /tmp/chromedriver.zip
        rm -rf /tmp/chromedriver-linux64/
        
        echo "âœ… ì •ë¦¬ ì™„ë£Œ"
        echo "=========================================="
        echo "   í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ"
        echo "=========================================="
        echo "ğŸ‡°ğŸ‡· ëª¨ë‹ˆí„°ë§ ëª¨ë“œ: Korean Sites"
        echo "ğŸ” ë””ë²„ê·¸ ëª¨ë“œ: ${{ inputs.debug_mode }}"
        echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ inputs.test_mode }}"
        echo "â° ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "âœ… í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        echo "=========================================="