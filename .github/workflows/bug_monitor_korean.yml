name: ğŸŒ Bug Monitor Korean Sites (Fixed)

on:
  workflow_call:
    inputs:
      debug_mode:
        required: false
        type: boolean
        default: false
      test_mode:
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '*/30 * * * *'  # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'Enable test mode'
        required: false
        default: false
        type: boolean

jobs:
  monitor-korean-sites:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # íƒ€ì„ì•„ì›ƒ ì‹œê°„ ì—°ì¥
    
    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
      DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install webdriver-manager  # Chrome Driver ê´€ë¦¬

    - name: ğŸŒ Install Chrome and ChromeDriver (Robust)
      run: |
        # Google Chrome ìµœì‹  ì„¤ì¹˜
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Chrome ë²„ì „ í™•ì¸
        CHROME_VERSION=$(google-chrome --version)
        echo "ì„¤ì¹˜ëœ Chrome ë²„ì „: $CHROME_VERSION"
        
        # Chrome for Testing APIë¥¼ í†µí•œ ChromeDriver ë‹¤ìš´ë¡œë“œ
        python -c "
        import requests
        import zipfile
        import os
        import stat
        import subprocess
        
        try:
            # Chrome for Testing API ì‚¬ìš©
            api_url = 'https://googlechromelabs.github.io/chrome-for-testing/latest-patch-versions-per-build-with-downloads.json'
            response = requests.get(api_url, timeout=30)
            data = response.json()
            
            # Chrome ë²„ì „ í™•ì¸
            chrome_version = subprocess.check_output(['google-chrome', '--version']).decode().strip()
            major_version = chrome_version.split()[2].split('.')[0]
            
            # í•´ë‹¹ ë²„ì „ì˜ ChromeDriver ì°¾ê¸°
            target_version = None
            for version in data['builds'].keys():
                if version.startswith(major_version + '.'):
                    target_version = version
                    break
            
            if not target_version:
                target_version = max(data['builds'].keys(), key=lambda x: [int(i) for i in x.split('.')])
            
            # ChromeDriver ë‹¤ìš´ë¡œë“œ URL ì°¾ê¸°
            for download in data['builds'][target_version]['downloads']['chromedriver']:
                if download['platform'] == 'linux64':
                    chromedriver_url = download['url']
                    break
            
            print(f'ChromeDriver ë‹¤ìš´ë¡œë“œ URL: {chromedriver_url}')
            
            # ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
            driver_response = requests.get(chromedriver_url, timeout=120)
            with open('/tmp/chromedriver.zip', 'wb') as f:
                f.write(driver_response.content)
            
            with zipfile.ZipFile('/tmp/chromedriver.zip', 'r') as zip_ref:
                zip_ref.extractall('/tmp/chromedriver')
            
            # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chromedriver_path = '/tmp/chromedriver/chromedriver-linux64/chromedriver'
            os.chmod(chromedriver_path, 0o755)
            
            # /usr/local/binì— ë³µì‚¬
            import shutil
            shutil.copy(chromedriver_path, '/usr/local/bin/chromedriver')
            
            print('ChromeDriver ì„¤ì¹˜ ì™„ë£Œ')
            
        except Exception as e:
            print(f'Chrome for Testing API ì‹¤íŒ¨: {e}')
            # Fallback: webdriver-manager ì‚¬ìš©
            from webdriver_manager.chrome import ChromeDriverManager
            ChromeDriverManager().install()
        "
        
        # ChromeDriver ì„¤ì¹˜ í™•ì¸
        chromedriver --version

    - name: ğŸ” Run Korean Sites Monitoring
      run: |
        echo "=== í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘ ==="
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ARGS: --mode korean ${{ inputs.debug_mode == true && '--debug' || '' }} ${{ inputs.test_mode == true && '--test' || '' }}"
        
        python monitor_bugs.py --mode korean \
          ${{ inputs.debug_mode == true && '--debug' || '' }} \
          ${{ inputs.test_mode == true && '--test' || '' }}

    - name: ğŸ“¤ Upload debug files (if failed)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: korean-debug-files
        path: |
          *.html
          *.log
          *.json
        retention-days: 3

    - name: ğŸ’¬ Notify on failure
      if: failure()
      run: |
        if [ -n "${{ secrets.DISCORD_WEBHOOK_BUG }}" ]; then
          python -c "
          import requests
          import json
          from datetime import datetime
          
          webhook_url = '${{ secrets.DISCORD_WEBHOOK_BUG }}'
          message = {
              'embeds': [{
                  'title': 'ğŸš¨ í•œêµ­ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹¤íŒ¨',
                  'description': 'í•œêµ­ ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                  'color': 0xff0000,
                  'fields': [
                      {'name': 'ì›Œí¬í”Œë¡œìš°', 'value': 'Korean Sites Monitor', 'inline': True},
                      {'name': 'ì‹¤í–‰ ì‹œê°„', 'value': datetime.now().strftime('%Y-%m-%d %H:%M:%S'), 'inline': True},
                      {'name': 'ìƒíƒœ', 'value': 'ì‹¤íŒ¨', 'inline': True}
                  ],
                  'timestamp': datetime.now().isoformat()
              }]
          }
          
          response = requests.post(webhook_url, json=message, timeout=10)
          print(f'Discord ì•Œë¦¼ ì „ì†¡ ìƒíƒœ: {response.status_code}')
          "
        fi