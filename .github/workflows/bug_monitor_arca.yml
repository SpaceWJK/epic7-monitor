name: Bug Monitor ARCA + RULIWEB + STOVE (Enhanced)

on:
  schedule:
    - cron: '*/15 * * * *'  # 15ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:        # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor-korean-sites:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸŒ Install Chrome and ChromeDriver (Enhanced)
      run: |
        echo "=== Chrome ë° ChromeDriver ì„¤ì¹˜ ì‹œì‘ ==="
        
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Chrome ë²„ì „ ì¶”ì¶œ
        CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
        echo "Chrome ë²„ì „: $CHROME_VERSION (ì£¼ë²„ì „: $CHROME_MAJOR_VERSION)"
        
        # ê¸°ì¡´ ChromeDriver ì œê±°
        sudo rm -f /usr/local/bin/chromedriver /usr/bin/chromedriver
        
        # ChromeDriver ë²„ì „ ì°¾ê¸°
        CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR_VERSION}" || echo "")
        
        if [ -z "$CHROMEDRIVER_VERSION" ] || [ "$CHROMEDRIVER_VERSION" = "Not Found" ]; then
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE" || echo "121.0.6167.85")
          echo "ì•ˆì • ë²„ì „ ì‚¬ìš©: $CHROMEDRIVER_VERSION"
        fi
        
        echo "ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
        
        # ChromeDriver ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
        DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
        
        if wget -q --spider "$DOWNLOAD_URL" 2>/dev/null; then
          echo "ë‹¤ìš´ë¡œë“œ URL í™•ì¸ë¨: $DOWNLOAD_URL"
          wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
          sudo unzip -q /tmp/chromedriver.zip -d /tmp/
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          echo "ChromeDriver ì„¤ì¹˜ ì™„ë£Œ: $(chromedriver --version 2>/dev/null)"
        else
          echo "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ìš°ë¶„íˆ¬ íŒ¨í‚¤ì§€ ì‚¬ìš©"
          sudo apt-get install -y chromium-chromedriver
          sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
        fi
        
        # ì„¤ì¹˜ í™•ì¸
        which chromedriver
        chromedriver --version || echo "ChromeDriver ë²„ì „ í™•ì¸ ì‹¤íŒ¨"
        google-chrome --version
    
    - name: ğŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
    
    - name: ğŸ” Run Korean Sites Monitoring
      run: |
        echo "=== êµ­ë‚´ ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘ ==="
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ë””ë²„ê·¸ ëª¨ë“œ: ${{ github.event.inputs.debug_mode }}"
        
        if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
          echo "ë””ë²„ê·¸ ëª¨ë“œë¡œ ì‹¤í–‰"
          python monitor_bugs.py --mode arca --debug
        else
          python monitor_bugs.py --mode arca
        fi
        
        echo "ëª¨ë‹ˆí„°ë§ ì™„ë£Œ: $(date '+%Y-%m-%d %H:%M:%S')"
      env:
        DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        PYTHONUNBUFFERED: 1
    
    - name: ğŸ“Š Upload Debug Files (if debug mode)
      if: github.event.inputs.debug_mode == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: debug-html-files
        path: |
          *_debug_selenium.html
          *_error_debug.html
        retention-days: 7
    
    - name: ğŸ’¾ Commit and push changes
      run: |
        echo "=== Git ë³€ê²½ì‚¬í•­ ì²˜ë¦¬ ==="
        
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action Bot"
        
        # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
        git add -A
        
        if git diff --staged --quiet; then
          echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
        else
          echo "ë³€ê²½ ì‚¬í•­ ë°œê²¬, ì»¤ë°‹ ì§„í–‰"
          git status --porcelain
          
          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          COMMIT_MSG="ğŸ”„ [ARCA] í¬ë¡¤ë§ ìƒíƒœ ì—…ë°ì´íŠ¸ - $(date '+%Y-%m-%d %H:%M KST')"
          
          # ë””ë²„ê·¸ ëª¨ë“œì¸ ê²½ìš° ë©”ì‹œì§€ ì¶”ê°€
          if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG (DEBUG)"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
          echo "Git í‘¸ì‹œ ì™„ë£Œ"
        fi
    
    - name: ğŸ“ˆ Report Status
      if: always()
      run: |
        echo "=== ì‹¤í–‰ ê²°ê³¼ ìš”ì•½ ==="
        echo "ì‘ì—… ìƒíƒœ: ${{ job.status }}"
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        
        if [ -f "crawled_links.json" ]; then
          LINK_COUNT=$(cat crawled_links.json | jq '.links | length' 2>/dev/null || echo "0")
          echo "ì €ì¥ëœ ë§í¬ ìˆ˜: $LINK_COUNT"
        fi
        
        # ë””ë²„ê·¸ íŒŒì¼ ì¡´ì¬ í™•ì¸
        for file in *_debug_selenium.html *_error_debug.html; do
          if [ -f "$file" ]; then
            echo "ë””ë²„ê·¸ íŒŒì¼ ìƒì„±ë¨: $file ($(stat -c%s "$file") bytes)"
          fi
        done
