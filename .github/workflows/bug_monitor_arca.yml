name: Bug Monitor ARCA
on:
  schedule:
    - cron: '*/15 * * * *'

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Chrome and ChromeDriver (Compatible Version)
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Chrome 버전 정확히 추출
        CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
        echo "Chrome 버전: $CHROME_VERSION (주버전: $CHROME_MAJOR_VERSION)"
        
        # 기존 ChromeDriver 제거
        sudo rm -f /usr/local/bin/chromedriver
        
        # 정확히 매칭되는 ChromeDriver 버전 찾기
        CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR_VERSION}" || echo "")
        
        if [ -z "$CHROMEDRIVER_VERSION" ] || [ "$CHROMEDRIVER_VERSION" = "Not Found" ]; then
          echo "정확한 버전을 찾을 수 없어 안정 버전 사용"
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE" || echo "")
        fi
        
        if [ -z "$CHROMEDRIVER_VERSION" ]; then
          CHROMEDRIVER_VERSION="119.0.6045.105"
          echo "모든 API 실패, 하드코딩된 안정 버전 사용: $CHROMEDRIVER_VERSION"
        fi
        
        echo "선택된 ChromeDriver 버전: $CHROMEDRIVER_VERSION"
        
        # ChromeDriver 다운로드 및 설치
        DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
        
        if wget -q --spider "$DOWNLOAD_URL"; then
          wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
          sudo unzip /tmp/chromedriver.zip -d /tmp/
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          echo "ChromeDriver 설치 완료: $(chromedriver --version 2>/dev/null || echo '버전 확인 실패')"
        else
          echo "다운로드 실패, 우분투 패키지 사용"
          sudo apt-get install -y chromium-chromedriver
          sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
        fi
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run monitor
      run: python monitor_bugs.py --mode arca
      env:
        DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
    
    - name: Commit and push if changed
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        git add .
        git diff --staged --quiet || git commit -m "Update crawled links"
        git push
