name: ğŸ“Š Epic7 Sentiment Alert v6.0

on:
  schedule:
    # 30ë¶„ë§ˆë‹¤ ê°ì„± ë°ì´í„° í†µí•© ì•Œë¦¼ (15ë¶„ í›„ 10ë¶„ ëŒ€ê¸°)
    - cron: '25,55 * * * *'
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ğŸ” Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      alert_threshold:
        description: 'ğŸ“Š Alert threshold (0.1-1.0)'
        required: false
        default: '0.3'
        type: string

env:
  TZ: Asia/Seoul
  PYTHONUNBUFFERED: 1
  EXECUTION_LOCK_FILE: "sentiment_alert_running.lock"

jobs:
  sentiment-alert:
    name: ğŸ“Š ê°ì„± ë°ì´í„° í†µí•© ì•Œë¦¼
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”’ Check Execution Status
        id: status_check
        run: |
          echo "ğŸ” ê°ì„± ì•Œë¦¼ ì‹¤í–‰ ìƒíƒœ ì²´í¬..."
          
          if [ -f "$EXECUTION_LOCK_FILE" ]; then
            lock_time=$(cat $EXECUTION_LOCK_FILE)
            current_time=$(date +%s)
            time_diff=$((current_time - lock_time))
            
            if [ $time_diff -gt 600 ]; then  # 10ë¶„ ì´ˆê³¼ì‹œ ë½ í•´ì œ
              echo "âš ï¸ ì˜¤ë˜ëœ ë½ íŒŒì¼ ì œê±° ($time_diffì´ˆ)"
              rm -f $EXECUTION_LOCK_FILE
              echo "can_execute=true" >> $GITHUB_OUTPUT
            else
              echo "â¸ï¸ ì´ì „ ì‹¤í–‰ ì§„í–‰ ì¤‘ ($time_diffì´ˆ)"
              echo "can_execute=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            echo "âœ… ì‹¤í–‰ ê°€ëŠ¥"
            echo "can_execute=true" >> $GITHUB_OUTPUT
          fi
          
          echo $(date +%s) > $EXECUTION_LOCK_FILE

      - name: ğŸ Setup Python 3.11
        if: steps.status_check.outputs.can_execute == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        if: steps.status_check.outputs.can_execute == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“Š Execute Sentiment Data Processing
        if: steps.status_check.outputs.can_execute == 'true'
        env:
          DISCORD_WEBHOOK_SENTIMENT: ${{ secrets.DISCORD_WEBHOOK_SENTIMENT }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          ALERT_THRESHOLD: ${{ github.event.inputs.alert_threshold || '0.3' }}
        run: |
          echo "ğŸ“Š ê°ì„± ë°ì´í„° ì²˜ë¦¬ ì‹œì‘..."
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ¯ ì²˜ë¦¬: 15ë¶„ê°„ ëˆ„ì ëœ ê°ì„± ë°ì´í„° í†µí•© ì•Œë¦¼"
          echo "ğŸ“ˆ ì„ê³„ê°’: $ALERT_THRESHOLD"
          
          # í”Œë˜ê·¸ ì„¤ì •
          debug_flag=""
          
          if [ "$DEBUG_MODE" = "true" ]; then
            debug_flag="--debug"
          fi
          
          # ê°ì„± ë°ì´í„° ì²˜ë¦¬ ë° ì•Œë¦¼
          python monitor_bugs.py --schedule 30min --threshold $ALERT_THRESHOLD $debug_flag
          
          echo "âœ… ê°ì„± ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ"

      - name: ğŸ“Š Processing Summary
        if: always() && steps.status_check.outputs.can_execute == 'true'
        run: |
          echo "ğŸ“Š ê°ì„± ì•Œë¦¼ ì²˜ë¦¬ ìš”ì•½:"
          echo "â° ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ¯ ëª¨ë“œ: 30ë¶„ ëˆ„ì  ê°ì„± ë°ì´í„° ì²˜ë¦¬"
          echo "ğŸ“ˆ ì„ê³„ê°’: ${{ github.event.inputs.alert_threshold || '0.3' }}"
          echo "ğŸ” ë””ë²„ê·¸: ${{ github.event.inputs.debug_mode || 'false' }}"
          
          # ê°ì„± ë°ì´í„° íŒŒì¼ í¬ê¸° í™•ì¸
          if [ -f "daily_sentiment_data.json" ]; then
            file_size=$(du -h daily_sentiment_data.json | cut -f1)
            echo "ğŸ’¾ ê°ì„± ë°ì´í„° íŒŒì¼: $file_size"
          fi

      - name: ğŸ”„ Commit Changes
        if: success() && steps.status_check.outputs.can_execute == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Epic7 Sentiment Alert v6.0"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add *.json *.html *.log 2>/dev/null || true
            git commit -m "ğŸ“Š Sentiment Alert v6.0: $(date '+%Y-%m-%d %H:%M:%S')" || true
            git push || echo "âš ï¸ Push failed - continuing..."
            echo "âœ… ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ"
          fi

      - name: ğŸ”“ Release Lock
        if: always() && steps.status_check.outputs.can_execute == 'true'
        run: |
          rm -f $EXECUTION_LOCK_FILE
          echo "âœ… ì‹¤í–‰ ë½ í•´ì œ ì™„ë£Œ"

  # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  failure-notification:
    name: ğŸš¨ ê°ì„± ì•Œë¦¼ ì‹¤íŒ¨ í†µì§€
    runs-on: ubuntu-latest
    needs: [sentiment-alert]
    if: failure()

    steps:
      - name: ğŸš¨ Send Failure Notification
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: |
          if [[ -n "$DISCORD_WEBHOOK_BUG" ]]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"embeds\": [{
                     \"title\": \"ğŸš¨ ê°ì„± ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤íŒ¨\",
                     \"description\": \"Epic7 ê°ì„± ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\",
                     \"color\": 15548997,
                     \"fields\": [
                       {
                         \"name\": \"â° ì‹¤íŒ¨ ì‹œê°„\",
                         \"value\": \"$(date '+%Y-%m-%d %H:%M:%S %Z')\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ¯ ì²˜ë¦¬ ëŒ€ìƒ\",
                         \"value\": \"30ë¶„ ëˆ„ì  ê°ì„± ë°ì´í„°\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"â° ë‹¤ìŒ ì‹¤í–‰\",
                         \"value\": \"$(date -d '+30 minutes' '+%H:%M')\",
                         \"inline\": true
                       }
                     ]
                   }]
                 }" \
                "$DISCORD_WEBHOOK_BUG"
          fi