name: Epic7 Monitor Debug
on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ'
        required: true
        default: 'full'
        type: choice
        options:
        - full        # ì „ì²´ í…ŒìŠ¤íŠ¸
        - quick       # ë¹ ë¥¸ í…ŒìŠ¤íŠ¸
        - discord     # Discordë§Œ í…ŒìŠ¤íŠ¸
        - crawler     # í¬ë¡¤ë§ë§Œ í…ŒìŠ¤íŠ¸

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Chrome and ChromeDriver
      if: github.event.inputs.test_mode == 'full' || github.event.inputs.test_mode == 'crawler'
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
        echo "Chrome ë²„ì „: $CHROME_VERSION (ì£¼ë²„ì „: $CHROME_MAJOR_VERSION)"
        
        sudo rm -f /usr/local/bin/chromedriver
        
        CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR_VERSION}" || echo "")
        if [ -z "$CHROMEDRIVER_VERSION" ] || [ "$CHROMEDRIVER_VERSION" = "Not Found" ]; then
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE" || echo "")
        fi
        if [ -z "$CHROMEDRIVER_VERSION" ]; then
          CHROMEDRIVER_VERSION="119.0.6045.105"
        fi
        
        echo "ì„ íƒëœ ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
        
        DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
        if wget -q --spider "$DOWNLOAD_URL"; then
          wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
          sudo unzip /tmp/chromedriver.zip -d /tmp/
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          echo "ChromeDriver ì„¤ì¹˜ ì™„ë£Œ: $(chromedriver --version 2>/dev/null || echo 'ë²„ì „ í™•ì¸ ì‹¤íŒ¨')"
        else
          echo "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ìš°ë¶„íˆ¬ íŒ¨í‚¤ì§€ ì‚¬ìš©"
          sudo apt-get install -y chromium-chromedriver
          sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
        fi
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: "ğŸ” Step 1: Environment Variables Check"
      env:
        DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
      run: |
        echo "================================================"
        echo "ğŸ” STEP 1: í™˜ê²½ë³€ìˆ˜ í™•ì¸"
        echo "================================================"
        
        echo "í™˜ê²½ë³€ìˆ˜ ìƒíƒœ:"
        if [ -n "$DISCORD_WEBHOOK_BUG" ]; then
          echo "âœ… DISCORD_WEBHOOK_BUG: ì„¤ì •ë¨ (ê¸¸ì´: ${#DISCORD_WEBHOOK_BUG})"
          echo "   ì‹œì‘: ${DISCORD_WEBHOOK_BUG:0:30}..."
        else
          echo "âŒ DISCORD_WEBHOOK_BUG: ì„¤ì •ë˜ì§€ ì•ŠìŒ"
        fi
        
        if [ -n "$DISCORD_WEBHOOK_REPORT" ]; then
          echo "âœ… DISCORD_WEBHOOK_REPORT: ì„¤ì •ë¨ (ê¸¸ì´: ${#DISCORD_WEBHOOK_REPORT})"
        else
          echo "âŒ DISCORD_WEBHOOK_REPORT: ì„¤ì •ë˜ì§€ ì•ŠìŒ"
        fi
        
        echo ""
        echo "Pythonì—ì„œ í™•ì¸:"
        python3 -c "
import os
webhook_bug = os.environ.get('DISCORD_WEBHOOK_BUG')
webhook_report = os.environ.get('DISCORD_WEBHOOK_REPORT')
print(f'DISCORD_WEBHOOK_BUG: {\"ì„¤ì •ë¨\" if webhook_bug else \"ì—†ìŒ\"}')
print(f'DISCORD_WEBHOOK_REPORT: {\"ì„¤ì •ë¨\" if webhook_report else \"ì—†ìŒ\"}')
if webhook_bug:
    print(f'ì›¹í›… URL í˜•ì‹ í™•ì¸: {\"ì˜¬ë°”ë¦„\" if webhook_bug.startswith(\"https://discord.com/api/webhooks/\") else \"ì˜ì‹¬ë¨\"}')
        "
    
    - name: "ğŸ“Š Step 2: Repository Status Check"
      run: |
        echo "================================================"
        echo "ğŸ“Š STEP 2: ë¦¬í¬ì§€í† ë¦¬ ìƒíƒœ í™•ì¸"
        echo "================================================"
        
        echo "íŒŒì¼ ì¡´ì¬ í™•ì¸:"
        for file in crawler.py monitor_bugs.py classifier.py notifier.py generate_report.py requirements.txt crawled_links.json; do
          if [ -f "$file" ]; then
            echo "âœ… $file ì¡´ì¬"
          else
            echo "âŒ $file ì—†ìŒ"
          fi
        done
        
        echo ""
        echo "crawled_links.json ë¶„ì„:"
        if [ -f "crawled_links.json" ]; then
          python3 -c "
import json
try:
    with open('crawled_links.json', 'r') as f:
        data = json.load(f)
    links = data.get('links', []) if isinstance(data, dict) else data
    print(f'ì´ ì €ì¥ëœ ë§í¬ ìˆ˜: {len(links)}')
    print(f'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {data.get(\"last_updated\", \"N/A\") if isinstance(data, dict) else \"N/A\"}')
    if links:
        print('ìµœê·¼ 5ê°œ ë§í¬:')
        for i, link in enumerate(links[-5:], 1):
            print(f'  {i}. {link[-50:]}')
    else:
        print('ì €ì¥ëœ ë§í¬ê°€ ì—†ìŒ')
except Exception as e:
    print(f'íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {e}')
          "
        else
          echo "âŒ crawled_links.json íŒŒì¼ì´ ì—†ìŒ"
        fi
        
        echo ""
        echo "Git ìƒíƒœ:"
        echo "- ë§ˆì§€ë§‰ ì»¤ë°‹: $(git log -1 --format='%h %s %cr')"
        echo "- í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
    
    - name: "ğŸ§ª Step 3: Module Import Test"
      run: |
        echo "================================================"
        echo "ğŸ§ª STEP 3: ëª¨ë“ˆ import í…ŒìŠ¤íŠ¸"
        echo "================================================"
        
        python3 -c "
import sys
modules_to_test = [
    ('crawler', ['crawl_arca_sites', 'crawl_global_sites', 'get_chrome_driver', 'fetch_stove_bug_board']),
    ('classifier', ['is_bug_post', 'is_positive_post', 'is_negative_post', 'classify_post']),
    ('notifier', ['send_bug_alert', 'send_daily_report']),
    ('monitor_bugs', ['main']),
    ('generate_report', ['main'])
]

all_success = True
for module_name, functions in modules_to_test:
    try:
        module = __import__(module_name)
        print(f'âœ… {module_name} ëª¨ë“ˆ import ì„±ê³µ')
        
        for func_name in functions:
            if hasattr(module, func_name):
                print(f'  âœ… {func_name} í•¨ìˆ˜ ì¡´ì¬')
            else:
                print(f'  âŒ {func_name} í•¨ìˆ˜ ì—†ìŒ')
                all_success = False
                
    except Exception as e:
        print(f'âŒ {module_name} ëª¨ë“ˆ import ì‹¤íŒ¨: {e}')
        all_success = False

if not all_success:
    print('\\nâŒ ì¼ë¶€ ëª¨ë“ˆ ë˜ëŠ” í•¨ìˆ˜ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.')
    sys.exit(1)
else:
    print('\\nâœ… ëª¨ë“  ëª¨ë“ˆê³¼ í•¨ìˆ˜ê°€ ì •ìƒì…ë‹ˆë‹¤.')
        "
    
    - name: "ğŸŒ Step 4: Network Connectivity Test"
      run: |
        echo "================================================"
        echo "ğŸŒ STEP 4: ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸"
        echo "================================================"
        
        python3 -c "
import requests
import time

urls_to_test = [
    ('ìŠ¤í† ë¸Œ ë©”ì¸', 'https://page.onstove.com'),
    ('ìŠ¤í† ë¸Œ Epic7', 'https://page.onstove.com/epicseven'),
    ('ìŠ¤í† ë¸Œ ë²„ê·¸ê²Œì‹œíŒ', 'https://page.onstove.com/epicseven/kr/list/1012'),
    ('Discord API', 'https://discord.com/api/v10/gateway')
]

for name, url in urls_to_test:
    try:
        start_time = time.time()
        response = requests.get(url, timeout=10, headers={
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        elapsed = time.time() - start_time
        
        if response.status_code == 200:
            print(f'âœ… {name}: ì •ìƒ (ì‘ë‹µì‹œê°„: {elapsed:.2f}ì´ˆ)')
        else:
            print(f'âš ï¸ {name}: ì‘ë‹µì½”ë“œ {response.status_code} (ì‘ë‹µì‹œê°„: {elapsed:.2f}ì´ˆ)')
            
    except Exception as e:
        print(f'âŒ {name}: ì—°ê²° ì‹¤íŒ¨ - {e}')
        "
    
    - name: "ğŸ”§ Step 5: Classifier Logic Test"
      run: |
        echo "================================================"
        echo "ğŸ”§ STEP 5: ë¶„ë¥˜ê¸° ë¡œì§ í…ŒìŠ¤íŠ¸"
        echo "================================================"
        
        python3 -c "
from classifier import is_bug_post, is_positive_post, is_negative_post, classify_post

test_cases = [
    ('ë²„ê·¸ ë°œìƒí–ˆì–´ìš”', True, False, False, 'ë²„ê·¸'),
    ('ì˜¤ë¥˜ê°€ ìˆë„¤ìš”', True, False, False, 'ë²„ê·¸'),
    ('ì—ëŸ¬ê°€ ë‚˜ìš”', True, False, False, 'ë²„ê·¸'),
    ('ë¬¸ì œ ìˆìŒ', True, False, False, 'ë²„ê·¸'),
    ('ì¢‹ì€ ì—…ë°ì´íŠ¸ì…ë‹ˆë‹¤', False, True, False, 'ê¸ì •'),
    ('ê°ì‚¬í•©ë‹ˆë‹¤', False, True, False, 'ê¸ì •'),
    ('ìµœê³ ì—ìš”', False, True, False, 'ê¸ì •'),
    ('ì‹¤ë§ì´ì—ìš”', False, False, True, 'ë¶€ì •'),
    ('ìµœì•…ì…ë‹ˆë‹¤', False, False, True, 'ë¶€ì •'),
    ('ì¼ë°˜ ê²Œì‹œê¸€ì…ë‹ˆë‹¤', False, False, False, 'ê¸°íƒ€'),
    ('ì•ˆë…•í•˜ì„¸ìš”', False, False, False, 'ê¸°íƒ€')
]

print('ë¶„ë¥˜ê¸° í…ŒìŠ¤íŠ¸ ê²°ê³¼:')
all_correct = True
for title, expected_bug, expected_pos, expected_neg, expected_class in test_cases:
    actual_bug = is_bug_post(title)
    actual_pos = is_positive_post(title)
    actual_neg = is_negative_post(title)
    actual_class = classify_post(title)
    
    bug_ok = actual_bug == expected_bug
    pos_ok = actual_pos == expected_pos
    neg_ok = actual_neg == expected_neg
    class_ok = actual_class == expected_class
    
    status = 'âœ…' if (bug_ok and pos_ok and neg_ok and class_ok) else 'âŒ'
    print(f'{status} \"{title}\"')
    print(f'    ë²„ê·¸: {actual_bug} (ì˜ˆìƒ: {expected_bug}) {\"âœ…\" if bug_ok else \"âŒ\"}')
    print(f'    ê¸ì •: {actual_pos} (ì˜ˆìƒ: {expected_pos}) {\"âœ…\" if pos_ok else \"âŒ\"}')
    print(f'    ë¶€ì •: {actual_neg} (ì˜ˆìƒ: {expected_neg}) {\"âœ…\" if neg_ok else \"âŒ\"}')
    print(f'    ë¶„ë¥˜: {actual_class} (ì˜ˆìƒ: {expected_class}) {\"âœ…\" if class_ok else \"âŒ\"}')
    print()
    
    if not (bug_ok and pos_ok and neg_ok and class_ok):
        all_correct = False

if all_correct:
    print('âœ… ëª¨ë“  ë¶„ë¥˜ê¸° í…ŒìŠ¤íŠ¸ í†µê³¼')
else:
    print('âŒ ì¼ë¶€ ë¶„ë¥˜ê¸° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨')
        "
    
    - name: "ğŸ¤– Step 6: Discord Test (Dry Run)"
      env:
        DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
      run: |
        echo "================================================"
        echo "ğŸ¤– STEP 6: Discord í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ì „ì†¡ ì—†ìŒ)"
        echo "================================================"
        
        python3 -c "
import os
import requests
import json

webhook_url = os.environ.get('DISCORD_WEBHOOK_BUG')

if not webhook_url:
    print('âŒ DISCORD_WEBHOOK_BUG í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ')
    exit(1)

print(f'âœ… ì›¹í›… URL í™•ì¸ë¨: {webhook_url[:50]}...')

# ì›¹í›… URL í˜•ì‹ ê²€ì¦
if not webhook_url.startswith('https://discord.com/api/webhooks/'):
    print('âš ï¸ ì›¹í›… URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤')
else:
    print('âœ… ì›¹í›… URL í˜•ì‹ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤')

# Discord API ì—°ê²° í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ë©”ì‹œì§€ ì „ì†¡ ì—†ìŒ)
try:
    # ì›¹í›… ì •ë³´ë§Œ í™•ì¸ (GET ìš”ì²­)
    response = requests.get(webhook_url, timeout=10)
    if response.status_code == 200:
        webhook_info = response.json()
        print(f'âœ… ì›¹í›… ì—°ê²° ì„±ê³µ')
        print(f'   ì„œë²„: {webhook_info.get(\"guild_id\", \"N/A\")}')
        print(f'   ì±„ë„: {webhook_info.get(\"channel_id\", \"N/A\")}')
        print(f'   ì´ë¦„: {webhook_info.get(\"name\", \"N/A\")}')
    else:
        print(f'âš ï¸ ì›¹í›… ì‘ë‹µ ì½”ë“œ: {response.status_code}')
        
except Exception as e:
    print(f'âŒ ì›¹í›… ì—°ê²° ì‹¤íŒ¨: {e}')
        "
    
    - name: "ğŸ•·ï¸ Step 7: Crawler Test (if requested)"
      if: github.event.inputs.test_mode == 'full' || github.event.inputs.test_mode == 'crawler'
      env:
        DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
      run: |
        echo "================================================"
        echo "ğŸ•·ï¸ STEP 7: í¬ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸"
        echo "================================================"
        
        echo "í˜„ì¬ crawled_links.json ë°±ì—… ì¤‘..."
        cp crawled_links.json crawled_links.backup.json
        
        echo "ë¹ˆ ë§í¬ íŒŒì¼ë¡œ êµì²´í•˜ì—¬ ëª¨ë“  ê²Œì‹œê¸€ì„ ìƒˆ ê²Œì‹œê¸€ë¡œ ì¸ì‹..."
        echo '{"links": [], "last_updated": "2025-01-01T00:00:00"}' > crawled_links.json
        
        echo "í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        python3 monitor_bugs.py --mode arca
        
        echo "ë°±ì—… ë³µì›..."
        mv crawled_links.backup.json crawled_links.json
        
        echo "âœ… í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
    
    - name: "ğŸ“¨ Step 8: Discord Webhook Live Test (if requested)"
      if: github.event.inputs.test_mode == 'full' || github.event.inputs.test_mode == 'discord'
      env:
        DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
      run: |
        echo "================================================"
        echo "ğŸ“¨ STEP 8: Discord ì›¹í›… ì‹¤ì œ ì „ì†¡ í…ŒìŠ¤íŠ¸"
        echo "================================================"
        
        python3 -c "
import os
from notifier import send_bug_alert
from datetime import datetime

webhook_url = os.environ.get('DISCORD_WEBHOOK_BUG')

if not webhook_url:
    print('âŒ DISCORD_WEBHOOK_BUG í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ')
    exit(1)

print('ğŸ“¨ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì¤‘...')

test_alerts = [
    {
        'title': 'ğŸ§ª í…ŒìŠ¤íŠ¸ ì•Œë¦¼ - ìŠ¤í† ë¸Œ ë²„ê·¸ê²Œì‹œíŒ',
        'url': 'https://github.com/actions/run/test',
        'timestamp': datetime.now().isoformat(),
        'source': 'stove_bug'
    },
    {
        'title': 'ğŸ” í…ŒìŠ¤íŠ¸ ì•Œë¦¼ - í‚¤ì›Œë“œ ê°ì§€',
        'url': 'https://github.com/actions/run/test',
        'timestamp': datetime.now().isoformat(),
        'source': 'keyword'
    }
]

try:
    send_bug_alert(webhook_url, test_alerts)
    print('âœ… í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ')
    print('Discord ì±„ë„ì„ í™•ì¸í•´ì£¼ì„¸ìš”!')
except Exception as e:
    print(f'âŒ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: {e}')
    import traceback
    traceback.print_exc()
        "
    
    - name: "ğŸ“‹ Step 9: Final Summary"
      run: |
        echo "================================================"
        echo "ğŸ“‹ STEP 9: ìµœì¢… ìš”ì•½"
        echo "================================================"
        
        echo "ğŸ¯ ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
        echo ""
        echo "í™•ì¸ ì‚¬í•­:"
        echo "1. âœ… í™˜ê²½ë³€ìˆ˜ ì„¤ì • ìƒíƒœ í™•ì¸ë¨"
        echo "2. âœ… ë¦¬í¬ì§€í† ë¦¬ íŒŒì¼ ìƒíƒœ í™•ì¸ë¨"
        echo "3. âœ… ëª¨ë“ˆ import í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        echo "4. âœ… ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        echo "5. âœ… ë¶„ë¥˜ê¸° ë¡œì§ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        echo "6. âœ… Discord ì›¹í›… ê²€ì¦ ì™„ë£Œ"
        if [ "${{ github.event.inputs.test_mode }}" = "full" ] || [ "${{ github.event.inputs.test_mode }}" = "crawler" ]; then
          echo "7. âœ… í¬ë¡¤ë§ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        fi
        if [ "${{ github.event.inputs.test_mode }}" = "full" ] || [ "${{ github.event.inputs.test_mode }}" = "discord" ]; then
          echo "8. âœ… Discord ì‹¤ì œ ì „ì†¡ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        fi
        
        echo ""
        echo "ğŸ“§ Discord ì±„ë„ì—ì„œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!"
        echo "ğŸ” ê° ë‹¨ê³„ì˜ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œì ì„ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    
    - name: Upload debug artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debug-logs-${{ github.run_number }}
        path: |
          *.html
          *.json
          *.log
        retention-days: 7
