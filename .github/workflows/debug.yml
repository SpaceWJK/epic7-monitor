name: ğŸ› Epic7 Debug & Testing (Optimized v3.1)

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'Debug level (basic/full/system)'
        required: false
        default: 'basic'
        type: choice
        options:
        - basic
        - full
        - system
      test_mode:
        description: 'Test specific component'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - crawler
        - classifier
        - notifier
        - korean_sites
        - global_sites
        - translation
      force_crawl:
        description: 'Force crawl (ignore duplicates)'
        required: false
        default: 'false'
        type: boolean
      reuse_environment:
        description: 'Reuse existing Chrome/Python environment'
        required: false
        default: 'true'
        type: boolean

env:
  TZ: Asia/Seoul
  PYTHONUNBUFFERED: 1
  DEBUG_LEVEL: ${{ github.event.inputs.debug_level || 'basic' }}
  TEST_MODE: ${{ github.event.inputs.test_mode || 'all' }}
  FORCE_CRAWL: ${{ github.event.inputs.force_crawl || 'false' }}
  REUSE_ENVIRONMENT: ${{ github.event.inputs.reuse_environment || 'true' }}

jobs:
  debug-test-optimized:
    name: ğŸ” Debug & Test (Optimized)
    runs-on: ubuntu-latest
    timeout-minutes: 45  # 60ë¶„ â†’ 45ë¶„ìœ¼ë¡œ ë‹¨ì¶•
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ”„ Sync with Remote
        run: |
          echo "ğŸ”„ Syncing with remote repository..."
          git fetch origin main
          git rebase origin/main || git merge origin/main
          echo "âœ… Repository synchronized"

      - name: ğŸ Setup Python Environment (Optimized)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸŒ Smart Chrome Installation
        id: chrome_setup
        run: |
          echo "ğŸŒ Smart Chrome installation process..."
          
          # ê¸°ì¡´ Chrome ì„¤ì¹˜ í™•ì¸
          if command -v google-chrome &> /dev/null && [ "$REUSE_ENVIRONMENT" = "true" ]; then
            echo "âœ… Chrome already installed: $(google-chrome --version)"
            CHROME_INSTALLED=true
          else
            echo "ğŸ“¦ Installing Chrome and ChromeDriver..."
            
            # Chrome ì„¤ì¹˜
            wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
            sudo apt-get update
            sudo apt-get install -y google-chrome-stable
            
            # ChromeDriver ì„¤ì¹˜ (ìµœì í™”ëœ ë‹¨ì¼ ë°©ë²•)
            CHROME_VERSION=$(google-chrome --version | grep -oE "[0-9]+\.[0-9]+\.[0-9]+")
            CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
            
            echo "Chrome version: $CHROME_VERSION (Major: $CHROME_MAJOR_VERSION)"
            
            # Chrome for Testing API ì‚¬ìš© (ê°€ì¥ ì•ˆì •ì )
            wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROME_VERSION/linux64/chromedriver-linux64.zip"
            unzip -q chromedriver-linux64.zip
            sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/chromedriver
            
            # ì„¤ì¹˜ í™•ì¸
            chromedriver --version
            CHROME_INSTALLED=true
          fi
          
          echo "CHROME_INSTALLED=$CHROME_INSTALLED" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Optimized Dependencies Installation
        run: |
          echo "ğŸ“¦ Installing optimized dependencies..."
          
          # ê¸°ë³¸ íŒ¨í‚¤ì§€ ì—…ê·¸ë ˆì´ë“œ
          python -m pip install --upgrade pip --quiet
          
          # ì¡°ê±´ë¶€ requirements.txt ì„¤ì¹˜
          if [ -f "requirements.txt" ]; then
            echo "ğŸ“‹ Installing from requirements.txt..."
            pip install -r requirements.txt --quiet
          else
            echo "ğŸ“‹ Installing essential packages..."
            pip install --quiet \
              requests \
              beautifulsoup4 \
              selenium \
              lxml \
              deep-translator \
              python-dateutil \
              psutil
          fi
          
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ§ª Python Module Import Test
        run: |
          echo "ğŸ§ª Testing Python module imports..."
          
          # í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸
          python -c "import sys, os, json, re, time, random, logging, datetime; print('âœ… Standard libraries OK')"
          
          # ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸
          python -c "import requests, bs4, selenium, lxml; print('âœ… External libraries OK')"
          
          # í”„ë¡œì íŠ¸ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸ (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
          test_modules=("config" "utils" "file_manager" "crawler" "classifier" "notifier")
          
          for module in "${test_modules[@]}"; do
            if [ -f "${module}.py" ]; then
              if python -c "import $module" 2>/dev/null; then
                echo "âœ… $module.py import successful"
              else
                echo "âŒ $module.py import failed"
              fi
            else
              echo "âš ï¸ $module.py not found"
            fi
          done

      - name: ğŸŒ Network Connectivity Test
        run: |
          echo "ğŸŒ Testing network connectivity..."
          
          sites=(
            "https://google.com"
            "https://page.onstove.com"
            "https://cafe.naver.com"
            "https://www.reddit.com"
            "https://discord.com"
          )
          
          for site in "${sites[@]}"; do
            if curl -s --head "$site" | head -n 1 | grep -q "200 OK"; then
              echo "âœ… $site - OK"
            else
              echo "âŒ $site - Failed"
            fi
          done

      - name: ğŸš— Selenium Driver Test
        if: steps.chrome_setup.outputs.CHROME_INSTALLED == 'true'
        run: |
          echo "ğŸš— Testing Selenium Chrome driver..."
          
          python -c "
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          
          options = Options()
          options.add_argument('--headless')
          options.add_argument('--no-sandbox')
          options.add_argument('--disable-dev-shm-usage')
          
          try:
              driver = webdriver.Chrome(options=options)
              driver.get('https://google.com')
              title = driver.title
              driver.quit()
              print(f'âœ… Selenium test successful: {title}')
          except Exception as e:
              print(f'âŒ Selenium test failed: {e}')
          "

      - name: ğŸ‡°ğŸ‡· Korean Sites Test
        if: contains(env.TEST_MODE, 'korean_sites') || env.TEST_MODE == 'all'
        run: |
          echo "ğŸ‡°ğŸ‡· Testing Korean sites access..."
          
          # í•œêµ­ ì‚¬ì´íŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
          korean_sites=(
            "https://page.onstove.com/epicseven/kr"
            "https://cafe.naver.com/epic7"
          )
          
          for site in "${korean_sites[@]}"; do
            if curl -s --head "$site" | head -n 1 | grep -q "200\|301\|302"; then
              echo "âœ… $site - Accessible"
            else
              echo "âŒ $site - Not accessible"
            fi
          done

      - name: ğŸŒ Global Sites Test
        if: contains(env.TEST_MODE, 'global_sites') || env.TEST_MODE == 'all'
        run: |
          echo "ğŸŒ Testing global sites access..."
          
          # ê¸€ë¡œë²Œ ì‚¬ì´íŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
          global_sites=(
            "https://page.onstove.com/epicseven/global"
            "https://www.reddit.com/r/EpicSeven/"
          )
          
          for site in "${global_sites[@]}"; do
            if curl -s --head "$site" | head -n 1 | grep -q "200\|301\|302"; then
              echo "âœ… $site - Accessible"
            else
              echo "âŒ $site - Not accessible"
            fi
          done

      - name: ğŸ”¤ Translation Test
        if: contains(env.TEST_MODE, 'translation') || env.TEST_MODE == 'all'
        run: |
          echo "ğŸ”¤ Testing translation functionality..."
          
          python -c "
          from deep_translator import GoogleTranslator
          
          try:
              translator = GoogleTranslator(source='en', target='ko')
              result = translator.translate('Hello Epic Seven')
              print(f'âœ… Translation test successful: {result}')
          except Exception as e:
              print(f'âŒ Translation test failed: {e}')
          "

      - name: ğŸ§© Component Tests
        if: env.TEST_MODE != 'all'
        run: |
          echo "ğŸ§© Running component-specific tests..."
          
          case "$TEST_MODE" in
            "crawler")
              echo "ğŸ•·ï¸ Testing crawler component..."
              if [ -f "crawler.py" ]; then
                python -c "
                import crawler
                print('âœ… Crawler module loaded successfully')
                # ì—¬ê¸°ì— crawler íŠ¹ì • í…ŒìŠ¤íŠ¸ ì¶”ê°€
                "
              else
                echo "âŒ crawler.py not found"
              fi
              ;;
            "classifier")
              echo "ğŸ§  Testing classifier component..."
              if [ -f "classifier.py" ]; then
                python -c "
                import classifier
                print('âœ… Classifier module loaded successfully')
                # ì—¬ê¸°ì— classifier íŠ¹ì • í…ŒìŠ¤íŠ¸ ì¶”ê°€
                "
              else
                echo "âŒ classifier.py not found"
              fi
              ;;
            "notifier")
              echo "ğŸ”” Testing notifier component..."
              if [ -f "notifier.py" ]; then
                python -c "
                import notifier
                print('âœ… Notifier module loaded successfully')
                # ì—¬ê¸°ì— notifier íŠ¹ì • í…ŒìŠ¤íŠ¸ ì¶”ê°€
                "
              else
                echo "âŒ notifier.py not found"
              fi
              ;;
          esac

      - name: ğŸ”§ System Integration Test
        if: env.TEST_MODE == 'all'
        run: |
          echo "ğŸ”§ Running system integration test..."
          
          # monitor_bugs.py ì‹¤í–‰ í…ŒìŠ¤íŠ¸
          if [ -f "monitor_bugs.py" ]; then
            echo "ğŸš€ Testing monitor_bugs.py..."
            
            # í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹¤í–‰
            python monitor_bugs.py \
              --mode all \
              --debug true \
              --test true || echo "âš ï¸ Integration test completed with warnings"
          else
            echo "âš ï¸ monitor_bugs.py not found - skipping integration test"
          fi

      - name: ğŸ“Š System Resource Analysis
        run: |
          echo "ğŸ“Š Analyzing system resources..."
          
          # ì‹œìŠ¤í…œ ì •ë³´
          echo "ğŸ–¥ï¸ System Information:"
          uname -a
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
          echo "ğŸ’¾ Memory Usage:"
          free -h
          
          # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
          echo "ğŸ’¿ Disk Usage:"
          df -h
          
          # í”„ë¡œì„¸ìŠ¤ ì •ë³´
          echo "âš™ï¸ Process Information:"
          ps aux --sort=-%mem | head -10
          
          # ë²„ì „ ì •ë³´
          echo "ğŸ“‹ Version Information:"
          python --version
          pip --version
          [ -f "/usr/local/bin/chromedriver" ] && chromedriver --version || echo "ChromeDriver not found"
          google-chrome --version 2>/dev/null || echo "Chrome not found"

      - name: ğŸ“ Generate Debug Report
        run: |
          echo "ğŸ“ Generating debug report..."
          
          cat > debug_report.md << 'EOF'
          # ğŸ› Epic7 Debug Report
          
          **ìƒì„± ì‹œê°„:** $(date '+%Y-%m-%d %H:%M:%S %Z')
          **Debug Level:** ${{ env.DEBUG_LEVEL }}
          **Test Mode:** ${{ env.TEST_MODE }}
          **Force Crawl:** ${{ env.FORCE_CRAWL }}
          **Reuse Environment:** ${{ env.REUSE_ENVIRONMENT }}
          
          ## ğŸ–¥ï¸ ì‹œìŠ¤í…œ ì •ë³´
          - **OS:** $(uname -s) $(uname -r)
          - **Python:** $(python --version)
          - **Chrome:** $(google-chrome --version 2>/dev/null || echo "Not installed")
          - **ChromeDriver:** $(chromedriver --version 2>/dev/null || echo "Not installed")
          
          ## ğŸ“Š ë¦¬ì†ŒìŠ¤ ìƒíƒœ
          - **ë©”ëª¨ë¦¬:** $(free -h | grep Mem | awk '{print $3 "/" $2}')
          - **ë””ìŠ¤í¬:** $(df -h . | tail -1 | awk '{print $3 "/" $2 " (" $5 ")"}')
          
          ## ğŸ“ íŒŒì¼ í˜„í™©
          ```
          $(find . -name "*.py" -o -name "*.json" -o -name "*.yml" | head -20)
          ```
          
          ## ğŸ”§ í…ŒìŠ¤íŠ¸ ê²°ê³¼
          - **Python ëª¨ë“ˆ:** $(python -c "import sys; print('âœ… OK')" 2>/dev/null || echo "âŒ Error")
          - **ë„¤íŠ¸ì›Œí¬:** $(curl -s --head https://google.com | head -n 1 | grep -q "200" && echo "âœ… OK" || echo "âŒ Error")
          - **Selenium:** $([ -f "/usr/local/bin/chromedriver" ] && echo "âœ… OK" || echo "âŒ Error")
          
          ---
          **ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ:** $(date '+%Y-%m-%d %H:%M:%S %Z')
          EOF
          
          # í™˜ê²½ ë³€ìˆ˜ ì¹˜í™˜
          envsubst < debug_report.md > debug_report_final.md
          mv debug_report_final.md debug_report.md
          
          echo "âœ… Debug report generated successfully"

      - name: ğŸ“¤ Upload Debug Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts-${{ github.run_id }}
          path: |
            debug_report.md
            *.json
            *.log
            debug*.html
          retention-days: 7

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up temporary files..."
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/chromedriver*.zip 2>/dev/null || true
          rm -rf /tmp/chromedriver-linux64 2>/dev/null || true
          
          echo "âœ… Cleanup completed"

      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo "ğŸ“‹ Debug & Test Summary:"
          echo "- Debug Level: ${{ env.DEBUG_LEVEL }}"
          echo "- Test Mode: ${{ env.TEST_MODE }}"
          echo "- Status: ${{ job.status }}"
          echo "- Duration: ${{ job.duration || 'N/A' }}"
          echo "âœ… Debug workflow completed"
