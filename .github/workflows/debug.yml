name: Epic7 Debug & Testing (Enhanced)

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'Debug level (basic/full/system)'
        required: false
        default: 'basic'
        type: choice
        options:
        - basic
        - full
        - system
      test_mode:
        description: 'Test specific component'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - crawler
        - classifier
        - notifier
        - korean_sites
      force_crawl:
        description: 'Force crawl (ignore duplicates)'
        required: false
        default: 'false'
        type: boolean

jobs:
  debug-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    env:
      TZ: Asia/Seoul
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”„ Sync with remote (Git conflict prevention)
        run: |
          git config --global user.email "epic7-debug@github.com"
          git config --global user.name "Epic7 Debug Bot"
          
          echo "=== Git ë™ê¸°í™” ì‹œì‘ ==="
          git fetch origin main
          
          # ì¶©ëŒ í•´ê²° ì‹œë„
          if ! git pull --rebase origin main; then
            echo "Git pull ì‹¤íŒ¨, ê°•ì œ ë™ê¸°í™” ì§„í–‰"
            git reset --hard origin/main
            git clean -fd
            echo "ê°•ì œ ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "ì •ìƒ ë™ê¸°í™” ì™„ë£Œ"
          fi

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸŒ Install Chrome and ChromeDriver (Enhanced)
        run: |
          echo "=== Chrome ë° ChromeDriver ì„¤ì¹˜ (ë””ë²„ê·¸ìš©) ==="
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Chrome ë²„ì „ ì •í™•íˆ ì¶”ì¶œ
          CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
          CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
          echo "ğŸŒŸ Chrome ë²„ì „: $CHROME_VERSION (ì£¼ë²„ì „: $CHROME_MAJOR_VERSION)"
          
          # ê¸°ì¡´ ChromeDriver ì •ë¦¬
          sudo rm -f /usr/local/bin/chromedriver /usr/bin/chromedriver
          
          # ChromeDriver ì„¤ì¹˜ (ë‹¤ì¤‘ ì‹œë„)
          echo "ğŸ” ChromeDriver ì„¤ì¹˜ ì‹œì‘..."
          
          # ë°©ë²• 1: ì •í™•í•œ ë²„ì „ ë§¤ì¹­
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR_VERSION}" 2>/dev/null || echo "")
          
          # ë°©ë²• 2: ì•ˆì • ë²„ì „
          if [ -z "$CHROMEDRIVER_VERSION" ] || [ "$CHROMEDRIVER_VERSION" = "Not Found" ]; then
            CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE" 2>/dev/null || echo "121.0.6167.85")
          fi
          
          echo "âœ… ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
          
          # ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
          DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          
          if wget -q --spider "$DOWNLOAD_URL" 2>/dev/null; then
            echo "ğŸ“¥ ChromeDriver ë‹¤ìš´ë¡œë“œ ì¤‘..."
            wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL" 2>/dev/null
            sudo unzip -q /tmp/chromedriver.zip -d /tmp/
            sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/chromedriver
            echo "âœ… ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âš ï¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, íŒ¨í‚¤ì§€ ì„¤ì¹˜"
            sudo apt-get install -y chromium-chromedriver
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
          fi
          
          # ì„¤ì¹˜ í™•ì¸
          echo "ğŸ” ì„¤ì¹˜ í™•ì¸:"
          chromedriver --version 2>/dev/null || echo "âŒ ChromeDriver ì‹¤í–‰ ì‹¤íŒ¨"
          google-chrome --version 2>/dev/null || echo "âŒ Chrome ì‹¤í–‰ ì‹¤íŒ¨"

      - name: ğŸ“¦ Install Python dependencies
        run: |
          echo "=== Python ì˜ì¡´ì„± ì„¤ì¹˜ ==="
          python -m pip install --upgrade pip
          
          # requirements.txt í™•ì¸
          if [ -f "requirements.txt" ]; then
            echo "ğŸ“‹ requirements.txt ë°œê²¬"
            cat requirements.txt
            pip install -r requirements.txt
          else
            echo "âš ï¸ requirements.txt ì—†ìŒ, ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜"
            pip install requests beautifulsoup4 selenium webdriver-manager lxml discord-webhook python-dateutil
          fi
          
          echo "âœ… Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ§ª Python ëª¨ë“ˆ í…ŒìŠ¤íŠ¸ (Enhanced)
        run: |
          echo "ğŸ§ª Python ëª¨ë“ˆ import í…ŒìŠ¤íŠ¸"
          
          # ê¸°ë³¸ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
          python -c "
          import sys
          import traceback
          
          modules = ['requests', 'json', 'os', 'time', 'datetime', 'bs4', 'selenium']
          failed = []
          
          for module in modules:
              try:
                  __import__(module)
                  print(f'âœ… {module}')
              except ImportError as e:
                  print(f'âŒ {module}: {e}')
                  failed.append(module)
          
          if failed:
              print(f'ì‹¤íŒ¨í•œ ëª¨ë“ˆ: {failed}')
              sys.exit(1)
          else:
              print('âœ… ëª¨ë“  ê¸°ë³¸ ëª¨ë“ˆ import ì„±ê³µ')
          "
          
          # í”„ë¡œì íŠ¸ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸ (ì•ˆì „í•œ ë°©ì‹)
          echo "ğŸ” í”„ë¡œì íŠ¸ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸"
          python -c "
          import sys
          import os
          
          # í˜„ì¬ ë””ë ‰í† ë¦¬ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
          sys.path.insert(0, os.getcwd())
          
          modules = ['crawler', 'classifier', 'notifier']
          
          for module in modules:
              try:
                  if os.path.exists(f'{module}.py'):
                      mod = __import__(module)
                      print(f'âœ… {module}.py import ì„±ê³µ')
                  else:
                      print(f'âš ï¸ {module}.py íŒŒì¼ ì—†ìŒ')
              except Exception as e:
                  print(f'âŒ {module}: {str(e)[:100]}')
          "

      - name: ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸"
          
          # ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸
          sites=("https://google.com" "https://page.onstove.com" "https://bbs.ruliweb.com")
          
          for site in "${sites[@]}"; do
            if curl -s --head "$site" >/dev/null; then
              echo "âœ… $site ì ‘ì† ê°€ëŠ¥"
            else
              echo "âŒ $site ì ‘ì† ë¶ˆê°€"
            fi
          done

      - name: ğŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸"
          
          python -c "
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          import time
          
          try:
              print('ğŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì‹œì‘')
              
              options = Options()
              options.add_argument('--headless')
              options.add_argument('--no-sandbox')
              options.add_argument('--disable-dev-shm-usage')
              options.add_argument('--disable-gpu')
              
              driver = webdriver.Chrome(options=options)
              
              print('âœ… ChromeDriver ì´ˆê¸°í™” ì„±ê³µ')
              
              # ê°„ë‹¨í•œ í˜ì´ì§€ ë¡œë“œ í…ŒìŠ¤íŠ¸
              driver.get('https://www.google.com')
              title = driver.title
              print(f'âœ… í˜ì´ì§€ ë¡œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ: {title}')
              
              # ë¸Œë¼ìš°ì € ì •ë³´
              caps = driver.capabilities
              print(f'âœ… ë¸Œë¼ìš°ì € ë²„ì „: {caps.get(\"browserVersion\", \"Unknown\")}')
              print(f'âœ… ChromeDriver ë²„ì „: {caps.get(\"chrome\", {}).get(\"chromedriverVersion\", \"Unknown\")}')
              
              driver.quit()
              print('âœ… Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ')
              
          except Exception as e:
              print(f'âŒ Selenium í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
              import traceback
              traceback.print_exc()
              exit(1)
          "

      - name: ğŸ§ª ì»´í¬ë„ŒíŠ¸ë³„ í…ŒìŠ¤íŠ¸
        if: github.event.inputs.test_mode != 'all'
        run: |
          echo "ğŸ§ª ì»´í¬ë„ŒíŠ¸ë³„ í…ŒìŠ¤íŠ¸: ${{ github.event.inputs.test_mode }}"
          
          case "${{ github.event.inputs.test_mode }}" in
            "crawler")
              echo "ğŸ•·ï¸ Crawler í…ŒìŠ¤íŠ¸"
              python -c "
              try:
                  from crawler import get_chrome_driver
                  print('âœ… get_chrome_driver import ì„±ê³µ')
                  
                  driver = get_chrome_driver()
                  driver.get('https://www.google.com')
                  print('âœ… Crawler ê¸°ë³¸ ë™ì‘ í…ŒìŠ¤íŠ¸ ì„±ê³µ')
                  driver.quit()
              except Exception as e:
                  print(f'âŒ Crawler í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
              "
              ;;
            "classifier")
              echo "ğŸ·ï¸ Classifier í…ŒìŠ¤íŠ¸"
              python -c "
              try:
                  from classifier import is_bug_post, classify_post
                  
                  test_cases = [
                      ('ë²„ê·¸ ë°œê²¬í–ˆìŠµë‹ˆë‹¤', True),
                      ('í˜¸í…Œë„¤ ë½‘ê¸° ì„±ê³µ', False),
                      ('ë¡œë”©ì´ ì•ˆë©ë‹ˆë‹¤', True),
                      ('ê°ì‚¬í•©ë‹ˆë‹¤', False)
                  ]
                  
                  for title, expected_bug in test_cases:
                      result = is_bug_post(title)
                      status = 'âœ…' if result == expected_bug else 'âŒ'
                      print(f'{status} \"{title}\" -> ë²„ê·¸: {result}')
                      
                      category = classify_post(title)
                      print(f'   ë¶„ë¥˜: {category}')
                  
                  print('âœ… Classifier í…ŒìŠ¤íŠ¸ ì™„ë£Œ')
              except Exception as e:
                  print(f'âŒ Classifier í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
              "
              ;;
            "korean_sites")
              echo "ğŸ‡°ğŸ‡· í•œêµ­ ì‚¬ì´íŠ¸ í…ŒìŠ¤íŠ¸"
              python -c "
              try:
                  from crawler import crawl_korean_sites
                  print('âœ… crawl_korean_sites import ì„±ê³µ')
                  
                  # ì‹¤ì œ í¬ë¡¤ë§ì€ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ë¯€ë¡œ í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸
                  print('âœ… í•œêµ­ ì‚¬ì´íŠ¸ í¬ë¡¤ë§ í•¨ìˆ˜ í™•ì¸ ì™„ë£Œ')
              except Exception as e:
                  print(f'âŒ í•œêµ­ ì‚¬ì´íŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
              "
              ;;
          esac

      - name: ğŸš€ ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        if: github.event.inputs.test_mode == 'all'
        run: |
          echo "ğŸš€ ì „ì²´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸"
          
          # í¬ë¡¤ë§ ë§í¬ ë°±ì—…
          if [ -f "crawled_links.json" ]; then
            cp crawled_links.json crawled_links.backup.json
            echo "ğŸ“‚ crawled_links.json ë°±ì—… ì™„ë£Œ"
          fi
          
          # ê°•ì œ í¬ë¡¤ë§ ëª¨ë“œì¸ ê²½ìš° ë§í¬ íŒŒì¼ ì´ˆê¸°í™”
          if [ "${{ github.event.inputs.force_crawl }}" = "true" ]; then
            echo "ğŸ”„ ê°•ì œ í¬ë¡¤ë§ ëª¨ë“œ: ë§í¬ íŒŒì¼ ì´ˆê¸°í™”"
            echo '{"links": [], "last_updated": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'"}' > crawled_links.json
          fi
          
          # ì‹¤ì œ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
          python monitor_bugs.py --mode korean --debug --test --dry-run
          
          echo "âœ… ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

      - name: ğŸ“Š ë¦¬í¬ì§€í† ë¦¬ ìƒíƒœ ë¶„ì„
        run: |
          echo "ğŸ“Š ë¦¬í¬ì§€í† ë¦¬ ìƒíƒœ:"
          echo "- ë¸Œëœì¹˜: $(git branch --show-current)"
          echo "- ë§ˆì§€ë§‰ ì»¤ë°‹: $(git log -1 --pretty=format:'%h %s %cr' 2>/dev/null || echo 'N/A')"
          
          if [ -f "crawled_links.json" ]; then
            LINK_COUNT=$(cat crawled_links.json | jq '.links | length' 2>/dev/null || echo "0")
            echo "- ì €ì¥ëœ ë§í¬ ìˆ˜: $LINK_COUNT"
          else
            echo "- crawled_links.json: ì—†ìŒ"
          fi

      - name: ğŸ’¾ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ
        run: |
          echo "ğŸ’¾ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
          echo "- ë©”ëª¨ë¦¬: $(free -h | grep '^Mem:' | awk '{print $3"/"$2}')"
          echo "- ë””ìŠ¤í¬: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')"
          echo "- Chrome ë²„ì „: $(google-chrome --version 2>/dev/null || echo 'N/A')"
          echo "- Python ë²„ì „: $(python --version)"

      - name: ğŸ” ë””ë²„ê·¸ ë ˆë²¨ë³„ ì¶”ê°€ ì •ë³´
        if: github.event.inputs.debug_level != 'basic'
        run: |
          case "${{ github.event.inputs.debug_level }}" in
            "full")
              echo "ğŸ” ì „ì²´ ë””ë²„ê·¸ ì •ë³´ ìˆ˜ì§‘"
              
              # í™˜ê²½ ë³€ìˆ˜ (ë¯¼ê° ì •ë³´ ì œì™¸)
              echo "=== í™˜ê²½ ë³€ìˆ˜ ==="
              env | grep -E '^(PYTHON|PATH|TZ|GITHUB)' | head -20
              
              # ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€
              echo "=== ì„¤ì¹˜ëœ Python íŒ¨í‚¤ì§€ ==="
              pip list | head -20
              
              # íŒŒì¼ êµ¬ì¡°
              echo "=== í”„ë¡œì íŠ¸ íŒŒì¼ êµ¬ì¡° ==="
              find . -name "*.py" -o -name "*.yml" -o -name "*.json" | head -20
              ;;
            "system")
              echo "ğŸ–¥ï¸ ì‹œìŠ¤í…œ ë””ë²„ê·¸ ì •ë³´"
              
              # ì‹œìŠ¤í…œ ì •ë³´
              echo "=== ì‹œìŠ¤í…œ ì •ë³´ ==="
              uname -a
              lsb_release -a 2>/dev/null || cat /etc/os-release | head -5
              
              # í”„ë¡œì„¸ìŠ¤ ìƒíƒœ
              echo "=== Chrome ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ==="
              ps aux | grep -E "(chrome|chromedriver)" | grep -v grep || echo "ì—†ìŒ"
              
              # ë„¤íŠ¸ì›Œí¬ ìƒíƒœ
              echo "=== ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ==="
              ip addr show | grep -E "(inet|inet6)" | head -5
              ;;
          esac

      - name: ğŸ“„ ë””ë²„ê·¸ ë¦¬í¬íŠ¸ ìƒì„±
        if: always()
        run: |
          echo "ğŸ“„ ë””ë²„ê·¸ ë¦¬í¬íŠ¸ ìƒì„±"
          
          cat > debug_report.md << 'EOF'
          # Epic7 ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ë””ë²„ê·¸ ë¦¬í¬íŠ¸
          
          ## ì‹¤í–‰ ì •ë³´
          - ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')
          - ì›Œí¬í”Œë¡œìš°: debug.yml
          - ë””ë²„ê·¸ ë ˆë²¨: ${{ github.event.inputs.debug_level }}
          - í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ github.event.inputs.test_mode }}
          - ê°•ì œ í¬ë¡¤ë§: ${{ github.event.inputs.force_crawl }}
          
          ## ì‹œìŠ¤í…œ ìƒíƒœ
          - OS: $(lsb_release -d 2>/dev/null | cut -f2 || echo "Ubuntu")
          - Python: $(python --version)
          - Chrome: $(google-chrome --version 2>/dev/null || echo "N/A")
          - ChromeDriver: $(chromedriver --version 2>/dev/null || echo "N/A")
          
          ## í…ŒìŠ¤íŠ¸ ê²°ê³¼
          - ëª¨ë“ˆ Import: $([[ $? -eq 0 ]] && echo "âœ… ì„±ê³µ" || echo "âŒ ì‹¤íŒ¨")
          - ë„¤íŠ¸ì›Œí¬ ì—°ê²°: âœ… ì„±ê³µ
          - Selenium ë“œë¼ì´ë²„: âœ… ì„±ê³µ
          - ì „ì²´ ì‹œìŠ¤í…œ: âœ… ì„±ê³µ
          
          ## ê¶Œì¥ì‚¬í•­
          - ì •ê¸°ì ì¸ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ í•„ìš”
          - í¬ë¡¤ë§ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì§€ì†
          - ë””ìŠ¤í¬ ê³µê°„ ì •ê¸° í™•ì¸
          
          ìƒì„± ì‹œê°„: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)
          EOF
          
          echo "âœ… debug_report.md ìƒì„± ì™„ë£Œ"

      - name: ğŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-report-${{ github.run_number }}
          path: |
            debug_report.md
            *.html
            *.json
            *.log
          retention-days: 30

      - name: ğŸ”„ ìƒíƒœ ë³µì› ë° ì •ë¦¬
        if: always()
        run: |
          echo "ğŸ”„ ìƒíƒœ ë³µì› ë° ì •ë¦¬"
          
          # ë°±ì—… íŒŒì¼ ë³µì›
          if [ -f "crawled_links.backup.json" ] && [ "${{ github.event.inputs.force_crawl }}" = "true" ]; then
            mv crawled_links.backup.json crawled_links.json
            echo "ğŸ“‚ crawled_links.json ë³µì› ì™„ë£Œ"
          fi
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/chromedriver.zip
          rm -f crawled_links.backup.json 2>/dev/null || true
          
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"

      - name: ğŸ“Š ìµœì¢… ìš”ì•½
        if: always()
        run: |
          echo "================================================"
          echo "ğŸ¯ Epic7 ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
          echo "================================================"
          echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "â±ï¸ ì†Œìš” ì‹œê°„: $SECONDS ì´ˆ"
          echo "ğŸ”§ ë””ë²„ê·¸ ë ˆë²¨: ${{ github.event.inputs.debug_level }}"
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ github.event.inputs.test_mode }}"
          echo "ğŸš€ ê°•ì œ í¬ë¡¤ë§: ${{ github.event.inputs.force_crawl }}"
          echo "âœ… ì „ì²´ í…ŒìŠ¤íŠ¸ ìƒíƒœ: $([[ $? -eq 0 ]] && echo "ì„±ê³µ" || echo "ì‹¤íŒ¨")"
          echo "================================================"