name: Epic Seven Monitor Health Check

on:
  schedule:
    - cron: "0 */6 * * *"  # 6ì‹œê°„ë§ˆë‹¤
  workflow_dispatch:
    inputs:
      full_check:
        description: 'Run full system check'
        required: false
        default: 'false'
        type: boolean

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸŒ Install Chrome and ChromeDriver (Optimized)
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Chrome ë²„ì „ í™•ì¸
          CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
          CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
          echo "ğŸŒŸ Chrome ë²„ì „: $CHROME_VERSION (ì£¼ë²„ì „: $CHROME_MAJOR_VERSION)"
          
          # ê¸°ì¡´ ChromeDriver ì œê±°
          sudo rm -f /usr/local/bin/chromedriver
          
          # ChromeDriver ì„¤ì¹˜ (ì•ˆì • ë²„ì „)
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR_VERSION}" || echo "")
          
          if [ -z "$CHROMEDRIVER_VERSION" ]; then
            echo "âš ï¸ ì•ˆì • ë²„ì „ ì‚¬ìš©"
            sudo apt-get install -y chromium-chromedriver
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
          else
            echo "âœ… ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
            DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
            
            if wget -q --spider "$DOWNLOAD_URL"; then
              wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
              sudo unzip -q /tmp/chromedriver.zip -d /tmp/
              sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
              sudo chmod +x /usr/local/bin/chromedriver
            else
              sudo apt-get install -y chromium-chromedriver
              sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
            fi
          fi

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§ª Python ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ§ª Python ëª¨ë“ˆ í…ŒìŠ¤íŠ¸"
          python -c "
          try:
              # ê¸°ë³¸ ëª¨ë“ˆë“¤ í…ŒìŠ¤íŠ¸
              import crawler
              import classifier  
              import notifier
              import monitor_bugs
              import generate_report
              
              # í•¨ìˆ˜ ì¡´ì¬ í™•ì¸ (import ì—ëŸ¬ ë°©ì§€)
              assert hasattr(crawler, 'crawl_korean_sites'), 'crawl_korean_sites í•¨ìˆ˜ ì—†ìŒ'
              assert hasattr(crawler, 'crawl_global_sites'), 'crawl_global_sites í•¨ìˆ˜ ì—†ìŒ'  
              assert hasattr(crawler, 'get_all_posts_for_report'), 'get_all_posts_for_report í•¨ìˆ˜ ì—†ìŒ'
              assert hasattr(classifier, 'is_bug_post'), 'is_bug_post í•¨ìˆ˜ ì—†ìŒ'
              assert hasattr(classifier, 'classify_post'), 'classify_post í•¨ìˆ˜ ì—†ìŒ'
              assert hasattr(notifier, 'send_bug_alert'), 'send_bug_alert í•¨ìˆ˜ ì—†ìŒ'
              
              print('âœ… ëª¨ë“  ëª¨ë“ˆ import ì„±ê³µ')
          except Exception as e:
              print(f'âŒ ëª¨ë“ˆ import ì‹¤íŒ¨: {e}')
              exit(1)
          "

      - name: ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸"
          
          # ì£¼ìš” ì‚¬ì´íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸
          if curl -s --max-time 10 "https://page.onstove.com" > /dev/null; then
            echo "âœ… ìŠ¤í† ë¸Œ ì ‘ì† ê°€ëŠ¥"
          else
            echo "âŒ ìŠ¤í† ë¸Œ ì ‘ì† ì‹¤íŒ¨"
          fi
          
          if curl -s --max-time 10 "https://bbs.ruliweb.com" > /dev/null; then
            echo "âœ… ë£¨ë¦¬ì›¹ ì ‘ì† ê°€ëŠ¥" 
          else
            echo "âŒ ë£¨ë¦¬ì›¹ ì ‘ì† ì‹¤íŒ¨"
          fi
          
          # Discord ì›¹í›… í…ŒìŠ¤íŠ¸ (ì„ íƒì )
          if [ -n "${{ secrets.DISCORD_WEBHOOK_BUG }}" ]; then
            echo "âœ… Discord ì›¹í›… ì„¤ì •ë¨"
          else
            echo "âš ï¸ Discord ì›¹í›… ë¯¸ì„¤ì •"
          fi

      - name: ğŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸"
          python -c "
          try:
              print('ğŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì‹œì‘')
              from crawler import get_chrome_driver
              
              driver = get_chrome_driver()
              driver.get('https://www.google.com')
              
              title = driver.title
              print(f'âœ… í˜ì´ì§€ ë¡œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ: {title}')
              
              # ë¸Œë¼ìš°ì € ì •ë³´ ì¶œë ¥
              capabilities = driver.capabilities
              browser_version = capabilities.get('browserVersion', 'Unknown')
              driver_version = capabilities.get('chrome', {}).get('chromedriverVersion', 'Unknown')
              
              print(f'âœ… ë¸Œë¼ìš°ì € ë²„ì „: {browser_version}')
              print(f'âœ… ChromeDriver ë²„ì „: {driver_version}')
              
              driver.quit()
              print('âœ… Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ')
              
          except Exception as e:
              print(f'âŒ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
              exit(1)
          "

      - name: ğŸ“Š ë¦¬í¬ì§€í† ë¦¬ ìƒíƒœ í™•ì¸
        run: |
          echo "ğŸ“Š ë¦¬í¬ì§€í† ë¦¬ ìƒíƒœ:"
          echo "- ë§ˆì§€ë§‰ ì»¤ë°‹: $(git log -1 --pretty=format:'%h %s %cr')"
          
          if [ -f "crawled_links.json" ]; then
            LINK_COUNT=$(cat crawled_links.json | jq '.links | length' 2>/dev/null || echo "0")
            echo "- ì €ì¥ëœ ë§í¬ ìˆ˜: $LINK_COUNT"
          else
            echo "- crawled_links.json íŒŒì¼ ì—†ìŒ"
          fi

      - name: ğŸ’¾ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ
        run: |
          echo "ğŸ’¾ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
          echo "- ë©”ëª¨ë¦¬: $(free -h | grep Mem | awk '{print $3"/"$2}')"
          echo "- ë””ìŠ¤í¬: $(df -h / | tail -1 | awk '{print $4"/"$2" ("$5")"}')"
          echo "- Chrome ë²„ì „: $(google-chrome --version)"
          echo "- Python ë²„ì „: $(python --version)"

      - name: ğŸ” í¬ë¡¤ë§ ê¸°ëŠ¥ ê°„ë‹¨ í…ŒìŠ¤íŠ¸
        if: github.event.inputs.full_check == 'true'
        run: |
          echo "ğŸ” í¬ë¡¤ë§ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ (ì „ì²´ ì²´í¬ ëª¨ë“œ)"
          python -c "
          try:
              from crawler import fetch_ruliweb_epic7_board
              print('ë£¨ë¦¬ì›¹ í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸ ì‹œì‘...')
              posts = fetch_ruliweb_epic7_board()
              print(f'í…ŒìŠ¤íŠ¸ ê²°ê³¼: {len(posts)}ê°œ ê²Œì‹œê¸€ ë°œê²¬')
              print('âœ… í¬ë¡¤ë§ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì„±ê³µ')
          except Exception as e:
              print(f'âš ï¸ í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
              print('í¬ë¡¤ë§ ê¸°ëŠ¥ì— ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
          "

      - name: ğŸ“‹ í—¬ìŠ¤ì²´í¬ ìš”ì•½
        run: |
          echo "ğŸ“‹ Epic Seven ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ"
          echo "âœ… ì‹œìŠ¤í…œ ìƒíƒœ: ì •ìƒ"
          echo "âœ… ëª¨ë“  ê¸°ë³¸ ê¸°ëŠ¥: ë™ì‘"
          echo "âœ… ë„¤íŠ¸ì›Œí¬ ì—°ê²°: ì •ìƒ"
          echo "âœ… Selenium ë“œë¼ì´ë²„: ì •ìƒ"
          echo "ğŸ“… ì²´í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"

      - name: ğŸš¨ Discord í—¬ìŠ¤ì²´í¬ ì•Œë¦¼ (ì„ íƒì )
        if: failure()
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_BUG }}" ]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d '{
                   "content": "ğŸš¨ **Epic7 ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨**\nâ° ì‹œê°„: '"$(date '+%Y-%m-%d %H:%M:%S KST')"'\nğŸ” GitHub Actionsì—ì„œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.",
                   "username": "Epic7 Health Check Bot"
                 }' \
                 "${{ secrets.DISCORD_WEBHOOK_BUG }}" || echo "Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
          fi