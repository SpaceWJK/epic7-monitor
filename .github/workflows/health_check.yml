name: Epic Seven Monitor Health Check

on:
  schedule:
    - cron: "0 */6 * * *"  # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      full_check:
        description: 'Run full system check'
        required: false
        default: 'false'
        type: boolean
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
      DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
      FULL_CHECK: ${{ github.event.inputs.full_check || 'false' }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸŒ Install Chrome and ChromeDriver (Chrome for Testing ê¸°ë°˜)
        run: |
          echo "=== Chromeê³¼ ChromeDriver ì„¤ì¹˜ ì‹œì‘ ==="
          
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            fonts-liberation \
            libasound2 \
            libatk-bridge2.0-0 \
            libatspi2.0-0 \
            libcups2 \
            libdrm-dev \
            libgbm-dev \
            libglib2.0-0 \
            libnspr4 \
            libnss3 \
            libxcomposite1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            libxshmfence6 \
            libxtst6 \
            xdg-utils \
            wget

          INSTALL_SUCCESS=false

          echo "ğŸ“‹ ë°©ë²• 1: Chrome for Testing API ì‚¬ìš© (ê¶Œì¥)"
          if chrome_version_output=$(google-chrome --version 2>&1); then
            CURRENT_CHROME_MAJOR_VERSION=$(echo "$chrome_version_output" | sed -E 's/Google Chrome ([0-9]+)\..*/\1/')
            echo "í˜„ì¬ ì„¤ì¹˜ëœ Chrome Major Version: $CURRENT_CHROME_MAJOR_VERSION"
          else
            CURRENT_CHROME_MAJOR_VERSION=""
            echo "Chromeì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ ë²„ì „ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìµœì‹  ë²„ì „ì„ ì‹œë„í•©ë‹ˆë‹¤."
          fi

          if [ -n "$CURRENT_CHROME_MAJOR_VERSION" ]; then
            LATEST_DRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
              python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['version'])" | \
              awk -F'.' '{print $1}')
            
            if [ -n "$LATEST_DRIVER_VERSION" ]; then
              CHROME_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
                python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['downloads']['chrome-linux'][0]['url'])")
              
              CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
                python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['downloads']['chromedriver-linux64'][0]['url'])")
              
              if [ -n "$CHROME_URL" ] && [ -n "$CHROMEDRIVER_URL" ]; then
                echo "Chrome ë‹¤ìš´ë¡œë“œ: $CHROME_URL"
                echo "ChromeDriver ë‹¤ìš´ë¡œë“œ: $CHROMEDRIVER_URL"

                wget -q "$CHROME_URL" -O /tmp/chrome-linux.zip
                sudo unzip -qq /tmp/chrome-linux.zip -d /opt/
                sudo ln -sf /opt/chrome-linux/chrome /usr/local/bin/google-chrome
                sudo chmod +x /usr/local/bin/google-chrome
                
                wget -q "$CHROMEDRIVER_URL" -O /tmp/chromedriver.zip
                sudo unzip -qq /tmp/chromedriver.zip -d /usr/local/bin/
                sudo mv /usr/local/bin/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
                sudo chmod +x /usr/local/bin/chromedriver

                if google-chrome --version >/dev/null 2>&1 && chromedriver --version >/dev/null 2>&1; then
                  echo "âœ… ë°©ë²• 1 ì„±ê³µ: Chrome for Testing APIë¥¼ í†µí•œ ì„¤ì¹˜"
                  INSTALL_SUCCESS=true
                else
                  echo "âŒ ë°©ë²• 1 ì‹¤íŒ¨: ì„¤ì¹˜ëŠ” ë˜ì—ˆìœ¼ë‚˜ ë²„ì „ í™•ì¸ ì‹¤íŒ¨"
                fi
              else
                echo "âŒ ë°©ë²• 1 ì‹¤íŒ¨: Chrome ë˜ëŠ” ChromeDriver URLì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
              fi
            else
              echo "âŒ ë°©ë²• 1 ì‹¤íŒ¨: ìµœì‹  Chrome Major Versionì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            fi
          else
            echo "í˜„ì¬ Chrome ë²„ì „ í™•ì¸ ë¶ˆê°€. ê°•ì œ ì„¤ì¹˜ ì‹œë„."
            CHROME_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
                python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['downloads']['chrome-linux'][0]['url'])")
            
            CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-int.json" | \
              python3 -c "import sys, json; print(json.load(sys.stdin)['channels']['Stable']['downloads']['chromedriver-linux64'][0]['url'])")

            if [ -n "$CHROME_URL" ] && [ -n "$CHROMEDRIVER_URL" ]; then
              echo "Chrome ë‹¤ìš´ë¡œë“œ: $CHROME_URL"
              echo "ChromeDriver ë‹¤ìš´ë¡œë“œ: $CHROMEDRIVER_URL"

              wget -q "$CHROME_URL" -O /tmp/chrome-linux.zip
              sudo unzip -qq /tmp/chrome-linux.zip -d /opt/
              sudo ln -sf /opt/chrome-linux/chrome /usr/local/bin/google-chrome
              sudo chmod +x /usr/local/bin/google-chrome
              
              wget -q "$CHROMEDRIVER_URL" -O /tmp/chromedriver.zip
              sudo unzip -qq /tmp/chromedriver.zip -d /usr/local/bin/
              sudo mv /usr/local/bin/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
              sudo chmod +x /usr/local/bin/chromedriver

              if google-chrome --version >/dev/null 2>&1 && chromedriver --version >/dev/null 2>&1; then
                echo "âœ… ë°©ë²• 1 ì„±ê³µ: Chrome for Testing APIë¥¼ í†µí•œ ì„¤ì¹˜"
                INSTALL_SUCCESS=true
              else
                echo "âŒ ë°©ë²• 1 ì‹¤íŒ¨: ì„¤ì¹˜ëŠ” ë˜ì—ˆìœ¼ë‚˜ ë²„ì „ í™•ì¸ ì‹¤íŒ¨"
              fi
            fi
          fi

          if [ "$INSTALL_SUCCESS" != "true" ]; then
            echo "âŒ ChromeDriver ì„¤ì¹˜ ìµœì¢… ì‹¤íŒ¨"
            exit 1
          fi

          echo "ğŸ‰ ChromeDriver ì„¤ì¹˜ ì™„ë£Œ!"
          google-chrome --version
          chromedriver --version
          echo "ê²½ë¡œ: $(which chromedriver)"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "=== requirements.txt ì„¤ì¹˜ ì‹œì‘ ==="
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Python ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ§ª Run Python health check
        run: |
          echo "=== ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ==="
          echo "ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          python health_check.py --full_check "${{ env.FULL_CHECK }}" --debug_mode "${{ env.DEBUG_MODE }}"
          if [ $? -eq 0 ]; then
            echo "âœ… í—¬ìŠ¤ ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ"
          else
            echo "âŒ í—¬ìŠ¤ ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨"
            exit 1
          fi

      - name: ğŸ“Š Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-results
          path: |
            *.log
            *.json
          retention-days: 7

      - name: ğŸ“¤ Send Discord notification
        if: failure() && env.DISCORD_WEBHOOK_BUG
        run: |
          echo "=== Discord ì•Œë¦¼ ì „ì†¡ (ì‹¤íŒ¨ ì‹œ) ==="
          DISCORD_MESSAGE="{\"embeds\":[{\"title\":\"âŒ Epic7 Health Check ì‹¤íŒ¨\",\"description\":\"Health Check ì›Œí¬í”Œë¡œìš°ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\",\"color\":15548997,\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$DISCORD_MESSAGE" \
               ${{ secrets.DISCORD_WEBHOOK_BUG }}
          echo "âœ… Discord ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
      
      - name: ğŸ”„ Cleanup
        if: always()
        run: |
          echo "=== ì •ë¦¬ === "
          rm -f /tmp/chromedriver.zip
          rm -rf /usr/local/bin/chromedriver-linux64/
          rm -f /tmp/chrome-linux.zip
          rm -rf /opt/chrome-linux/
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"