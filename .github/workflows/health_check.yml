name: Epic Seven Monitor Health Check

on:
  schedule:
    - cron: "0 */6 * * *"  # 6ì‹œê°„ë§ˆë‹¤
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Chrome and ChromeDriver (Compatible Version)
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Chrome ë²„ì „ ì •í™•íˆ ì¶”ì¶œ
          CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
          CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
          echo "ğŸŒŸ Chrome ë²„ì „: $CHROME_VERSION (ì£¼ë²„ì „: $CHROME_MAJOR_VERSION)"
          
          # ê¸°ì¡´ ChromeDriver ì œê±° (ë²„ì „ ì¶©ëŒ ë°©ì§€)
          sudo rm -f /usr/local/bin/chromedriver
          
          # ì •í™•íˆ ë§¤ì¹­ë˜ëŠ” ChromeDriver ë²„ì „ ì°¾ê¸°
          echo "ğŸ” ChromeDriver ë²„ì „ íƒìƒ‰ ì¤‘..."
          
          # ë°©ë²• 1: ì •í™•í•œ Chrome ë²„ì „ê³¼ ë§¤ì¹­ë˜ëŠ” ChromeDriver
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR_VERSION}" || echo "")
          
          # ë°©ë²• 2: ì •í™•í•œ ë²„ì „ì´ ì—†ìœ¼ë©´ ì•ˆì • ë²„ì „ ì‚¬ìš©
          if [ -z "$CHROMEDRIVER_VERSION" ] || [ "$CHROMEDRIVER_VERSION" = "Not Found" ]; then
            echo "âš ï¸ ì •í™•í•œ ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ì•ˆì • ë²„ì „ ì‚¬ìš©"
            CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE" || echo "")
          fi
          
          # ë°©ë²• 3: ìµœí›„ ìˆ˜ë‹¨ìœ¼ë¡œ í•˜ë“œì½”ë”©ëœ ì•ˆì • ë²„ì „
          if [ -z "$CHROMEDRIVER_VERSION" ]; then
            CHROMEDRIVER_VERSION="119.0.6045.105"  # ì•Œë ¤ì§„ ì•ˆì • ë²„ì „
            echo "âš ï¸ ëª¨ë“  API ì‹¤íŒ¨, í•˜ë“œì½”ë”©ëœ ì•ˆì • ë²„ì „ ì‚¬ìš©: $CHROMEDRIVER_VERSION"
          fi
          
          echo "âœ… ì„ íƒëœ ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
          
          # ChromeDriver ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
          DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          echo "ğŸ“¥ ë‹¤ìš´ë¡œë“œ URL: $DOWNLOAD_URL"
          
          # ë‹¤ìš´ë¡œë“œ ì‹œë„
          if wget -q --spider "$DOWNLOAD_URL"; then
            wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
            sudo unzip /tmp/chromedriver.zip -d /tmp/
            sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/chromedriver
            echo "âœ… ChromeDriver ì„¤ì¹˜ ì™„ë£Œ: $(chromedriver --version 2>/dev/null || echo 'ë²„ì „ í™•ì¸ ì‹¤íŒ¨')"
          else
            echo "âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ìš°ë¶„íˆ¬ íŒ¨í‚¤ì§€ ì‚¬ìš©"
            sudo apt-get install -y chromium-chromedriver
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run comprehensive health check
        run: |
          echo "ğŸ¥ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì‹œì‘"
          
          # Python ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
          python -c "
          try:
              from crawler import crawl_arca_sites, get_chrome_driver
              from classifier import is_bug_post  
              from notifier import send_bug_alert
              print('âœ… ëª¨ë“  ëª¨ë“ˆ import ì„±ê³µ')
          except Exception as e:
              print(f'âŒ ëª¨ë“ˆ import ì‹¤íŒ¨: {e}')
              exit(1)
          "
          
          # ìŠ¤í† ë¸Œ ì ‘ì† í…ŒìŠ¤íŠ¸
          python -c "
          import requests
          try:
              response = requests.get('https://page.onstove.com/epicseven/kr/list/1012', timeout=10)
              if response.status_code == 200:
                  print('âœ… ìŠ¤í† ë¸Œ ì ‘ì† ê°€ëŠ¥')
              else:
                  print(f'âš ï¸ ìŠ¤í† ë¸Œ ì‘ë‹µ ì½”ë“œ: {response.status_code}')
          except Exception as e:
              print(f'âŒ ìŠ¤í† ë¸Œ ì ‘ì† ì‹¤íŒ¨: {e}')
          "
          
          # ChromeDriver ìƒíƒœ í™•ì¸
          echo "ğŸ” ChromeDriver ìƒíƒœ í™•ì¸:"
          echo "- Chrome ë²„ì „: $(google-chrome --version)"
          echo "- ChromeDriver ê²½ë¡œ:"
          which chromedriver && echo "  System PATH: $(which chromedriver)" || echo "  System PATH: ì—†ìŒ"
          ls -la /usr/local/bin/chromedriver 2>/dev/null && echo "  /usr/local/bin/chromedriver: ì¡´ì¬" || echo "  /usr/local/bin/chromedriver: ì—†ìŒ"
          ls -la /usr/bin/chromedriver 2>/dev/null && echo "  /usr/bin/chromedriver: ì¡´ì¬" || echo "  /usr/bin/chromedriver: ì—†ìŒ"
          
          # ChromeDriver ë²„ì „ í™•ì¸
          for path in "/usr/local/bin/chromedriver" "/usr/bin/chromedriver" "$(which chromedriver 2>/dev/null)"; do
            if [ -n "$path" ] && [ -f "$path" ]; then
              echo "- $path ë²„ì „: $($path --version 2>/dev/null || echo 'ë²„ì „ í™•ì¸ ì‹¤íŒ¨')"
            fi
          done
          
          # Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ (ê°œì„ ëœ ë²„ì „)
          python -c "
          from crawler import get_chrome_driver
          import os
          
          try:
              print('ğŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì‹œì‘')
              driver = get_chrome_driver()
              
              # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
              driver