name: Epic Seven Monitor Health Check

on:
  schedule:
    - cron: "0 */6 * * *"  # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      full_check:
        description: 'Run full system check'
        required: false
        default: 'false'
        type: boolean
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      TZ: Asia/Seoul
      DISCORD_WEBHOOK_REPORT: ${{ secrets.DISCORD_WEBHOOK_REPORT }}
      DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸŒ Install Chrome and ChromeDriver (Chrome 138 í˜¸í™˜)
        run: |
          echo "=== Chrome ë° ChromeDriver ì„¤ì¹˜ (Chrome 138 í˜¸í™˜) ==="
          
          # Chrome ì„¤ì¹˜
          sudo apt-get update -y
          sudo apt-get install -y google-chrome-stable
          
          # Chrome ë²„ì „ í™•ì¸
          CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
          CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
          echo "âœ… Chrome ë²„ì „: $CHROME_VERSION (Major: $CHROME_MAJOR_VERSION)"
          
          # ChromeDriver ì„¤ì¹˜ (3ë‹¨ê³„ í´ë°± ë°©ì‹)
          echo "=== ChromeDriver ì„¤ì¹˜ ì‹œì‘ ==="
          INSTALL_SUCCESS=false
          
          # ë°©ë²• 1: Chrome for Testing API ì‚¬ìš© (ê¶Œì¥)
          echo "ğŸ”„ ë°©ë²• 1: Chrome for Testing API ì‚¬ìš©"
          if curl -s "https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json" | grep -q "chromedriver"; then
            # ìµœì‹  stable ë²„ì „ URL íšë“
            CHROMEDRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json" | \
              python3 -c "import sys, json; data=json.load(sys.stdin); print(data['channels']['Stable']['downloads']['chromedriver'][0]['url'])" 2>/dev/null || echo "")
            
            if [ -n "$CHROMEDRIVER_URL" ] && [ "$CHROMEDRIVER_URL" != "null" ]; then
              echo "ğŸ”— ChromeDriver URL: $CHROMEDRIVER_URL"
              wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL"
              
              if [ -f "/tmp/chromedriver.zip" ] && [ -s "/tmp/chromedriver.zip" ]; then
                sudo unzip -o /tmp/chromedriver.zip -d /tmp/
                sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver 2>/dev/null || \
                sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
                sudo chmod +x /usr/local/bin/chromedriver
                
                if chromedriver --version >/dev/null 2>&1; then
                  echo "âœ… ë°©ë²• 1 ì„±ê³µ: ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"
                  INSTALL_SUCCESS=true
                fi
              fi
            fi
          fi
          
          # ë°©ë²• 2: ì§ì ‘ ë‹¤ìš´ë¡œë“œ (GitHub Release)
          if [ "$INSTALL_SUCCESS" != "true" ]; then
            echo "ğŸ”„ ë°©ë²• 2: GitHub Release ì§ì ‘ ë‹¤ìš´ë¡œë“œ"
            
            # Chrome ë²„ì „ì— ë§ëŠ” ChromeDriver ë²„ì „ ì°¾ê¸°
            case $CHROME_MAJOR_VERSION in
              "138"|"139"|"140")
                CHROMEDRIVER_VERSION="138.0.6993.88"
                ;;
              "137")
                CHROMEDRIVER_VERSION="137.0.6916.107"
                ;;
              "136")
                CHROMEDRIVER_VERSION="136.0.6877.63"
                ;;
              *)
                CHROMEDRIVER_VERSION="138.0.6993.88"  # ê¸°ë³¸ê°’
                ;;
            esac
            
            echo "ğŸ¯ ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
            
            # ì—¬ëŸ¬ ë‹¤ìš´ë¡œë“œ URL ì‹œë„
            DOWNLOAD_URLS=(
              "https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
              "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
              "https://github.com/GoogleChromeLabs/chrome-for-testing/releases/download/$CHROMEDRIVER_VERSION/chromedriver-linux64.zip"
            )
            
            for url in "${DOWNLOAD_URLS[@]}"; do
              echo "ğŸ”— ì‹œë„: $url"
              if wget -q -O /tmp/chromedriver.zip "$url"; then
                if [ -f "/tmp/chromedriver.zip" ] && [ -s "/tmp/chromedriver.zip" ]; then
                  sudo unzip -o /tmp/chromedriver.zip -d /tmp/
                  sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver 2>/dev/null || \
                  sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
                  sudo chmod +x /usr/local/bin/chromedriver
                  
                  if chromedriver --version >/dev/null 2>&1; then
                    echo "âœ… ë°©ë²• 2 ì„±ê³µ: ChromeDriver ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
                    INSTALL_SUCCESS=true
                    break
                  fi
                fi
              fi
            done
          fi
          
          # ë°©ë²• 3: íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš© (ìµœí›„ ìˆ˜ë‹¨)
          if [ "$INSTALL_SUCCESS" != "true" ]; then
            echo "ğŸ”„ ë°©ë²• 3: íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš©"
            
            # apt íŒ¨í‚¤ì§€ ì‹œë„
            sudo apt-get update -y
            sudo apt-get install -y chromium-chromedriver 2>/dev/null || true
            
            if [ -f "/usr/bin/chromedriver" ]; then
              sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
              sudo chmod +x /usr/local/bin/chromedriver
              
              if chromedriver --version >/dev/null 2>&1; then
                echo "âœ… ë°©ë²• 3 ì„±ê³µ: APT ChromeDriver ì„¤ì¹˜"
                INSTALL_SUCCESS=true
              fi
            fi
          fi
          
          # ì„¤ì¹˜ ê²°ê³¼ í™•ì¸
          if [ "$INSTALL_SUCCESS" = "true" ]; then
            echo "ğŸ‰ ChromeDriver ì„¤ì¹˜ ì™„ë£Œ!"
            echo "ğŸ“‹ Chrome ë²„ì „: $(google-chrome --version)"
            echo "ğŸ“‹ ChromeDriver ë²„ì „: $(chromedriver --version)"
            echo "ğŸ“‹ ChromeDriver ê²½ë¡œ: $(which chromedriver)"
          else
            echo "âŒ ChromeDriver ì„¤ì¹˜ ì‹¤íŒ¨"
            echo "ğŸ” ì‹œìŠ¤í…œ ì •ë³´:"
            echo "   - Chrome: $(google-chrome --version)"
            echo "   - ì‹œìŠ¤í…œ: $(uname -a)"
            echo "   - ì•„í‚¤í…ì²˜: $(dpkg --print-architecture)"
            exit 1
          fi
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/chromedriver.zip
          rm -rf /tmp/chromedriver-linux64/
          
          echo "âœ… Chrome ë° ChromeDriver ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "=== Python ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘ ==="
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found, installing basic dependencies"
            pip install requests beautifulsoup4 selenium lxml deep-translator python-dateutil
          fi
          echo "âœ… Python dependencies installed"

      - name: ğŸ§ª Run system health check
        run: |
          echo "=== ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ==="
          echo "ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ê¸°ë³¸ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
          echo "ğŸ§ª ê¸°ë³¸ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸"
          python -c "import json, os, time, datetime, re, random, hashlib; print('âœ… ê¸°ë³¸ ëª¨ë“ˆ OK')"
          python -c "import requests, bs4, selenium; print('âœ… ì™¸ë¶€ ëª¨ë“ˆ OK')"
          python -c "from deep_translator import GoogleTranslator; print('âœ… deep-translator OK')"
          
          # í”„ë¡œì íŠ¸ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
          echo "ğŸ§ª í”„ë¡œì íŠ¸ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸"
          if python -c "import crawler" 2>/dev/null; then
            echo "âœ… crawler ëª¨ë“ˆ OK"
          else
            echo "âš ï¸ crawler ëª¨ë“ˆ import ì‹¤íŒ¨"
          fi
          
          if python -c "import classifier" 2>/dev/null; then
            echo "âœ… classifier ëª¨ë“ˆ OK"
          else
            echo "âš ï¸ classifier ëª¨ë“ˆ import ì‹¤íŒ¨"
          fi
          
          if python -c "import notifier" 2>/dev/null; then
            echo "âœ… notifier ëª¨ë“ˆ OK"
          else
            echo "âš ï¸ notifier ëª¨ë“ˆ import ì‹¤íŒ¨"
          fi
          
          # ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸"
          sites=("https://google.com" "https://page.onstove.com" "https://bbs.ruliweb.com")
          for site in "${sites[@]}"; do
            if curl -s --head --max-time 10 "$site" | grep -E "(200|301|302)" > /dev/null; then
              echo "âœ… $site - ì—°ê²° ì„±ê³µ"
            else
              echo "âš ï¸ $site - ì—°ê²° ì‹¤íŒ¨"
            fi
          done
          
          # Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸
          echo "ğŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸"
          python -c "
          import sys
          sys.path.append('.')
          try:
            from crawler import get_chrome_driver
            driver = get_chrome_driver()
            driver.get('https://google.com')
            print('âœ… Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì„±ê³µ')
            driver.quit()
          except Exception as e:
            print(f'âš ï¸ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
          " || echo "âš ï¸ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
          
          echo "âœ… ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ"

      - name: ğŸ“Š Generate health report
        run: |
          echo "=== í—¬ìŠ¤ì²´í¬ ë¦¬í¬íŠ¸ ìƒì„± ==="
          
          # ì‹œìŠ¤í…œ ìƒíƒœ ìˆ˜ì§‘
          CHROME_VERSION=$(google-chrome --version 2>/dev/null || echo "N/A")
          CHROMEDRIVER_VERSION=$(chromedriver --version 2>/dev/null || echo "N/A")
          PYTHON_VERSION=$(python --version 2>/dev/null || echo "N/A")
          MEMORY_INFO=$(free -h | grep Mem | awk '{print $3 "/" $2}')
          DISK_INFO=$(df -h / | tail -1 | awk '{print $3 "/" $2}')
          
          # ë¦¬í¬íŠ¸ ìƒì„±
          cat > health_report.md << EOF
          # Epic7 ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ë¦¬í¬íŠ¸
          
          **ìƒì„± ì‹œê°„:** $(date '+%Y-%m-%d %H:%M:%S')
          
          ## ğŸ–¥ï¸ ì‹œìŠ¤í…œ ì •ë³´
          - Chrome ë²„ì „: $CHROME_VERSION
          - ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION
          - Python ë²„ì „: $PYTHON_VERSION
          - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: $MEMORY_INFO
          - ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: $DISK_INFO
          
          ## ğŸ”§ ì»´í¬ë„ŒíŠ¸ ìƒíƒœ
          - crawler.py: $([ -f "crawler.py" ] && echo "âœ… ì¡´ì¬" || echo "âŒ ì—†ìŒ")
          - classifier.py: $([ -f "classifier.py" ] && echo "âœ… ì¡´ì¬" || echo "âŒ ì—†ìŒ")
          - notifier.py: $([ -f "notifier.py" ] && echo "âœ… ì¡´ì¬" || echo "âŒ ì—†ìŒ")
          - monitor_bugs.py: $([ -f "monitor_bugs.py" ] && echo "âœ… ì¡´ì¬" || echo "âŒ ì—†ìŒ")
          
          ## ğŸ“Š JSON ë°ì´í„° ìƒíƒœ
          EOF
          
          for file in crawled_links*.json; do
            if [ -f "$file" ]; then
              echo "- $file: âœ… ì¡´ì¬ (í¬ê¸°: $(stat -c%s "$file") bytes)" >> health_report.md
            fi
          done
          
          echo "" >> health_report.md
          echo "## ğŸ¯ í—¬ìŠ¤ì²´í¬ ê²°ê³¼" >> health_report.md
          echo "ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤." >> health_report.md
          
          echo "ğŸ“„ í—¬ìŠ¤ì²´í¬ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"

      - name: ğŸ“¤ Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_number }}
          path: |
            health_report.md
            *.json
          retention-days: 3

      - name: ğŸ“¢ Send Discord notification
        if: always()
        run: |
          echo "ğŸ“¡ Discord ì•Œë¦¼ ì „ì†¡"
          
          # ì‹¤í–‰ ìƒíƒœ í™•ì¸
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="ì„±ê³µ"
            STATUS_COLOR="3066993"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="ì‹¤íŒ¨"
            STATUS_COLOR="15158332"
          fi
          
          # Discord ë©”ì‹œì§€ ìƒì„±
          DISCORD_MESSAGE=$(cat << EOF
          {
            "embeds": [
              {
                "title": "${STATUS_EMOJI} Epic7 ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬",
                "description": "ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€ì´ **${STATUS_TEXT}**í–ˆìŠµë‹ˆë‹¤.",
                "color": ${STATUS_COLOR},
                "fields": [
                  {
                    "name": "ğŸ“… ì‹¤í–‰ ì‹œê°„",
                    "value": "$(date '+%Y-%m-%d %H:%M:%S')",
                    "inline": true
                  },
                  {
                    "name": "ğŸ–¥ï¸ Chrome ë²„ì „",
                    "value": "$(google-chrome --version 2>/dev/null || echo 'N/A')",
                    "inline": true
                  },
                  {
                    "name": "ğŸ”§ ChromeDriver ë²„ì „",
                    "value": "$(chromedriver --version 2>/dev/null || echo 'N/A')",
                    "inline": true
                  },
                  {
                    "name": "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰",
                    "value": "$(free -h | grep Mem | awk '{print $3 "/" $2}')",
                    "inline": true
                  },
                  {
                    "name": "ğŸ’¿ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰",
                    "value": "$(df -h / | tail -1 | awk '{print $3 "/" $2}')",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "Epic7 ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ"
                },
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
              }
            ]
          }
          EOF
          )
          
          # Discord Webhook ì „ì†¡
          if [ ! -z "$DISCORD_WEBHOOK_REPORT" ]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "$DISCORD_MESSAGE" \
                 "$DISCORD_WEBHOOK_REPORT" || echo "Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
          else
            echo "DISCORD_WEBHOOK_REPORT í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
          fi

      - name: ğŸ”„ Cleanup
        if: always()
        run: |
          echo "=== ì •ë¦¬ ì‘ì—… ì‹œì‘ ==="
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/chromedriver.zip
          rm -rf /tmp/chromedriver-linux64/
          
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"
          echo "=========================================="
          echo "   Epic7 í—¬ìŠ¤ì²´í¬ ì™„ë£Œ"
          echo "=========================================="
          echo "â° ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”§ Chrome Driver: $(chromedriver --version 2>/dev/null || echo 'N/A')"
          echo "âœ… ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "=========================================="