# health_check.yml
name: Epic Seven Monitor Health Check

on:
  schedule:
    - cron: "0 */6 * * *"  # 6ì‹œê°„ë§ˆë‹¤
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium

      - name: Run health check
        run: |
          echo "ğŸ¥ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì‹œì‘"
          
          # Python ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
          python -c "
          try:
              from crawler import crawl_arca_sites
              from classifier import is_bug_post  
              from notifier import send_bug_alert
              print('âœ… ëª¨ë“  ëª¨ë“ˆ import ì„±ê³µ')
          except Exception as e:
              print(f'âŒ ëª¨ë“ˆ import ì‹¤íŒ¨: {e}')
              exit(1)
          "
          
          # í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ì‹¤í–‰í•˜ì§€ ì•Šê³  êµ¬ë¬¸ë§Œ í™•ì¸)
          python -c "
          import requests
          try:
              response = requests.get('https://page.onstove.com/epicseven/kr/list/1012', timeout=10)
              if response.status_code == 200:
                  print('âœ… ìŠ¤í† ë¸Œ ì ‘ì† ê°€ëŠ¥')
              else:
                  print(f'âš ï¸ ìŠ¤í† ë¸Œ ì‘ë‹µ ì½”ë“œ: {response.status_code}')
          except Exception as e:
              print(f'âŒ ìŠ¤í† ë¸Œ ì ‘ì† ì‹¤íŒ¨: {e}')
          "
          
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ"

      - name: Check repository status
        run: |
          echo "ğŸ“Š ë¦¬í¬ì§€í† ë¦¬ ìƒíƒœ:"
          echo "- ë§ˆì§€ë§‰ ì»¤ë°‹: $(git log -1 --format='%h %s %cr')"
          if [[ -f crawled_links.json ]]; then
            echo "- ì €ì¥ëœ ë§í¬ ìˆ˜: $(jq length crawled_links.json 2>/dev/null || echo 'íŒŒì¼ ì½ê¸° ì‹¤íŒ¨')"
          else
            echo "- crawled_links.json íŒŒì¼ ì—†ìŒ"
          fi
