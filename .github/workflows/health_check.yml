name: Epic Seven Monitor Health Check

on:
  schedule:
    - cron: "0 */6 * * *"  # 6ì‹œê°„ë§ˆë‹¤
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Chrome and ChromeDriver (Compatible Version)
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Chrome ë²„ì „ ì •í™•ížˆ ì¶”ì¶œ
          CHROME_VERSION=$(google-chrome --version | sed 's/.*Chrome \([0-9\.]*\).*/\1/')
          CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d'.' -f1)
          echo "ðŸŒŸ Chrome ë²„ì „: $CHROME_VERSION (ì£¼ë²„ì „: $CHROME_MAJOR_VERSION)"
          
          # ê¸°ì¡´ ChromeDriver ì œê±° (ë²„ì „ ì¶©ëŒ ë°©ì§€)
          sudo rm -f /usr/local/bin/chromedriver
          
          # ì •í™•ížˆ ë§¤ì¹­ë˜ëŠ” ChromeDriver ë²„ì „ ì°¾ê¸°
          echo "ðŸ” ChromeDriver ë²„ì „ íƒìƒ‰ ì¤‘..."
          
          # ë°©ë²• 1: ì •í™•í•œ Chrome ë²„ì „ê³¼ ë§¤ì¹­ë˜ëŠ” ChromeDriver
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR_VERSION}" || echo "")
          
          # ë°©ë²• 2: ì •í™•í•œ ë²„ì „ì´ ì—†ìœ¼ë©´ ì•ˆì • ë²„ì „ ì‚¬ìš©
          if [ -z "$CHROMEDRIVER_VERSION" ] || [ "$CHROMEDRIVER_VERSION" = "Not Found" ]; then
            echo "âš ï¸ ì •í™•í•œ ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ì•ˆì • ë²„ì „ ì‚¬ìš©"
            CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE" || echo "")
          fi
          
          # ë°©ë²• 3: ìµœí›„ ìˆ˜ë‹¨ìœ¼ë¡œ í•˜ë“œì½”ë”©ëœ ì•ˆì • ë²„ì „
          if [ -z "$CHROMEDRIVER_VERSION" ]; then
            CHROMEDRIVER_VERSION="119.0.6045.105"  # ì•Œë ¤ì§„ ì•ˆì • ë²„ì „
            echo "âš ï¸ ëª¨ë“  API ì‹¤íŒ¨, í•˜ë“œì½”ë”©ëœ ì•ˆì • ë²„ì „ ì‚¬ìš©: $CHROMEDRIVER_VERSION"
          fi
          
          echo "âœ… ì„ íƒëœ ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
          
          # ChromeDriver ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
          DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          echo "ðŸ“¥ ë‹¤ìš´ë¡œë“œ URL: $DOWNLOAD_URL"
          
          # ë‹¤ìš´ë¡œë“œ ì‹œë„
          if wget -q --spider "$DOWNLOAD_URL"; then
            wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
            sudo unzip /tmp/chromedriver.zip -d /tmp/
            sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/chromedriver
            echo "âœ… ChromeDriver ì„¤ì¹˜ ì™„ë£Œ: $(chromedriver --version 2>/dev/null || echo 'ë²„ì „ í™•ì¸ ì‹¤íŒ¨')"
          else
            echo "âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ìš°ë¶„íˆ¬ íŒ¨í‚¤ì§€ ì‚¬ìš©"
            sudo apt-get install -y chromium-chromedriver
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Module import test
        run: |
          echo "ðŸ§ª Python ëª¨ë“ˆ í…ŒìŠ¤íŠ¸"
          python3 -c "
          try:
              from crawler import crawl_arca_sites, get_chrome_driver
              from classifier import is_bug_post  
              from notifier import send_bug_alert
              print('âœ… ëª¨ë“  ëª¨ë“ˆ import ì„±ê³µ')
          except Exception as e:
              print(f'âŒ ëª¨ë“ˆ import ì‹¤íŒ¨: {e}')
              exit(1)
          "

      - name: Network connectivity test
        run: |
          echo "ðŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸"
          python3 -c "
          import requests
          try:
              response = requests.get('https://page.onstove.com/epicseven/kr/list/1012', timeout=10)
              if response.status_code == 200:
                  print('âœ… ìŠ¤í† ë¸Œ ì ‘ì† ê°€ëŠ¥')
              else:
                  print(f'âš ï¸ ìŠ¤í† ë¸Œ ì‘ë‹µ ì½”ë“œ: {response.status_code}')
          except Exception as e:
              print(f'âŒ ìŠ¤í† ë¸Œ ì ‘ì† ì‹¤íŒ¨: {e}')
          "

      - name: ChromeDriver status check
        run: |
          echo "ðŸ” ChromeDriver ìƒíƒœ í™•ì¸:"
          echo "- Chrome ë²„ì „: $(google-chrome --version)"
          echo "- ChromeDriver ê²½ë¡œ:"
          which chromedriver && echo "  System PATH: $(which chromedriver)" || echo "  System PATH: ì—†ìŒ"
          ls -la /usr/local/bin/chromedriver 2>/dev/null && echo "  /usr/local/bin/chromedriver: ì¡´ìž¬" || echo "  /usr/local/bin/chromedriver: ì—†ìŒ"
          ls -la /usr/bin/chromedriver 2>/dev/null && echo "  /usr/bin/chromedriver: ì¡´ìž¬" || echo "  /usr/bin/chromedriver: ì—†ìŒ"
          
          # ChromeDriver ë²„ì „ í™•ì¸
          echo "- ChromeDriver ë²„ì „ë“¤:"
          if [ -f "/usr/local/bin/chromedriver" ]; then
            echo "  /usr/local/bin/chromedriver: $(/usr/local/bin/chromedriver --version 2>/dev/null || echo 'ë²„ì „ í™•ì¸ ì‹¤íŒ¨')"
          fi
          if [ -f "/usr/bin/chromedriver" ]; then
            echo "  /usr/bin/chromedriver: $(/usr/bin/chromedriver --version 2>/dev/null || echo 'ë²„ì „ í™•ì¸ ì‹¤íŒ¨')"
          fi

      - name: Selenium driver test
        run: |
          echo "ðŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸"
          python3 -c "
          from crawler import get_chrome_driver
          import os
          
          try:
              print('ðŸ”§ Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì‹œìž‘')
              driver = get_chrome_driver()
              
              # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
              driver.get('https://www.google.com')
              title = driver.title
              print(f'âœ… íŽ˜ì´ì§€ ë¡œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ: {title}')
              
              # ë“œë¼ì´ë²„ ì •ë³´ ì¶œë ¥
              caps = driver.capabilities
              browser_version = caps.get('browserVersion', 'Unknown')
              driver_version = caps.get('chrome', {}).get('chromedriverVersion', 'Unknown')
              print(f'âœ… ë¸Œë¼ìš°ì € ë²„ì „: {browser_version}')
              print(f'âœ… ChromeDriver ë²„ì „: {driver_version}')
              
              driver.quit()
              print('âœ… Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ')
              
          except Exception as e:
              print(f'âŒ Selenium ë“œë¼ì´ë²„ ì‹¤íŒ¨: {e}')
              exit(1)
          "

      - name: Check repository status
        run: |
          echo "ðŸ“Š ë¦¬í¬ì§€í† ë¦¬ ìƒíƒœ:"
          echo "- ë§ˆì§€ë§‰ ì»¤ë°‹: $(git log -1 --format='%h %s %cr')"
          if [[ -f crawled_links.json ]]; then
            echo "- ì €ìž¥ëœ ë§í¬ ìˆ˜: $(jq length crawled_links.json 2>/dev/null || echo 'íŒŒì¼ ì½ê¸° ì‹¤íŒ¨')"
          else
            echo "- crawled_links.json íŒŒì¼ ì—†ìŒ"
          fi

      - name: System resource check
        run: |
          echo "ðŸ’¾ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
          echo "- ë©”ëª¨ë¦¬: $(free -h | grep '^Mem:' | awk '{print $3"/"$2}')"
          echo "- ë””ìŠ¤í¬: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')"
          echo "- Chrome ë²„ì „: $(google-chrome --version 2>/dev/null || echo 'Chrome ë¯¸ì„¤ì¹˜')"
          echo "- Python ë²„ì „: $(python3 --version)"

      - name: Final health summary
        run: |
          echo "ðŸŽ¯ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ - $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "âœ… ì‹œìŠ¤í…œ ìƒíƒœ: ì •ìƒ"

      - name: Create health report
        if: always()
        run: |
          echo "ðŸŽ¯ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ - $(date '+%Y-%m-%d %H:%M:%S KST')" > health_report.txt
          echo "ì‹œìŠ¤í…œ ìƒíƒœ: ì •ìƒ" >> health_report.txt

      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_number }}
          path: health_report.txt
          retention-days: 7
