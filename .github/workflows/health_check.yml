name: ğŸ¥ Epic7 Health Check (Optimized v3.1)

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable verbose debug logging'
        required: false
        default: 'false'
        type: boolean
      check_level:
        description: 'Health check depth'
        required: false
        default: 'basic'
        type: choice
        options:
          - basic
          - full
          - system
  schedule:
    # ë§¤ 6ì‹œê°„ë§ˆë‹¤ ì •ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '0 */6 * * *'

env:
  TZ: Asia/Seoul
  DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
  CHECK_LEVEL: ${{ github.event.inputs.check_level || 'basic' }}

jobs:
  health-check-optimized:
    name: ğŸ©º System Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python (Minimal)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Essential Dependencies
        run: |
          echo "ğŸ“¦ Installing essential dependencies for health check..."
          
          # í—¬ìŠ¤ì²´í¬ì— í•„ìš”í•œ ìµœì†Œ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜
          python -m pip install --upgrade pip --quiet
          pip install --quiet psutil requests
          
          echo "âœ… Essential dependencies installed"

      - name: ğŸ©º Core System Health Check
        id: health_check
        run: |
          echo "ğŸ©º Performing core system health check..."
          
          python -c "
          import psutil
          import sys
          import os
          from datetime import datetime
          
          print('ğŸ¥ Epic7 System Health Check')
          print(f'ğŸ•’ Check time: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')
          print('=' * 50)
          
          # 1. í”„ë¡œì„¸ìŠ¤ ê²€ì¦
          target_processes = [
              'monitor_bugs.py',
              'epic7_integrated_monitoring_system.py',
              'python'
          ]
          
          processes_found = []
          for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
              try:
                  if proc.info['cmdline']:
                      cmdline_str = ' '.join(proc.info['cmdline'])
                      for target in target_processes:
                          if target in cmdline_str and 'monitoring' in cmdline_str.lower():
                              processes_found.append({
                                  'pid': proc.info['pid'],
                                  'name': proc.info['name'],
                                  'cmdline': cmdline_str
                              })
                              break
              except (psutil.NoSuchProcess, psutil.AccessDenied):
                  continue
          
          if processes_found:
              print('âœ… HEALTHY: Active monitoring processes found:')
              for proc in processes_found:
                  print(f'   - PID {proc[\"pid\"]}: {proc[\"name\"]}')
              health_status = 'HEALTHY'
          else:
              print('âš ï¸ WARNING: No active monitoring processes found')
              print('   This may be normal if monitoring is scheduled-based')
              health_status = 'WARNING'
          
          # 2. ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì²´í¬
          print('\\nğŸ–¥ï¸ System Resources:')
          
          # ë©”ëª¨ë¦¬
          memory = psutil.virtual_memory()
          print(f'   ğŸ’¾ Memory: {memory.percent}% used ({memory.used//1024//1024}MB/{memory.total//1024//1024}MB)')
          
          # ë””ìŠ¤í¬
          disk = psutil.disk_usage('/')
          print(f'   ğŸ’¿ Disk: {disk.percent}% used ({disk.used//1024//1024//1024}GB/{disk.total//1024//1024//1024}GB)')
          
          # CPU
          cpu_percent = psutil.cpu_percent(interval=1)
          print(f'   ğŸ”¥ CPU: {cpu_percent}% usage')
          
          # 3. í•µì‹¬ ì„œë¹„ìŠ¤ ì—°ê²° ì²´í¬ë§Œ (Discord ì œì™¸)
          print('\\nğŸŒ Essential Network Connectivity:')
          
          import urllib.request
          import socket
          
          # ëª¨ë‹ˆí„°ë§ì— í•„ìˆ˜ì ì¸ ì‚¬ì´íŠ¸ë§Œ ì²´í¬
          essential_urls = [
              'https://page.onstove.com',
              'https://cafe.naver.com'
          ]
          
          network_ok = True
          for url in essential_urls:
              try:
                  urllib.request.urlopen(url, timeout=5)
                  print(f'   âœ… {url} - OK')
              except:
                  print(f'   âŒ {url} - Failed')
                  network_ok = False
          
          # 4. íŒŒì¼ ì‹œìŠ¤í…œ ì²´í¬
          print('\\nğŸ“ File System:')
          
          important_files = [
              'monitor_bugs.py',
              'config.py',
              'crawler.py',
              'classifier.py',
              'notifier.py'
          ]
          
          files_ok = True
          missing_files = []
          for file in important_files:
              if os.path.exists(file):
                  size = os.path.getsize(file)
                  print(f'   âœ… {file} - {size} bytes')
              else:
                  print(f'   âŒ {file} - Missing')
                  missing_files.append(file)
                  files_ok = False
          
          # 5. ê°œì„ ëœ ìƒíƒœ ê²°ì • ë¡œì§
          critical_files = ['monitor_bugs.py', 'config.py']
          critical_missing = any(f in missing_files for f in critical_files)
          
          if health_status == 'HEALTHY' and network_ok and not critical_missing:
              final_status = 'HEALTHY'
              exit_code = 0
          elif health_status == 'WARNING' and network_ok and not critical_missing:
              final_status = 'WARNING'
              exit_code = 0
          elif not critical_missing and (network_ok or health_status in ['HEALTHY', 'WARNING']):
              # ë„¤íŠ¸ì›Œí¬ ì¼ì‹œ ì¥ì• ëŠ” WARNINGìœ¼ë¡œ ì²˜ë¦¬
              final_status = 'WARNING'
              exit_code = 0
              print('   âš ï¸ Minor network issues detected, but core system is functional')
          else:
              final_status = 'CRITICAL'
              exit_code = 1
          
          print(f'\\nğŸ¥ Overall Status: {final_status}')
          
          # ìƒíƒœ ìƒì„¸ ì •ë³´
          if final_status == 'HEALTHY':
              print('   âœ… All systems operational')
          elif final_status == 'WARNING':
              print('   âš ï¸ Minor issues detected, monitoring continues')
          else:
              print('   ğŸš¨ Critical issues require immediate attention')
          
          # í™˜ê²½ ë³€ìˆ˜ë¡œ ìƒíƒœ ì „ë‹¬
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'health_status={final_status}\\n')
              f.write(f'memory_usage={memory.percent}\\n')
              f.write(f'disk_usage={disk.percent}\\n')
              f.write(f'cpu_usage={cpu_percent}\\n')
              f.write(f'processes_found={len(processes_found)}\\n')
              f.write(f'missing_files={len(missing_files)}\\n')
              f.write(f'network_issues={not network_ok}\\n')
          
          sys.exit(exit_code)
          "

      - name: ğŸ” Extended Health Check
        if: env.CHECK_LEVEL == 'full' || env.CHECK_LEVEL == 'system'
        run: |
          echo "ğŸ” Performing extended health check..."
          
          # ë°ì´í„° íŒŒì¼ ì²´í¬
          echo "ğŸ“Š Data Files Check:"
          data_files=("sentiment_data.json" "crawled_links.json" "monitoring_stats.json")
          
          for file in "${data_files[@]}"; do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file")
              modified=$(stat -c%y "$file")
              echo "âœ… $file - ${size} bytes, modified: ${modified}"
            else
              echo "âš ï¸ $file - Not found"
            fi
          done
          
          # ë¡œê·¸ íŒŒì¼ ì²´í¬
          echo "ğŸ“‹ Log Files Check:"
          find . -name "*.log" -mtime -1 | head -5 | while read log; do
            if [ -f "$log" ]; then
              echo "âœ… $log - $(wc -l < "$log") lines"
            fi
          done

      - name: ğŸŒ Optional External Services Check
        if: env.CHECK_LEVEL == 'full' || env.CHECK_LEVEL == 'system'
        run: |
          echo "ğŸŒ Checking optional external services..."
          
          # ì„ íƒì  ì„œë¹„ìŠ¤ ì²´í¬ (ì‹¤íŒ¨í•´ë„ CRITICAL ì•„ë‹˜)
          optional_services=(
            "https://google.com"
            "https://github.com"
            "https://api.github.com"
          )
          
          for service in "${optional_services[@]}"; do
            if curl -s --head "$service" --max-time 5 | head -n 1 | grep -q "200\|301\|302"; then
              echo "âœ… $service - OK"
            else
              echo "âš ï¸ $service - Not accessible (non-critical)"
            fi
          done

      - name: ğŸ”” Discord Webhook Validation
        if: env.CHECK_LEVEL == 'full'
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: |
          if [[ -n "$DISCORD_WEBHOOK_BUG" ]]; then
            echo "ğŸ”” Validating Discord webhook..."
            
            # ì‹¤ì œ ë©”ì‹œì§€ ëŒ€ì‹  webhook ìœ íš¨ì„±ë§Œ ì²´í¬
            if curl -s --head "$DISCORD_WEBHOOK_BUG" --max-time 5 | head -n 1 | grep -q "200\|400"; then
              echo "âœ… Discord webhook - Accessible"
            else
              echo "âš ï¸ Discord webhook - May have issues (non-critical)"
            fi
          else
            echo "âš ï¸ Discord webhook not configured"
          fi

      - name: ğŸ“Š System Diagnostics
        if: env.CHECK_LEVEL == 'system'
        run: |
          echo "ğŸ“Š System diagnostics..."
          
          # ì‹œìŠ¤í…œ ì •ë³´
          echo "ğŸ–¥ï¸ System Information:"
          uname -a
          
          # í”„ë¡œì„¸ìŠ¤ ëª©ë¡
          echo "âš™ï¸ Running Processes:"
          ps aux --sort=-%mem | head -10
          
          # ë„¤íŠ¸ì›Œí¬ ì—°ê²°
          echo "ğŸŒ Network Connections:"
          netstat -tuln | head -10

      - name: ğŸ¯ Health Check Success Notification
        if: success() && steps.health_check.outputs.health_status == 'HEALTHY'
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: |
          if [[ -n "$DISCORD_WEBHOOK_BUG" ]]; then
            echo "ğŸ“¬ Sending health check success notification..."
            
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"embeds\": [{
                     \"title\": \"âœ… Epic7 System Health Check - HEALTHY\",
                     \"description\": \"ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤.\",
                     \"color\": 5763719,
                     \"fields\": [
                       {
                         \"name\": \"ğŸ–¥ï¸ System Status\",
                         \"value\": \"Memory: ${{ steps.health_check.outputs.memory_usage }}%\\nDisk: ${{ steps.health_check.outputs.disk_usage }}%\\nCPU: ${{ steps.health_check.outputs.cpu_usage }}%\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"âš™ï¸ Processes\",
                         \"value\": \"Active: ${{ steps.health_check.outputs.processes_found }}\\nStatus: Normal\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ•’ Check Time\",
                         \"value\": \"$(date '+%Y-%m-%d %H:%M:%S %Z')\",
                         \"inline\": false
                       }
                     ],
                     \"footer\": {
                       \"text\": \"Epic7 Health Check v3.1 (Optimized)\"
                     }
                   }]
                 }" \
                 "$DISCORD_WEBHOOK_BUG"
            
            echo "âœ… Success notification sent"
          else
            echo "âš ï¸ Discord webhook not configured"
          fi

      - name: âš ï¸ Health Check Warning Notification
        if: success() && steps.health_check.outputs.health_status == 'WARNING'
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: |
          if [[ -n "$DISCORD_WEBHOOK_BUG" ]]; then
            echo "ğŸ“¬ Sending health check warning notification..."
            
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"embeds\": [{
                     \"title\": \"âš ï¸ Epic7 System Health Check - WARNING\",
                     \"description\": \"ì‹œìŠ¤í…œì´ ì‘ë™í•˜ê³  ìˆì§€ë§Œ ì¼ë¶€ ëª¨ë‹ˆí„°ë§ í”„ë¡œì„¸ìŠ¤ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\",
                     \"color\": 16776960,
                     \"fields\": [
                       {
                         \"name\": \"ğŸ–¥ï¸ System Status\",
                         \"value\": \"Memory: ${{ steps.health_check.outputs.memory_usage }}%\\nDisk: ${{ steps.health_check.outputs.disk_usage }}%\\nCPU: ${{ steps.health_check.outputs.cpu_usage }}%\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"âš™ï¸ Processes\",
                         \"value\": \"Active: ${{ steps.health_check.outputs.processes_found }}\\nStatus: Warning\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ”— Details\",
                         \"value\": \"[ì›Œí¬í”Œë¡œìš° ë¡œê·¸ í™•ì¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                         \"inline\": false
                       }
                     ],
                     \"footer\": {
                       \"text\": \"Epic7 Health Check v3.1 (Optimized)\"
                     }
                   }]
                 }" \
                 "$DISCORD_WEBHOOK_BUG"
            
            echo "âœ… Warning notification sent"
          else
            echo "âš ï¸ Discord webhook not configured"
          fi

      - name: ğŸš¨ Health Check Critical Notification
        if: failure()
        env:
          DISCORD_WEBHOOK_BUG: ${{ secrets.DISCORD_WEBHOOK_BUG }}
        run: |
          if [[ -n "$DISCORD_WEBHOOK_BUG" ]]; then
            echo "ğŸ“¬ Sending health check critical notification..."
            
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"content\": \"@here\",
                   \"embeds\": [{
                     \"title\": \"ğŸš¨ Epic7 System Health Check - CRITICAL\",
                     \"description\": \"**ì‹œìŠ¤í…œì— ì‹¬ê°í•œ ë¬¸ì œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!** ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\",
                     \"color\": 15548997,
                     \"fields\": [
                       {
                         \"name\": \"ğŸ–¥ï¸ System Status\",
                         \"value\": \"Memory: ${{ steps.health_check.outputs.memory_usage || 'N/A' }}%\\nDisk: ${{ steps.health_check.outputs.disk_usage || 'N/A' }}%\\nCPU: ${{ steps.health_check.outputs.cpu_usage || 'N/A' }}%\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"âš™ï¸ Processes\",
                         \"value\": \"Active: ${{ steps.health_check.outputs.processes_found || '0' }}\\nStatus: Critical\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ”— Action Required\",
                         \"value\": \"[ì›Œí¬í”Œë¡œìš° ë¡œê·¸ í™•ì¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                         \"inline\": false
                       }
                     ],
                     \"footer\": {
                       \"text\": \"Epic7 Health Check v3.1 (Optimized) - URGENT\"
                     }
                   }]
                 }" \
                 "$DISCORD_WEBHOOK_BUG"
            
            echo "âœ… Critical notification sent"
          else
            echo "âš ï¸ Discord webhook not configured"
          fi

      - name: ğŸ“Š Upload Health Check Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-report-${{ github.run_id }}
          path: |
            *.log
            health_check_*.json
          retention-days: 30

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up health check..."
          echo "âœ… Health check completed"
