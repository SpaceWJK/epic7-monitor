name: Epic Seven Monitor Health Check

on:
  schedule:
    - cron: "0 */6 * * *"  # 6ì‹œê°„ë§ˆë‹¤
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Chrome and ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # ChromeDriver ìˆ˜ë™ ì„¤ì¹˜
          CHROME_VERSION=$(google-chrome --version | cut -d' ' -f3 | cut -d'.' -f1)
          echo "Chrome ë²„ì „: $CHROME_VERSION"
          
          CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
          echo "ChromeDriver ë²„ì „: $CHROMEDRIVER_VERSION"
          
          wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
          sudo unzip /tmp/chromedriver.zip -d /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run health check
        run: |
          echo "ðŸ¥ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì‹œìž‘"
          
          # Python ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
          python -c "
          try:
              from crawler import crawl_arca_sites
              from classifier import is_bug_post  
              from notifier import send_bug_alert
              print('âœ… ëª¨ë“  ëª¨ë“ˆ import ì„±ê³µ')
          except Exception as e:
              print(f'âŒ ëª¨ë“ˆ import ì‹¤íŒ¨: {e}')
              exit(1)
          "
          
          # ìŠ¤í† ë¸Œ ì ‘ì† í…ŒìŠ¤íŠ¸
          python -c "
          import requests
          try:
              response = requests.get('https://page.onstove.com/epicseven/kr/list/1012', timeout=10)
              if response.status_code == 200:
                  print('âœ… ìŠ¤í† ë¸Œ ì ‘ì† ê°€ëŠ¥')
              else:
                  print(f'âš ï¸ ìŠ¤í† ë¸Œ ì‘ë‹µ ì½”ë“œ: {response.status_code}')
          except Exception as e:
              print(f'âŒ ìŠ¤í† ë¸Œ ì ‘ì† ì‹¤íŒ¨: {e}')
          "
          
          # ChromeDriver ê²½ë¡œ í™•ì¸
          echo "ðŸ” ChromeDriver ê²½ë¡œ í™•ì¸:"
          which chromedriver || echo "ì‹œìŠ¤í…œ PATHì— chromedriver ì—†ìŒ"
          ls -la /usr/local/bin/chromedriver || echo "/usr/local/bin/chromedriver ì—†ìŒ"
          
          # Selenium ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ (ê°œì„ ëœ ë²„ì „)
          python -c "
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.chrome.service import Service
          import os
          
          try:
              options = Options()
              options.add_argument('--headless')
              options.add_argument('--no-sandbox')
              options.add_argument('--disable-dev-shm-usage')
              
              driver = None
              
              # ë°©ë²• 1: ì‹œìŠ¤í…œ ChromeDriver ì‚¬ìš©
              try:
                  driver = webdriver.Chrome(options=options)
                  print('âœ… Selenium ë“œë¼ì´ë²„ ì •ìƒ ìž‘ë™ (ì‹œìŠ¤í…œ ê²½ë¡œ)')
              except Exception as e1:
                  print(f'âš ï¸ ì‹œìŠ¤í…œ ChromeDriver ì‹¤íŒ¨: {e1}')
                  
                  # ë°©ë²• 2: ìˆ˜ë™ ê²½ë¡œ ì‹œë„
                  paths = ['/usr/local/bin/chromedriver', '/usr/bin/chromedriver']
                  for path in paths:
                      if os.path.exists(path):
                          try:
                              service = Service(path)
                              driver = webdriver.Chrome(service=service, options=options)
                              print(f'âœ… Selenium ë“œë¼ì´ë²„ ì •ìƒ ìž‘ë™ (ê²½ë¡œ: {path})')
                              break
                          except Exception as e2:
                              print(f'âš ï¸ ê²½ë¡œ {path} ì‹¤íŒ¨: {e2}')
                  
                  if not driver:
                      print('âŒ ëª¨ë“  ChromeDriver ì´ˆê¸°í™” ë°©ë²• ì‹¤íŒ¨')
                      exit(1)
              
              # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸
              driver.get('https://www.google.com')
              title = driver.title
              print(f'âœ… íŽ˜ì´ì§€ ë¡œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ: {title}')
              
          except Exception as e:
              print(f'âŒ Selenium ë“œë¼ì´ë²„ ì‹¤íŒ¨: {e}')
              exit(1)
          finally:
              if 'driver' in locals() and driver:
                  driver.quit()
          "
          
          echo "ðŸ¥ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ"

      - name: Check repository status
        run: |
          echo "ðŸ“Š ë¦¬í¬ì§€í† ë¦¬ ìƒíƒœ:"
          echo "- ë§ˆì§€ë§‰ ì»¤ë°‹: $(git log -1 --format='%h %s %cr')"
          if [[ -f crawled_links.json ]]; then
            echo "- ì €ìž¥ëœ ë§í¬ ìˆ˜: $(jq length crawled_links.json 2>/dev/null || echo 'íŒŒì¼ ì½ê¸° ì‹¤íŒ¨')"
          else
            echo "- crawled_links.json íŒŒì¼ ì—†ìŒ"
          fi

      - name: System resource check
        run: |
          echo "ðŸ’¾ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
          echo "- ë©”ëª¨ë¦¬: $(free -h | grep '^Mem:' | awk '{print $3"/"$2}')"
          echo "- ë””ìŠ¤í¬: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')"
          echo "- Chrome ë²„ì „: $(google-chrome --version 2>/dev/null || echo 'Chrome ë¯¸ì„¤ì¹˜')"
          echo "- Python ë²„ì „: $(python --version)"

      - name: Create health report
        if: always()
        run: |
          echo "ðŸŽ¯ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ - $(date '+%Y-%m-%d %H:%M:%S KST')" > health_report.txt
          echo "ì‹œìŠ¤í…œ ìƒíƒœ: ì •ìƒ" >> health_report.txt

      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_number }}
          path: health_report.txt
          retention-days: 7
